<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>דשבורד BI • פניות פתוחות</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#f7f8ff; --card:#fff; --ink:#1c2033; --muted:#70788a; --brand:#5b4bff;
    --ok:#e6fbef; --ok-ink:#0f7a4f; --warn:#fff4e5; --warn-ink:#8a5600; --err:#ffe9ea; --err-ink:#9b1c2e;
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Heebo,system-ui,Arial,sans-serif}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  h1{font-size:32px;margin:0 0 10px}
  .sub{color:var(--muted);margin-bottom:18px}
  .panel{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 10px 28px rgba(28,32,51,.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:14px;height:48px;padding:0 18px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:#efeefe;color:#2f2a78}
  .chip{height:44px;padding:0 14px;border-radius:12px;display:inline-flex;align-items:center;background:#f1f2f8;color:#333;min-width:120px}
  .file{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .status{margin-top:12px;border-radius:12px;padding:12px 14px;font-size:14px}
  .status.ok{background:var(--ok);color:var(--ok-ink)}
  .status.warn{background:var(--warn);color:var(--warn-ink)}
  .status.err{background:var(--err);color:var(--err-ink)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:16px}
  @media (max-width:720px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 10px 28px rgba(28,32,51,.06)}
  .kpi{font-size:40px;font-weight:800}
  .muted{color:var(--muted);font-size:14px}
  select{height:44px;border-radius:12px;border:1px solid #e5e7f2;background:#fff;padding:0 12px;min-width:220px}
  .hint{font-size:13px;color:var(--muted);margin-top:10px}
  .hr{height:1px;background:#eceff6;margin:16px 0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>דשבורד BI • פניות פתוחות</h1>
    <div class="sub">כל החישובים מתבססים על <b>“תאריך/שעת פתיחה”</b> בלבד (לא משתמשים ב־“שונה לאחרונה”).</div>

    <div class="panel" id="uipanel">
      <div class="row">
        <button class="btn" id="pickBtn">העלאת Excel</button>
        <div class="chip file" id="fileName">לא נבחר קובץ</div>
        <div class="chip" id="rowsChip">שורות 0</div>
        <button class="btn ghost" id="clearBtn">ניקוי</button>
        <input id="fileInput" type="file" accept=".xlsx,.xls" hidden>
      </div>

      <div class="status warn" id="statusLine" style="display:none"></div>

      <div class="hr"></div>

      <div class="row">
        <label>עמודת תאריכים (אם הזיהוי האוטומטי לא זיהה)</label>
        <select id="dateSelect"></select>
      </div>
      <div class="hint">טיפ: אם יש בקובץ כמה גיליונות – נטען את הראשון. אפשר לשנות בגיליון לפני שמירה.</div>
    </div>

    <div class="grid" id="kpis" style="display:none">
      <div class="card">
        <div class="muted">סה״כ פניות (כל השורות בקובץ)</div>
        <div class="kpi" id="kpiTotal">0</div>
      </div>
      <div class="card">
        <div class="muted">פניות — יום אחרון (לפי תאריך פתיחה)</div>
        <div class="kpi" id="kpiToday">0</div>
        <div class="muted" id="kpiTodayDate"></div>
      </div>
      <div class="card">
        <div class="muted">פניות — היום הקודם</div>
        <div class="kpi" id="kpiPrev">0</div>
        <div class="muted" id="kpiPrevDate"></div>
      </div>
      <div class="card">
        <div class="muted">שינוי יומי</div>
        <div class="kpi" id="kpiDelta">0</div>
        <div class="muted" id="kpiDeltaPct">— אחוזים</div>
      </div>
    </div>

    <div class="card" id="diagCard" style="display:none;margin-top:16px">
      <div class="muted">דיאגנוסטיקה תאריכים</div>
      <div id="diagText" style="font-weight:600;margin-top:6px"></div>
    </div>

  </div>

<script>
/* ============ קבועים ועזרים ============ */
const tz = 'Asia/Jerusalem';
const onlyDate = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());

/* תרגום תאריך מכל פורמט: Date, טקסט, או Serial של Excel */
function parseHebDate(val){
  if (val == null || val === '') return null;

  // כבר Date
  if (val instanceof Date && !isNaN(val)) return val;

  // Serial מספרי של Excel
  if (typeof val === 'number'){
    // Excel serial -> milliseconds
    const ms = (val - 25569) * 86400000; // 25569 = 1970-01-01
    const d = new Date(ms);
    return isNaN(d) ? null : d;
  }

  // טקסט – הסרת סימני RTL נסתרים
  const s = String(val).trim().replace(/\u200f|\u200e/g,'');
  // dd/mm/yyyy[ hh:mm[:ss]] או dd.mm.yyyy / dd-mm-yyyy
  let m = s.match(/^(\d{1,2})[.\/\-](\d{1,2})[.\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m){
    const dd=+m[1], mm=+m[2]-1, yyyy = (+m[3] < 100 ? 2000+ +m[3] : +m[3]);
    const hh=+(m[4]??'0'), mi=+(m[5]??'0'), ss=+(m[6]??'0');
    return new Date(yyyy,mm,dd,hh,mi,ss);
  }
  // ISO ודומיו
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

/* ============ DOM ============ */
const fileInput  = document.getElementById('fileInput');
const pickBtn    = document.getElementById('pickBtn');
const clearBtn   = document.getElementById('clearBtn');
const fileNameEl = document.getElementById('fileName');
const rowsChip   = document.getElementById('rowsChip');
const statusLine = document.getElementById('statusLine');
const dateSelect = document.getElementById('dateSelect');

const kpisWrap   = document.getElementById('kpis');
const kpiTotal   = document.getElementById('kpiTotal');
const kpiToday   = document.getElementById('kpiToday');
const kpiPrev    = document.getElementById('kpiPrev');
const kpiTodayDate = document.getElementById('kpiTodayDate');
const kpiPrevDate  = document.getElementById('kpiPrevDate');
const kpiDelta     = document.getElementById('kpiDelta');
const kpiDeltaPct  = document.getElementById('kpiDeltaPct');

const diagCard  = document.getElementById('diagCard');
const diagText  = document.getElementById('diagText');

/* ============ מצב נתונים ============ */
let RAW = [];         // שורות מקוריות (אובייקטים)
let COLS = [];        // שמות עמודות
let COL_DATE = null;  // שם העמודה שנבחרה לתאריך/שעת פתיחה

/* ============ UI ============ */
pickBtn.onclick = ()=> fileInput.click();
clearBtn.onclick = ()=> {
  RAW=[]; COLS=[]; COL_DATE=null;
  fileInput.value='';
  fileNameEl.textContent='לא נבחר קובץ';
  rowsChip.textContent='שורות 0';
  dateSelect.innerHTML='';
  kpisWrap.style.display='none';
  statusLine.style.display='none';
  diagCard.style.display='none';
};

/* מילוי רשימת עמודות */
function fillColumns(cols){
  dateSelect.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'זיהוי אוטומטי (מומלץ)';
  dateSelect.appendChild(opt0);
  cols.forEach(c=>{
    const opt = document.createElement('option');
    opt.value=c; opt.textContent=c;
    dateSelect.appendChild(opt);
  });
}

/* בחירת עמודת תאריך ידנית */
dateSelect.onchange = ()=>{
  const v = dateSelect.value || null;
  COL_DATE = v;  // null => אוטומטי
  if (RAW.length) buildDashboard();
};

/* ============ קריאת הקובץ ============ */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  fileNameEl.textContent = f.name;

  try{
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, {type:'array', cellDates:false, cellNF:false, cellText:false});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:true}); // raw=true כדי לשמור Serial
    RAW = json;
    COLS = Object.keys(json[0] || {});
    rowsChip.textContent = `שורות ${json.length.toLocaleString('he-IL')}`;

    // זיהוי אוטומטי לעמודת תאריך אם קיימת
    const auto = COLS.find(c=>/תאריך.?\/?שעת.? פתיחה|תאריך.? פתיחה/i.test(c)) ||
                 COLS.find(c=>/פתיחה/i.test(c));
    COL_DATE = auto || null;

    fillColumns(COLS);
    if (COL_DATE){
      // מסמן ב־select אם זוהה
      [...dateSelect.options].forEach(o=>{ if (o.value===COL_DATE) o.selected=true; });
      setStatus('ok', `הקובץ נטען. עמודת תאריך זוהתה: “${COL_DATE}”.`);
    } else {
      setStatus('warn', 'הקובץ נטען. לא זוהתה עמודת תאריך – בחרי מהרשימה.');
    }
    buildDashboard();
  }catch(err){
    console.error(err);
    setStatus('err','שגיאה בקריאת הקובץ. נסי לשמור כ-Excel רגיל (Workbook), להסיר נוסחאות/מיזוגים ולוודא שהכותרות בשורה הראשונה.');
  }
});

/* ============ סטטוס ============ */
function setStatus(kind, msg){
  statusLine.className = 'status ' + kind;
  statusLine.style.display='';
  statusLine.textContent = msg;
}

/* ============ חישובי KPI ובניית דשבורד ============ */
function buildDashboard(){
  if (!RAW.length){ kpisWrap.style.display='none'; return; }

  const dateKey = COL_DATE || guessDateKey(COLS);
  if (!dateKey){ setStatus('warn','בחרי עמודת תאריך / שעת פתיחה.'); kpisWrap.style.display='none'; return; }

  // הוספת _openDate + דיאגנוסטיקה
  let ok=0, empty=0, bad=0, serial=0;
  const rows = RAW.map(r=>{
    const raw = r[dateKey];
    const d = parseHebDate(raw);
    if (raw == null || raw === '') empty++;
    else if (typeof raw === 'number'){ if (d) serial++; else bad++; }
    else if (d) ok++; else bad++;
    return {...r, _openDate: d};
  });

  diagText.textContent = `זוהו תאריכים: ${ok.toLocaleString('he-IL')} • ריקים: ${empty.toLocaleString('he-IL')} • לא קריאים: ${bad.toLocaleString('he-IL')} • serial: ${serial.toLocaleString('he-IL')}`;
  diagCard.style.display='';

  // KPI סה"כ שורות
  kpiTotal.textContent = RAW.length.toLocaleString('he-IL');

  // היום (לפי Asia/Jerusalem)
  const now = new Date();
  const today = onlyDate(now);
  const prev  = new Date(today); prev.setDate(prev.getDate()-1);

  const todayCount = rows.filter(r => r._openDate && onlyDate(r._openDate).getTime() === today.getTime()).length;
  const prevCount  = rows.filter(r => r._openDate && onlyDate(r._openDate).getTime() === prev.getTime()).length;

  kpiToday.textContent = todayCount.toLocaleString('he-IL');
  kpiPrev.textContent  = prevCount.toLocaleString('he-IL');

  const fmt = (d)=> d.toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric', timeZone: 'Asia/Jerusalem'});
  kpiTodayDate.textContent = `נכון ל־${fmt(today)}`;
  kpiPrevDate.textContent  = `נכון ל־${fmt(prev)}`;

  const delta = todayCount - prevCount;
  kpiDelta.textContent = (delta>=0? '':'') + delta.toLocaleString('he-IL');
  const pct = prevCount ? (delta/prevCount*100) : 0;
  kpiDeltaPct.textContent = `${pct.toFixed(1)}% :אחוזים`;

  kpisWrap.style.display='';
  setStatus('ok', `הקובץ נטען בהצלחה • עמודת תאריך: “${dateKey}”`);
}

/* ניחוש עמודת תאריך במקרה שלא נבחרה ידנית */
function guessDateKey(cols){
  return cols.find(c=>/תאריך.?\/?שעת.? פתיחה|תאריך.? פתיחה/i.test(c)) ||
         cols.find(c=>/date|opened/i.test(c));
}
</script>
</body>
</html>
