<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת BI — העלאת קובץ</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ink: { 50:'#f8fafc', 100:'#eef2f6', 200:'#e2e8f0', 800:'#1f2937', 900:'#0b1220' },
            luxe: { 100:'#f3f4f6', 200:'#e5e7eb', 300:'#d1d5db', 700:'#374151', 900:'#111827' },
            brand: { 400:'#8b5cf6', 500:'#7c3aed', 600:'#6d28d9' },
            gold: { 400:'#f6c453', 500:'#f59e0b' }
          },
          boxShadow: {
            luxe: '0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)',
          },
          backdropBlur: { xs: '2px' },
          borderRadius: { '3xl': '1.5rem' }
        }
      }
    }
  </script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ברק יוקרתי דק לכפתורים/כרטיסים */
    .sheen {
      position: relative;
      overflow: hidden;
    }
    .sheen::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 300%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.15) 50%, transparent 65%);
      transform: rotate(15deg);
      animation: sheen 4s infinite;
    }
    @keyframes sheen {
      0%   { transform: translateX(-30%) translateY(-30%) rotate(15deg); }
      60%  { transform: translateX(60%) translateY(60%) rotate(15deg); }
      100% { transform: translateX(60%) translateY(60%) rotate(15deg); }
    }
    /* סלוט של גרירת קובץ */
    .dropzone.dragover { border-color: #8b5cf6; background: rgba(139,92,246,.06); }
</style>
    <style id="insightsSelectFix">
  #insCitySel, #insScope, #insValue {
    background-color:#0b1220 !important;
    color:#ffffff !important;
    border-color: rgba(255,255,255,.2) !important;
  }
  #insCitySel option, #insScope option, #insValue option {
    background-color:#0b1220 !important;
    color:#ffffff !important;
  }
</style>
</head>

<body class="bg-gradient-to-b from-ink-900 via-[#0d1020] to-[#0a0f1c] text-white min-h-screen">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-6">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-brand-600 to-gold-500 flex items-center justify-center shadow-luxe sheen">
        <span class="font-black text-xl">BI</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">מערכת BI — קליטה חכמה של קבצי Excel</h1>
        <p class="text-sm text-ink-200/80">שלב 1: העלאת קובץ XLSX, ספירת שורות ועדכון סטטוס</p>
      </div>
    </div>
  </header>

  <!-- Card -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <section class="rounded-3xl sheen shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
      <!-- Status Row -->
      <div id="statusBar" class="flex flex-wrap items-center gap-3 rounded-2xl border border-white/10 bg-white/5 p-3">
        <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-ink-900/70 border border-white/10">
          <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4 text-ink-200">
            <path d="M12 2v4m0 12v4M4 12H2m20 0h-2M5 5l-2-2m16 16 2 2M19 5l2-2M5 19l-2 2" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </span>
        <div class="text-sm">
          <div class="font-semibold" id="statusTitle">מוכן לקליטת קובץ</div>
          <div class="text-ink-200/80" id="statusSub">בחרי קובץ ‎.xlsx או גררי לכרטיס</div>
        </div>
        <div class="ms-auto">
          <span id="chipRows" class="hidden text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 font-semibold shadow">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Uploader -->
      <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- File input -->
        <label class="block">
          <span class="text-sm text-ink-200/90 font-medium">בחרי קובץ XLSX</span>
          <input id="fileInput" type="file" accept=".xlsx,.xlsb,.xlsm,.xls"
                 class="mt-2 w-full file:me-4 file:px-4 file:py-2 file:rounded-xl file:border-0 file:bg-gradient-to-r file:from-brand-600 file:to-gold-500 file:text-white file:font-semibold file:cursor-pointer file:shadow hover:file:opacity-95
                        bg-white/5 border border-white/10 rounded-2xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/40"/>
        </label>

        <!-- Drag & Drop -->
        <div id="dropzone"
             class="dropzone rounded-2xl border-2 border-dashed border-white/15 bg-white/5 p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-brand-500/50 transition">
          <svg viewBox="0 0 24 24" fill="none" class="h-8 w-8 text-ink-200/80">
            <path d="M7 16a5 5 0 0 1 0-10 6 6 0 0 1 11 2 4 4 0 0 1 1 7" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 12v6m0-6 2 2m-2-2-2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <p class="mt-3 text-sm text-ink-200/85">
            גררי לכאן קובץ ‎.xlsx או הקליקי לבחירה
          </p>
        </div>
      </div>

      <!-- Result line -->
      <div id="resultLine" class="mt-6 hidden rounded-xl bg-ink-900/60 border border-white/10 p-4 text-sm">
        <div class="flex items-center gap-2">
          <svg id="resultIcon" viewBox="0 0 24 24" fill="none" class="h-5 w-5 text-emerald-400">
            <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div id="resultTitle" class="font-semibold">הקובץ נקלט בהצלחה</div>
            <div id="resultSub" class="text-ink-200/80">שם קובץ • שורות • תאריך</div>
          </div>
          <span id="rowsPill" class="ms-auto hidden px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/40">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Tiny footer -->
      <div class="mt-8 text-[11px] text-ink-200/60">
        טיפ: בשלב הבא נוסיף תצוגה מקדימה וטיפול בתאריכים/שעות וסכימות SLA.
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    const statusBar   = $('statusBar');
    const statusTitle = $('statusTitle');
    const statusSub   = $('statusSub');
    const chipRows    = $('chipRows');
    const resultLine  = $('resultLine');
    const resultTitle = $('resultTitle');
    const resultSub   = $('resultSub');
    const rowsPill    = $('rowsPill');
    const resultIcon  = $('resultIcon');

    function setLoadingState(isLoading) {
      if (isLoading) {
        statusTitle.textContent = 'טוען קובץ...';
        statusSub.textContent   = 'מבצע פענוח XLSX בדפדפן';
        statusBar.classList.add('animate-pulse');
      } else {
        statusBar.classList.remove('animate-pulse');
      }
    }

    function humanNumber(n) {
      return n.toLocaleString('he-IL');
    }

    function updateSuccessUI(filename, rows) {
      statusTitle.textContent = 'קובץ נטען';
      statusSub.textContent   = `${filename} • ${humanNumber(rows)} שורות`;
      chipRows.textContent    = `${humanNumber(rows)} שורות`;
      chipRows.classList.remove('hidden');

      resultTitle.textContent = 'הקובץ נקלט בהצלחה';
      resultSub.textContent   = `${filename} • ${humanNumber(rows)} שורות • ${new Date().toLocaleString('he-IL')}`;
      rowsPill.textContent    = `${humanNumber(rows)} שורות`;
      rowsPill.classList.remove('hidden');
      // וי ירוק
      resultIcon.innerHTML    = `<path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
      resultIcon.classList.remove('text-amber-400','text-rose-400');
      resultIcon.classList.add('text-emerald-400');

      resultLine.classList.remove('hidden');
    }

    function updateErrorUI(message) {
      statusTitle.textContent = 'שגיאה בקליטת הקובץ';
      statusSub.textContent   = message || 'בדקי שהקובץ הוא ‎.xlsx תקין';
      chipRows.classList.add('hidden');

      resultTitle.textContent = 'לא נקלט';
      resultSub.textContent   = message || 'הקובץ לא זוהה כ־XLSX או שאין בו נתונים';
      // איקס אדום
      resultIcon.innerHTML    = `<path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      resultIcon.classList.remove('text-emerald-400','text-amber-400');
      resultIcon.classList.add('text-rose-400');

      rowsPill.classList.add('hidden');
      resultLine.classList.remove('hidden');
    }

    // ===== Core XLSX parse =====
    async function handleFile(file) {
      if (!file) return;
      setLoadingState(true);

      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        const first = wb.SheetNames?.[0];
        if (!first) {
          updateErrorUI('לא נמצאו גיליונות בקובץ.');
          setLoadingState(false);
          return;
        }

        // ל־JSON (Header-row auto)
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

        const rows = json.length;
        if (rows === 0) {
          updateErrorUI('הקובץ ריק או שמות העמודות לא זוהו.');
        } else {
          updateSuccessUI(file.name, rows);
        }
      } catch (err) {
        console.error(err);
        updateErrorUI('שגיאה בקריאת הקובץ. נסי לשמור מחדש כ־XLSX ולנסות שוב.');
      } finally {
        setLoadingState(false);
      }
    }

    // ===== Inputs & DragDrop =====
    const fileInput = $('fileInput');
    const dropzone  = $('dropzone');

    fileInput.addEventListener('change', (e) => handleFile(e.target.files?.[0]));

    // הפיכת ה־div ללחיץ לבחירת קובץ
    dropzone.addEventListener('click', () => fileInput.click());

    ;['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      })
    );
    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });
  </script>
  <!-- === STEP 2: KPIs + Department Tabs (Asia/Jerusalem) === -->
<script>
(() => {
  const TZ = 'Asia/Jerusalem';
  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה'];
  const DEPT_COL = 'מחלקה מטפלת';
  const OPEN_DATE_COL_KEYS = ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'];

  // ---------- DOM: insert KPIs + tabs block ----------
  const main = document.querySelector('main') || document.body;
  const blockHTML = `
    <section id="biStep2" class="max-w-6xl mx-auto px-4 mt-6">
      <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 2</span>
          <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">TZ: Asia/Jerusalem</span>
        </div>

        <!-- Tabs (departments) -->
        <div>
          <div class="text-sm text-ink-200/80 mb-2">טאבים לפי מחלקה מטפלת</div>
          <div id="deptTabs" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- KPI row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" id="kpiRow">
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">סה״כ פניות פתוחות</div>
            <div id="kpiOpenTotal" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו היום</div>
            <div id="kpiOpenedToday" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו אתמול</div>
            <div id="kpiOpenedYesterday" class="text-3xl font-bold mt-1">—</div>
          </div>
        </div>

        <div class="mt-6 text-[11px] text-ink-200/60">
          תאריכים מעובדים לפי אזור זמן ישראל ומנורמלים לתאריך בלבד (dd/mm/yyyy) עבור החישובים של היום/אתמול.
        </div>
      </div>
    </section>
  `;
  main.insertAdjacentHTML('beforeend', blockHTML);

  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const kpiOpenTotal       = $('kpiOpenTotal');
  const kpiOpenedToday     = $('kpiOpenedToday');
  const kpiOpenedYesterday = $('kpiOpenedYesterday');
  const deptTabs           = $('deptTabs');

  function toPartsYMDInTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y: +map.year, m: +map.month, d: +map.day };
  }
  function ymdKey(ymd) { return `${ymd.y}-${String(ymd.m).padStart(2,'0')}-${String(ymd.d).padStart(2,'0')}`; }

  function todayYMD() { return toPartsYMDInTZ(new Date()); }
  function yesterdayYMD() {
    // בונים תאריך מקומי של היום ב־TZ ואז מחסרים יום אחד
    const t = todayYMD();
    const asUTC = new Date(Date.UTC(t.y, t.m - 1, t.d)); // חצות מקומי בקירוב
    const y = new Date(asUTC.getTime() - 24*60*60*1000);
    return toPartsYMDInTZ(y);
  }

  function normalizeDateOnly(cellVal) {
    // מקבל מחרוזת/מספר/Date מתוך העמודה "תאריך/שעת פתיחה" ומחזיר מפתח תאריך (yyyy-mm-dd) לפי TZ
    if (cellVal == null || cellVal === '') return null;

    // אם זה מספר אקסל (serial)
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = cellVal * 24*60*60*1000;
      const d = new Date(excelEpoch.getTime() + ms);
      return ymdKey(toPartsYMDInTZ(d));
    }

    // אם זה מחרוזת תאריך/שעה — נותן ל־Date לפרש, ואז מנרמל לפי TZ
    const d = new Date(cellVal);
    if (!isNaN(d)) {
      return ymdKey(toPartsYMDInTZ(d));
    }

    // ניסיון לפורמט dd/mm/yyyy hh:mm
    const m = String(cellVal).match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m) {
      let [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
      if (yyyy.length === 2) yyyy = '20' + yyyy;
      const d2 = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:${SS || '00'}`);
      return ymdKey(toPartsYMDInTZ(d2));
    }
    return null;
  }

  function findCol(obj, keys) {
    for (const k of keys) if (k in obj) return k;
    // נסיון התאמה רכה בלי ניקוד/רווחים
    const norm = (s) => s.replace(/\s+/g,'').toLowerCase();
    const target = keys.map(norm);
    for (const k in obj) if (target.includes(norm(k))) return k;
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true; // אם אין סטטוס – נספר כפתוח
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function deptOf(row) {
    return row[DEPT_COL] ?? row['מחלקה'] ?? row['מחלקה מטפלת '] ?? 'לא מוגדר';
  }

  // ---------- Data store ----------
  let __dataset = [];        // כל השורות (JSON)
  let __departments = [];    // רשימת מחלקות
  let __activeDept = 'כללי'; // טאב נוכחי

  function renderTabs() {
    deptTabs.innerHTML = '';
    const all = ['כללי', ...__departments];
    for (const name of all) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = [
        'px-3 py-1.5 rounded-full border text-sm',
        (__activeDept === name)
          ? 'bg-gradient-to-r from-brand-600 to-gold-500 border-transparent font-semibold'
          : 'bg-white/5 border-white/10 hover:border-white/20'
      ].join(' ');
      btn.textContent = name;
      btn.addEventListener('click', () => {
        __activeDept = name;
        renderTabs();
        computeAndRenderKPIs();
      });
      deptTabs.appendChild(btn);
    }
  }

  function computeAndRenderKPIs() {
    const todayKey = ymdKey(todayYMD());
    const yestKey  = ymdKey(yesterdayYMD());

    // סינון לפי טאב (לא מסנן גלובלי, רק לתצוגה)
    const scoped = __activeDept === 'כללי'
      ? __dataset
      : __dataset.filter(r => String(deptOf(r)) === __activeDept);

    // תאריך פתיחה מקומי (תאריך בלבד)
    const dateKeyOf = (row) => {
      const col = findCol(row, OPEN_DATE_COL_KEYS);
      return col ? normalizeDateOnly(row[col]) : null;
    };

    const openRows = scoped.filter(isOpenRow);
    const openedToday = openRows.filter(r => dateKeyOf(r) === todayKey);
    const openedYesterday = openRows.filter(r => dateKeyOf(r) === yestKey);

    kpiOpenTotal.textContent       = openRows.length.toLocaleString('he-IL');
    kpiOpenedToday.textContent     = openedToday.length.toLocaleString('he-IL');
    kpiOpenedYesterday.textContent = openedYesterday.length.toLocaleString('he-IL');
  }

  // ---------- Hook into existing upload flow without modifying it ----------
  // נשמור את הקובץ האחרון כדי שנוכל לנתח מחדש (לא מתערבים בפונקציות הקיימות)
  window.__lastFile = null;
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) window.__lastFile = e.target.files[0];
    });
  }
  if (dropzone) {
    dropzone.addEventListener('drop', (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) window.__lastFile = f;
    });
  }

  // עוטפים את updateSuccessUI כדי להריץ עיבוד אנליטי לאחר שהקובץ נקלט בהצלחה
  if (typeof window.updateSuccessUI === 'function') {
    const __origUpdateSuccessUI = window.updateSuccessUI;
    window.updateSuccessUI = async function(filename, rows) {
      __origUpdateSuccessUI.apply(this, arguments);
      try {
        if (!window.__lastFile) return; // ביטחון כפול
        const buf = await window.__lastFile.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const first = wb.SheetNames && wb.SheetNames[0];
        if (!first) return;
        const sheet = wb.Sheets[first];
        const json  = XLSX.utils.sheet_to_json(sheet, { defval: null });

        __dataset = json;

        // מחלקות לטאבים
        const depts = new Set();
        for (const r of __dataset) depts.add(String(deptOf(r)));
        __departments = Array.from(depts).filter(x => x && x !== 'undefined');
        renderTabs();
        computeAndRenderKPIs();
      } catch (e) {
        console.error('BI step2 processing error:', e);
      }
    };
  }
})();
        </script>
  <!-- === STEP 3 (REBUILT): Open tickets lists by City & "יחידת דואר: שם" (100+) === -->
<section id="biStep3Lists" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 3 (רשימות)</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">מציג רק 50+ פניות</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- By City -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי עיר (50+)</div>
        <div id="listByCity" class="divide-y divide-white/10"></div>
        <div id="msgCity" class="mt-3 text-xs text-ink-200/60"></div>
      </div>
      <!-- By Unit -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי "יחידת דואר: שם" (50+)</div>
        <div id="listByUnit" class="divide-y divide-white/10"></div>
        <div id="msgUnit" class="mt-3 text-xs text-ink-200/60"></div>
      </div>
    </div>
  </div>
</section>

<script>
(() => {
  const MIN_COUNT =50;

  // -------- Normalization helpers (עמודות בעברית לפעמים עם ניקוד/רווחים/נקודתיים) --------
  const HEB_DIACRITICS = /[\u0591-\u05C7]/g; // ניקוד
  function normHeader(s) {
    return String(s)
      .replace(HEB_DIACRITICS, '')          // בלי ניקוד
      .replace(/[·•:;|/_\-()\[\]{}]/g,'')   // בלי תווים מפרידים
      .replace(/\s+/g,'')                   // בלי רווחים
      .toLowerCase();
  }
  // בודק אם שם עמודה מכיל את כל מילות המפתח לאחר נירמול
  function headerIncludesAll(colName, keywords) {
    const n = normHeader(colName);
    return keywords.every(k => n.includes(normHeader(k)));
  }

  // התאמות גמישות לשמות עמודות:
  // עיר/יישוב
  const CITY_EXACT = ['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'];
  const CITY_KEYWORDS = [['עיר'], ['יישוב']]; // מספיק שאחד הסטים יתקיים
  // יחידה
  const UNIT_EXACT = ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'];
  const UNIT_KEYWORDS = [['יחידת','דואר','שם'], ['שם','יחידה']];

  const OPEN_STATUS_COLS = ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];

  function findColumnFlexible(row0, exactList, keywordSets) {
    if (!row0) return null;
    const headers = Object.keys(row0);
    // 1) ניסיון התאמה מדויקת
    for (const h of headers) {
      if (exactList.includes(h)) return h;
      // התאמה מדויקת גם אחרי נירמול בסיסי
      const hNorm = normHeader(h);
      for (const ex of exactList) {
        if (hNorm === normHeader(ex)) return h;
      }
    }
    // 2) ניסיון התאמה לפי מילות מפתח (כל הסט חייב להיות כלול)
    for (const h of headers) {
      if (keywordSets.some(kwSet => headerIncludesAll(h, kwSet))) {
        return h;
      }
    }
    return null;
  }

  function findCol(row, candidates) {
    if (!row) return null;
    for (const c of candidates) if (c in row) return c;
    // התאמה אחרי נירמול
    const target = candidates.map(normHeader);
    for (const k in row) if (target.includes(normHeader(k))) return k;
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COLS);
    if (!key) return true;
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function aggregateCounts(rows, which) {
    if (!rows?.length) return { col: null, items: [] };

    let col = null;
    if (which === 'city') {
      col = findColumnFlexible(rows[0], CITY_EXACT, CITY_KEYWORDS);
    } else if (which === 'unit') {
      col = findColumnFlexible(rows[0], UNIT_EXACT, UNIT_KEYWORDS);
    }
    if (!col) return { col: null, items: [] };

    const map = new Map();
    for (const r of rows) {
      if (!isOpenRow(r)) continue;
      const raw = r[col];
      const key = (raw == null) ? '' : String(raw).trim();
      if (!key) continue;
      map.set(key, (map.get(key) || 0) + 1);
    }

    const items = Array.from(map.entries())
      .filter(([, c]) => c >= MIN_COUNT)
      .sort((a,b) => b[1] - a[1])
      .map(([name,count]) => ({ name, count }));

    return { col, items };
  }

  function escapeHTML(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function renderList(containerId, items) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '';
    for (const it of items) {
      const row = document.createElement('div');
      row.className = 'py-2 flex items-center gap-3';
      row.innerHTML = `
        <span class="text-ink-50/90">${escapeHTML(it.name)}</span>
        <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10 font-semibold">
          ${it.count.toLocaleString('he-IL')} פניות
        </span>`;
      el.appendChild(row);
    }
  }

  async function ensureDatasetFromLastFile() {
    // אם אין __dataset אבל יש קובץ אחרון — נטעין אותו (לא פוגע בזרימה הקיימת)
    if (Array.isArray(window.__dataset) && window.__dataset.length) return;
    if (!window.__lastFile || !window.XLSX) return;
    try {
      const buf = await window.__lastFile.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const first = wb.SheetNames && wb.SheetNames[0];
      if (!first) return;
      const sheet = wb.Sheets[first];
      window.__dataset = XLSX.utils.sheet_to_json(sheet, { defval: null });
    } catch (e) {
      console.warn('ensureDatasetFromLastFile failed:', e);
    }
  }

  async function renderStep3() {
    await ensureDatasetFromLastFile();
    const rows = Array.isArray(window.__dataset) ? window.__dataset : [];

    const byCity = aggregateCounts(rows, 'city');
    const byUnit = aggregateCounts(rows, 'unit');

    renderList('listByCity', byCity.items);
    renderList('listByUnit', byUnit.items);

    const msgCity = document.getElementById('msgCity');
    const msgUnit = document.getElementById('msgUnit');

    msgCity.textContent = !byCity.col
      ? 'לא נמצאה עמודה מתאימה לעיר/יישוב (ניסינו גם וריאציות וניקוי ניקוד).'
      : (!byCity.items.length ? `אין ערים עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.` : '');

    msgUnit.textContent = !byUnit.col
      ? 'לא נמצאה עמודה מתאימה ל"יחידת דואר: שם" (כולל וריאציות כמו "שם יחידה").'
      : (!byUnit.items.length ? `אין יחידות עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.` : '');
  }

  // להתחבר לפלואו הקיים אחרי קליטת קובץ
  if (typeof window.updateSuccessUI === 'function') {
    const __prev = window.updateSuccessUI;
    window.updateSuccessUI = function() {
      __prev.apply(this, arguments);
      setTimeout(renderStep3, 0);
    };
  }

  // אם כבר נטען קובץ בעבר — נרנדר עכשיו
  if (Array.isArray(window.__dataset) && window.__dataset.length) {
    renderStep3();
  }
})();
</script>
  <!-- === STEP 4: Click-to-Table + Export to XLSX === -->
<script>
(() => {
  // ----- קבועים ועזרי תאריכים (תואם שלב 2) -----
  const TZ = 'Asia/Jerusalem';
  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];
  const OPEN_DATE_COL_KEYS   = ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'];

  function toPartsYMDInTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y: +map.year, m: +map.month, d: +map.day };
  }
  function ymdKey(ymd) { return `${ymd.y}-${String(ymd.m).padStart(2,'0')}-${String(ymd.d).padStart(2,'0')}`; }
  function todayKey(){ return ymdKey(toPartsYMDInTZ(new Date())); }
  function yesterdayKey(){
    const t = toPartsYMDInTZ(new Date());
    const asUTC = new Date(Date.UTC(t.y, t.m-1, t.d));
    return ymdKey(toPartsYMDInTZ(new Date(asUTC.getTime()-24*60*60*1000)));
  }

  // התאמות עמודות
  function findCol(obj, keys) {
    if (!obj) return null;
    for (const k of keys) if (k in obj) return k;
    const norm = (s) => String(s).replace(/\s+/g,'').toLowerCase();
    const target = keys.map(norm);
    for (const k in obj) if (target.includes(norm(k))) return k;
    return null;
  }

  // נירמול תאריך/שעה של "תאריך/שעת פתיחה" לתאריך בלבד לפי ישראל
  function normalizeDateOnly(cellVal) {
    if (cellVal == null || cellVal === '') return null;
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = cellVal * 24*60*60*1000;
      const d = new Date(excelEpoch.getTime() + ms);
      return ymdKey(toPartsYMDInTZ(d));
    }
    const d = new Date(cellVal);
    if (!isNaN(d)) return ymdKey(toPartsYMDInTZ(d));
    const m = String(cellVal).match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m) {
      let [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
      if (yyyy.length === 2) yyyy = '20' + yyyy;
      const d2 = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:${SS || '00'}`);
      return ymdKey(toPartsYMDInTZ(d2));
    }
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true;
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
    }

  // ----- Modal (נוצר פעם אחת) -----
  const modalHTML = `
    <div id="biModal" class="fixed inset-0 z-[1000] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10 shadow-luxe">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div class="text-lg font-bold" id="biModalTitle">נתונים</div>
          <button id="biExportBtn" class="ms-auto px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20 hover:bg-white/15">
            ייצוא ל-XLSX
          </button>
          <button id="biCloseBtn" class="ms-2 px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20 hover:bg-white/15">סגירה</button>
        </div>
        <div class="p-4 overflow-auto" style="max-height:70vh">
          <table id="biTable" class="w-full text-sm border-separate border-spacing-0">
            <thead id="biThead"></thead>
            <tbody id="biTbody"></tbody>
          </table>
          <div id="biEmpty" class="text-ink-200/70 text-sm p-4 hidden">אין נתונים להצגה.</div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  const modal = document.getElementById('biModal');
  const tHead = document.getElementById('biThead');
  const tBody = document.getElementById('biTbody');
  const empty = document.getElementById('biEmpty');
  const title = document.getElementById('biModalTitle');
  const btnClose = document.getElementById('biCloseBtn');
  const btnExport = document.getElementById('biExportBtn');

  btnClose.addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

  // ----- רנדר טבלה + יצוא -----
  let currentRows = [];
  function renderTable(rows) {
    currentRows = rows || [];
    if (!rows.length) {
      tHead.innerHTML = ''; tBody.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    // כותרות לפי איחוד כל המפתחות הראשונים (שומר על סדר עמודות כפי שבקובץ לרוב)
    const headers = Array.from(rows.reduce((set, r) => {
      Object.keys(r).forEach(k => set.add(k));
      return set;
    }, new Set()));

    // THEAD
    tHead.innerHTML = `<tr>${
      headers.map(h => `<th class="sticky top-0 bg-[#0b1220] text-ink-200/80 font-semibold px-3 py-2 border-b border-white/10 text-right">${escapeHTML(h)}</th>`).join('')
    }</tr>`;

    // TBODY
    tBody.innerHTML = rows.map(r => `
      <tr class="hover:bg-white/5">
        ${headers.map(h => `<td class="px-3 py-2 border-b border-white/5 align-top">${escapeHTML(r[h] ?? '')}</td>`).join('')}
      </tr>
    `).join('');
  }

  function exportXLSX(filename='export.xlsx') {
    if (!window.XLSX) return alert('ספריית XLSX לא נטענה.');
    const ws = XLSX.utils.json_to_sheet(currentRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, filename);
  }
  btnExport.addEventListener('click', () => exportXLSX(title.dataset.filename || 'export.xlsx'));

  function openModal(rows, modalTitle, fileNameBase='export') {
    title.textContent = modalTitle;
    title.dataset.filename = `${fileNameBase}.xlsx`;
    renderTable(rows);
    modal.classList.remove('hidden');
  }

  function escapeHTML(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  // ----- פילטרים לפי הקלקה -----
  function getDataset() {
    return Array.isArray(window.__dataset) ? window.__dataset : [];
  }

  // 1) KPI-ים
  const elTotal = document.getElementById('kpiOpenTotal');
  const elToday = document.getElementById('kpiOpenedToday');
  const elYest  = document.getElementById('kpiOpenedYesterday');

  function rowsOpenTotal() {
    const rows = getDataset();
    return rows.filter(isOpenRow);
  }
  function rowsOpenedDay(key) {
    const rows = getDataset();
    const dateCol = rows.length ? findCol(rows[0], OPEN_DATE_COL_KEYS) : null;
    if (!dateCol) return [];
    return rows.filter(r => isOpenRow(r) && normalizeDateOnly(r[dateCol]) === key);
  }

  // UX: להפוך את המספרים ל"קליקאבלים"
  [elTotal, elToday, elYest].forEach(el => {
    if (el) {
      el.classList.add('cursor-pointer','underline','underline-offset-4','decoration-white/30');
      el.setAttribute('title','לחיצה להצגת הטבלה');
    }
  });

  elTotal?.addEventListener('click', () => {
    const rows = rowsOpenTotal();
    openModal(rows, 'כל הפניות הפתוחות', 'open_tickets');
  });
  elToday?.addEventListener('click', () => {
    const rows = rowsOpenedDay(todayKey());
    openModal(rows, 'פניות שנפתחו היום', 'opened_today');
  });
  elYest?.addEventListener('click', () => {
    const rows = rowsOpenedDay(yesterdayKey());
    openModal(rows, 'פניות שנפתחו אתמול', 'opened_yesterday');
  });

  // 2) רשימות שלב 3 – עיר / יחידה
  //    מאזינים ב-delegation לקונטיינרים שהוגדרו בשלב 3: listByCity, listByUnit
  function attachListClick(containerId, nameSelectorIndex, filterFn, titlePrefix, filePrefix) {
    const box = document.getElementById(containerId);
    if (!box) return;
    box.addEventListener('click', (e) => {
      // השורה היא div עם שני span-ים; ניקח את הטקסט של הראשון (שם הקטגוריה)
      const row = e.target.closest('div.py-2');
      if (!row) return;
      const nameEl = row.querySelector('span');
      if (!nameEl) return;
      const name = nameEl.textContent.trim();
      if (!name) return;
      const rows = filterFn(name);
      openModal(rows, `${titlePrefix} — ${name}`, `${filePrefix}_${sanitizeFileName(name)}`);
    });
    // עכבר מצביע
    box.classList.add('cursor-pointer');
  }

  function sanitizeFileName(s) {
    return s.replace(/[\\/:*?"<>|]+/g,'_').slice(0,60);
  }

  // מסננים לפי עיר/יחידה
  // התאמות עמודות גמישות (תואם שלב 3 החדש)
  const HEB_DIACRITICS = /[\u0591-\u05C7]/g;
  function normHeader(s) {
    return String(s).replace(HEB_DIACRITICS,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();
  }
  function headerIncludesAll(colName, keywords) {
    const n = normHeader(colName);
    return keywords.every(k => n.includes(normHeader(k)));
  }
  const CITY_EXACT = ['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'];
  const CITY_KEYWORDS = [['עיר'], ['יישוב']];
  const UNIT_EXACT = ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'];
  const UNIT_KEYWORDS = [['יחידת','דואר','שם'], ['שם','יחידה']];

  function findColumnFlexible(row0, exactList, keywordSets) {
    if (!row0) return null;
    const headers = Object.keys(row0);
    for (const h of headers) {
      if (exactList.includes(h)) return h;
      const hNorm = normHeader(h);
      for (const ex of exactList) if (hNorm === normHeader(ex)) return h;
    }
    for (const h of headers) {
      if (keywordSets.some(kwSet => headerIncludesAll(h, kwSet))) return h;
    }
    return null;
  }

  function filterByCity(name) {
    const rows = getDataset();
    const col = rows.length ? findColumnFlexible(rows[0], CITY_EXACT, CITY_KEYWORDS) : null;
    if (!col) return [];
    return rows.filter(r => isOpenRow(r) && String(r[col] ?? '').trim() === name);
  }
  function filterByUnit(name) {
    const rows = getDataset();
    const col = rows.length ? findColumnFlexible(rows[0], UNIT_EXACT, UNIT_KEYWORDS) : null;
    if (!col) return [];
    return rows.filter(r => isOpenRow(r) && String(r[col] ?? '').trim() === name);
  }

  attachListClick('listByCity', 0, filterByCity, 'פניות פתוחות לפי עיר', 'city');
  attachListClick('listByUnit', 0, filterByUnit, 'פניות פתוחות לפי יחידה', 'unit');

  // אם הנתונים הוטענו אחרי שהסקריפט נטען – אין צורך בפעולה מיוחדת; המאזינים כבר יושבים.
})();
</script> 
  <!-- === STEP 4: כפילויות (גרסה קצרה) === -->
<section id="biDupHost" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 4 (כפילויות, תצוגה קצרה)</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">טופ-20 לכל קטגוריה</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- מספר מעקב -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="flex items-center gap-2 mb-2">
          <div class="text-sm font-semibold text-ink-200/85">מספר מעקב כפול</div>
          <div id="sumTracking" class="ms-auto text-xs text-ink-200/60"></div>
        </div>
        <div id="listTracking" class="divide-y divide-white/10"></div>
        <button id="moreTracking" class="mt-3 w-full text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/15 hidden">הצג עוד</button>
      </div>
      <!-- שם לקוח -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="flex items-center gap-2 mb-2">
          <div class="text-sm font-semibold text-ink-200/85">שם לקוח כפול</div>
          <div id="sumName" class="ms-auto text-xs text-ink-200/60"></div>
        </div>
        <div id="listName" class="divide-y divide-white/10"></div>
        <button id="moreName" class="mt-3 w-full text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/15 hidden">הצג עוד</button>
      </div>
      <!-- אימייל -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="flex items-center gap-2 mb-2">
          <div class="text-sm font-semibold text-ink-200/85">דוא״ל לקוח כפול</div>
          <div id="sumEmail" class="ms-auto text-xs text-ink-200/60"></div>
        </div>
        <div id="listEmail" class="divide-y divide-white/10"></div>
        <button id="moreEmail" class="mt-3 w-full text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/15 hidden">הצג עוד</button>
      </div>
    </div>
  </div>
</section>

<!-- מודאל לטבלה + יצוא (קומפקטי) -->
<section id="biModalHost"></section>

<script>
(() => {
  // ===== קבועים קצרים =====
  const $ = id => document.getElementById(id);
  const DIAC = /[\u0591-\u05C7]/g, SEP=/[·•:;|/_\-()\[\]{}]/g;
  const normHeader = s => String(s).replace(DIAC,'').replace(SEP,'').replace(/\s+/g,'').toLowerCase();
  const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  // עמודות אפשריות (קצר)
  const COLS = {
    tracking:{ exact:['מספר מעקב','מספר משלוח','מספר פריט','Tracking','tracking','מספר שבלי','מספר שבל״י'], kw:[['מספר','מעקב'],['מספר','משלוח'],['מספר','פריט']] },
    name:    { exact:['שם לקוח','שם הלקוח','שם שולח',שם' המקבל'],                           kw:[['שם','לקוח'],['שם','שולח'],['שם','מקבל']] },
    email:   { exact:['דואר אלקטרוני','אימייל','מייל','Email','email','כתובת דוא״ל','כתובת דואל'], kw:[['דואר','אלקטרוני'],['email']] }
  };

  // ===== דאטה (ממחזר מהאתר) =====
  async function ensureDataset(){
    if (Array.isArray(window.__dataset) && window.__dataset.length) return window.__dataset;
    if (!window.__lastFile || !window.XLSX) return [];
    const buf=await window.__lastFile.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]];
    return (window.__dataset = XLSX.utils.sheet_to_json(sh,{defval:null}));
  }
  const getData = () => Array.isArray(window.__dataset) ? window.__dataset : [];

  // ===== איתור עמודה גמיש =====
  function findCol(row0, spec){
    if (!row0) return null;
    const keys=Object.keys(row0);
    for (const h of keys){ if (spec.exact.includes(h)) return h; if (normHeader(h)===normHeader(h)){} }
    // התאמה מדויקת אחרי נירמול
    for (const h of keys) for (const ex of spec.exact) if (normHeader(h)===normHeader(ex)) return h;
    // מילות מפתח
    for (const h of keys){ const n=normHeader(h); if (spec.kw.some(set=>set.every(w=>n.includes(normHeader(w))))) return h; }
    return null;
  }

  // ===== בניית כפילויות כללית =====
  function dupIndex(rows, col, normVal=(v=>String(v).trim())){
    if (!col) return { col:null, items:[] };
    const m=new Map();
    for (const r of rows){ const v=r[col]; if (v==null||v==='') continue; const k=normVal(v); if(!k) continue;
      const b=m.get(k)||{count:0, rows:[]}; b.count++; b.rows.push(r); m.set(k,b);
    }
    const items=Array.from(m.entries()).filter(([,b])=>b.count>=2).map(([value,b])=>({value,count:b.count,rows:b.rows}))
                   .sort((a,b)=>b.count-a.count);
    return { col, items };
  }

  // ===== מודאל קצר + יצוא =====
  function ensureModal(){
    if ($('biModal')) return;
    $('biModalHost').insertAdjacentHTML('beforeend', `
      <div id="biModal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
          <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
            <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
            <button id="biExport" class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
            <button id="biClose" class="ms-2 text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
          <div class="p-4 overflow-auto" style="max-height:70vh">
            <table class="w-full text-sm border-separate border-spacing-0">
              <thead id="biThead"></thead><tbody id="biTbody"></tbody>
            </table>
            <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
          </div>
        </div>
      </div>`);
    $('biClose').onclick=()=>$('biModal').classList.add('hidden');
    $('biModal').onclick=e=>{ if(e.target.id==='biModal') $('biModal').classList.add('hidden'); };
    $('biExport').onclick=()=>exportXLSX(($('biModalTitle').dataset.filename||'export')+'.xlsx');
  }
  let __ROWS__=[];
  function renderTable(rows){
    __ROWS__=rows||[]; const H=$('biThead'), B=$('biTbody'), E=$('biEmpty');
    if(!rows.length){ H.innerHTML=''; B.innerHTML=''; E.classList.remove('hidden'); return; }
    E.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
    H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${esc(h)}</th>`).join('')+'</tr>';
    B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${esc(r[h]??'')}</td>`).join('')+'</tr>').join('');
  }
  function exportXLSX(fn){ if(!window.XLSX) return alert('XLSX לא נטענה'); const ws=XLSX.utils.json_to_sheet(__ROWS__); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Data'); XLSX.writeFile(wb,fn); }
  function openModal(rows,title,fileBase){ ensureModal(); renderTable(rows); $('biModalTitle').textContent=title; $('biModalTitle').dataset.filename=fileBase; $('biModal').classList.remove('hidden'); }

  // ===== רנדר רשימה קצרה עם "הצג עוד" =====
  function renderListShort(listEl, moreBtn, sumEl, items, titlePrefix, filePrefix){
    const STEP=20; let shown=0;
    function draw(){
      const slice=items.slice(0, shown+=STEP);
      listEl.innerHTML = slice.map(it => `
        <div class="py-2 flex items-center gap-3 cursor-pointer hover:bg-white/5 rounded">
          <span class="truncate max-w-[65%]" title="${esc(it.value)}">${esc(it.value)}</span>
          <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10">${it.count.toLocaleString('he-IL')} הופעות</span>
        </div>`).join('');
      listEl.querySelectorAll('div').forEach((row,i)=>{
        row.onclick=()=>openModal(items[i].rows, `${titlePrefix} — ${items[i].value}`, `${filePrefix}_${items[i].value}`.replace(/[\\/:*?"<>|]+/g,'_').slice(0,64));
      });
      moreBtn.classList.toggle('hidden', shown>=items.length);
      sumEl.textContent = items.length ? `${items.length.toLocaleString('he-IL')} ערכים כפולים` : 'אין כפילויות';
    }
    shown=0; draw(); moreBtn.onclick=draw;
  }

  // ===== הפעלה =====
  async function runStep4(){
    await ensureDataset();
    const data=getData(); const first=data[0];
    const colT=findCol(first, COLS.tracking), colN=findCol(first, COLS.name), colE=findCol(first, COLS.email);
    const dT=dupIndex(data, colT, v=>String(v).replace(/\s+/g,'').trim());
    const dN=dupIndex(data, colN, v=>String(v).replace(/\s+/g,' ').trim());
    const dE=dupIndex(data, colE, v=>String(v).trim().toLowerCase());

    renderListShort($('listTracking'), $('moreTracking'), $('sumTracking'), dT.items, 'מספר מעקב', 'dup_tracking');
    renderListShort($('listName'),     $('moreName'),     $('sumName'),     dN.items, 'שם לקוח',  'dup_name');
    renderListShort($('listEmail'),    $('moreEmail'),    $('sumEmail'),    dE.items, 'דוא״ל לקוח','dup_email');
  }

  // להתחבר לזרימה אחרי קליטת קובץ
  if (typeof window.updateSuccessUI==='function'){
    const prev=window.updateSuccessUI;
    window.updateSuccessUI=function(){ prev.apply(this,arguments); setTimeout(runStep4,0); };
  }
  // אם כבר נטען דוח בעבר
  if (Array.isArray(window.__dataset) && window.__dataset.length) runStep4();
})();
</script>
  <!-- === STEP 6: סנכרון תצוגות לפי "מחלקה מטפלת" (פילטר חוצה-שלבים) === -->
<script>
(() => {
  // -------- Helpers --------
  const $ = (id) => document.getElementById(id);
  const HEB_DIAC = /[\u0591-\u05C7]/g;
  const SEP = /[·•:;|/_\-()\[\]{}]/g;
  const normHeader = s => String(s).replace(HEB_DIAC,'').replace(SEP,'').replace(/\s+/g,'').toLowerCase();
  const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  const COLS = {
    dept: ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    city: { exact:['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'], kw:[['עיר'],['יישוב']] },
    unit: { exact:['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'], kw:[['יחידת','דואר','שם'],['שם','יחידה']] },
    status: ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'],
    tracking: { exact:['מספר מעקב','מספר משלוח','מספר פריט','Tracking','tracking','מספר שבלי','מספר שבל״י'], kw:[['מספר','מעקב'],['מספר','משלוח'],['מספר','פריט']] },
    name:     { exact:['שם לקוח','שם הלקוח','שם שולח','שם המקבל'], kw:[['שם','לקוח'],['שם','שולח'],['שם','מקבל']] },
    email:    { exact:['דואר אלקטרוני','אימייל','מייל','Email','email','כתובת דוא״ל','כתובת דואל'], kw:[['דואר','אלקטרוני'],['email']] }
  };

  function findCol(row, keysOrSpec){
    if (!row) return null;
    const headers = Object.keys(row);
    // spec with exact/kw
    if (keysOrSpec && keysOrSpec.exact){
      for (const h of headers){ if (keysOrSpec.exact.includes(h)) return h;
        const hN=normHeader(h); for (const ex of keysOrSpec.exact) if (hN===normHeader(ex)) return h; }
      for (const h of headers){ const n=normHeader(h);
        if (keysOrSpec.kw.some(set=>set.every(w=>n.includes(normHeader(w))))) return h; }
      return null;
    }
    // simple list
    for (const k of keysOrSpec) if (k in row) return k;
    const targets = keysOrSpec.map(k=>normHeader(k));
    for (const h of headers) if (targets.includes(normHeader(h))) return h;
    return null;
  }

  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }
  function setActiveDept(name){
    window.__biActiveDept = name || 'כללי';
    window.dispatchEvent(new CustomEvent('bi:dept-change',{detail:{dept:window.__biActiveDept}}));
  }

  function isOpenRow(row){
    const key = findCol(row, COLS.status);
    if (!key) return true;
    const v = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => v === c || v.includes(c));
  }

  function filterRowsByDept(rows){
    const dept = activeDept();
    if (dept === 'כללי') return rows;
    const col = rows.length ? findCol(rows[0], COLS.dept) : null;
    if (!col) return rows; // אם לא נמצאה עמודה – לא נסנן
    return rows.filter(r => String(r[col] ?? '').trim() === dept);
  }

  // -------- Re-render STEP 3 (עיר/יחידה) --------
  const MIN100 = 100;
  function aggregateCounts(rows, which){
    if (!rows.length) return {items:[], col:null};
    const col = which==='city' ? findCol(rows[0], COLS.city) : findCol(rows[0], COLS.unit);
    if (!col) return {items:[], col:null};
    const m = new Map();
    rows.forEach(r => {
      if (!isOpenRow(r)) return;
      const key = String(r[col] ?? '').trim();
      if (!key) return;
      m.set(key, (m.get(key)||0)+1);
    });
    const items = Array.from(m.entries()).filter(([,c])=>c>=MIN100)
      .sort((a,b)=>b[1]-a[1]).map(([name,count])=>({name,count}));
    return {items, col};
  }
  function renderStep3(){
    const rows = filterRowsByDept(getDataset());
    const byCity = aggregateCounts(rows,'city');
    const byUnit = aggregateCounts(rows,'unit');

    // אם יש לך את שלב 3 “המקוצר”, זה יעדכן את אותם אלמנטים קיימים:
    const listByCity = $('listByCity'), listByUnit = $('listByUnit');
    const msgCity = $('msgCity'), msgUnit = $('msgUnit');

    if (listByCity){
      listByCity.innerHTML = byCity.items.map(it => `
        <div class="py-2 flex items-center gap-3">
          <span class="text-ink-50/90">${esc(it.name)}</span>
          <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10">${it.count.toLocaleString('he-IL')} פניות</span>
        </div>`).join('');
      if (msgCity) msgCity.textContent = !byCity.col ? 'לא נמצאה עמודת עיר/יישוב בקובץ.' :
        (!byCity.items.length ? `אין ערים עם לפחות ${MIN100} פניות פתוחות.` : '');
    }
    if (listByUnit){
      listByUnit.innerHTML = byUnit.items.map(it => `
        <div class="py-2 flex items-center gap-3">
          <span class="text-ink-50/90">${esc(it.name)}</span>
          <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10">${it.count.toLocaleString('he-IL')} פניות</span>
        </div>`).join('');
      if (msgUnit) msgUnit.textContent = !byUnit.col ? 'לא נמצאה עמודת "יחידת דואר: שם".' :
        (!byUnit.items.length ? `אין יחידות עם לפחות ${MIN100} פניות פתוחות.` : '');
    }
  }

  // -------- Re-render STEP 4 (כפילויות) --------
  function dupIndex(rows, col, normVal=(v=>String(v).trim())){
    if (!col) return [];
    const m=new Map();
    rows.forEach(r=>{
      const v=r[col]; if (v==null||v==='') return;
      const k=normVal(v); if(!k) return;
      const b=m.get(k)||{count:0, rows:[]}; b.count++; b.rows.push(r); m.set(k,b);
    });
    return Array.from(m.entries()).filter(([,b])=>b.count>=2)
      .map(([value,b])=>({value,count:b.count,rows:b.rows}))
      .sort((a,b)=>b.count-a.count);
  }
  function renderStep4(){
    const rows = filterRowsByDept(getDataset());
    const first = rows[0];

    const colT = first ? findCol(first, COLS.tracking) : null;
    const colN = first ? findCol(first, COLS.name)     : null;
    const colE = first ? findCol(first, COLS.email)    : null;

    const itemsT = dupIndex(rows, colT, v=>String(v).replace(/\s+/g,'').trim());
    const itemsN = dupIndex(rows, colN, v=>String(v).replace(/\s+/g,' ').trim());
    const itemsE = dupIndex(rows, colE, v=>String(v).trim().toLowerCase());

    const renderShort = (listId,sumId,items,label) => {
      const list = $(listId), sum=$(sumId);
      if (!list) return;
      const SLICE = items.slice(0,20); // טופ-20, כמו בגרסה המקוצרת
      list.innerHTML = SLICE.map(it => `
        <div class="py-2 flex items-center gap-3">
          <span class="truncate max-w-[65%]" title="${esc(it.value)}">${esc(it.value)}</span>
          <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10">${it.count.toLocaleString('he-IL')} הופעות</span>
        </div>`).join('');
      if (sum) sum.textContent = items.length ? `${items.length.toLocaleString('he-IL')} ערכים כפולים` : `אין כפילויות ב${label}`;
    };

    renderShort('listTracking','sumTracking',itemsT,'מספרי מעקב');
    renderShort('listName','sumName',itemsN,'שמות לקוח');
    renderShort('listEmail','sumEmail',itemsE,'דוא״ל');
  }

  // -------- האזנה לטאבים של שלב 2 --------
  function bindDeptTabs(){
    const tabs = document.getElementById('deptTabs');
    if (!tabs || tabs.__biBound) return;
    tabs.__biBound = true;
    tabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if (!btn) return;
      const name = btn.textContent.trim();
      if (name) setActiveDept(name);
    });
  }

  // אם שלב 2 יוצר/מחליף כפתורים אחרי טעינת קובץ, נשתמש ב-MutationObserver
  const mo = new MutationObserver(bindDeptTabs);
  mo.observe(document.body, {subtree:true, childList:true});

  // -------- רענון כשיש שינוי מחלקה/קובץ --------
  window.addEventListener('bi:dept-change', ()=>{
    renderStep3();
    renderStep4();
  });

  // אחרי קליטת קובץ – נבצע רנדר לפי המחלקה הפעילה
  if (typeof window.updateSuccessUI === 'function'){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){
      const ret = prev.apply(this, arguments);
      Promise.resolve(ret).finally(()=>{
        bindDeptTabs();
        // אם טרם נקבעה מחלקה – נזהה כפתור נבחר אם יש, אחרת "כללי"
        if (!window.__biActiveDept){
          const activeBtn = document.querySelector('#deptTabs button[aria-pressed="true"], #deptTabs button.bg-gradient-to-r');
          setActiveDept(activeBtn?.textContent?.trim() || 'כללי');
        }
        renderStep3();
        renderStep4();
      });
    };
  }

  // ריצה ראשונית אם כבר נטען קובץ
  bindDeptTabs();
  if (getDataset().length){
    if (!window.__biActiveDept) setActiveDept('כללי');
    renderStep3();
    renderStep4();
  }
})();
</script>
  <script>
(() => {
  // ---- Utilities (תואם סעיף 6) ----
  const $ = (id) => document.getElementById(id);
  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  const COLS = {
    dept:   ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    status: ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'],
    city:   { exact:['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'], kw:[['עיר'],['יישוב']] },
    unit:   { exact:['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'], kw:[['יחידת','דואר','שם'],['שם','יחידה']] },
    tracking:{ exact:['מספר מעקב','מספר משלוח','מספר פריט','Tracking','tracking','מספר שבלי','מספר שבל״י'], kw:[['מספר','מעקב'],['מספר','משלוח'],['מספר','פריט']] },
    name:    { exact:['שם לקוח','שם הלקוח','שם שולח','שם המקבל'], kw:[['שם','לקוח'],['שם','שולח'],['שם','מקבל']] },
    email:   { exact:['דואר אלקטרוני','אימייל','מייל','Email','email','כתובת דוא״ל','כתובת דואל'], kw:[['דואר','אלקטרוני'],['email']] }
  };
  const HEB = /[\u0591-\u05C7]/g, SEP=/[·•:;|/_\-()\[\]{}]/g;
  const normHeader = s => String(s).replace(HEB,'').replace(SEP,'').replace(/\s+/g,'').toLowerCase();

  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }
  function findCol(row, keysOrSpec){
    if (!row) return null;
    const headers = Object.keys(row);
    if (keysOrSpec && keysOrSpec.exact){
      for (const h of headers){ if (keysOrSpec.exact.includes(h)) return h;
        const hn=normHeader(h); for (const ex of keysOrSpec.exact) if (hn===normHeader(ex)) return h; }
      for (const h of headers){ const n=normHeader(h);
        if (keysOrSpec.kw.some(set => set.every(w => n.includes(normHeader(w))))) return h; }
      return null;
    }
    for (const k of keysOrSpec) if (k in row) return k;
    const targets = keysOrSpec.map(k => normHeader(k));
    for (const h of headers) if (targets.includes(normHeader(h))) return h;
    return null;
  }
  function isOpenRow(row){
    const k=findCol(row, COLS.status);
    if (!k) return true;
    const v=String(row[k]??'').trim();
    return !CLOSED.some(c => v===c || v.includes(c));
  }
  function filterRowsByDept(rows){
    const d = activeDept();
    if (d === 'כללי') return rows;
    const col = rows.length ? findCol(rows[0], COLS.dept) : null;
    return col ? rows.filter(r => String(r[col]??'').trim() === d) : rows;
  }

  // ---- Modal (קומפקט) ----
  function ensureModal(){
    if ($('biModal')) return;
    const html = `
      <div id="biModal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
          <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
            <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
            <button id="biExport" class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
            <button id="biClose" class="ms-2 text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
          <div class="p-4 overflow-auto" style="max-height:70vh">
            <table class="w-full text-sm border-separate border-spacing-0">
              <thead id="biThead"></thead><tbody id="biTbody"></tbody>
            </table>
            <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
          </div>
        </div>
      </div>`;
    (document.getElementById('biModalHost')||document.body).insertAdjacentHTML('beforeend', html);
    $('biClose').onclick=()=>$('biModal').classList.add('hidden');
    $('biModal').onclick=e=>{ if(e.target.id==='biModal') $('biModal').classList.add('hidden'); };
    $('biExport').onclick=()=>exportXLSX(($('biModalTitle').dataset.filename||'export')+'.xlsx');
  }
  let __ROWS__=[];
  function renderTable(rows){
    __ROWS__=rows||[];
    const H=$('biThead'), B=$('biTbody'), E=$('biEmpty');
    if(!rows.length){ H.innerHTML=''; B.innerHTML=''; E.classList.remove('hidden'); return; }
    E.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
    H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${h}</th>`).join('')+'</tr>';
    B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${r[h]??''}</td>`).join('')+'</tr>').join('');
  }
  function exportXLSX(fn){
    if (!window.XLSX) return alert('XLSX לא נטענה');
    const ws=XLSX.utils.json_to_sheet(__ROWS__); const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Data'); XLSX.writeFile(wb,fn);
  }
  function openModal(rows,title,fileBase){
    ensureModal(); renderTable(rows);
    const t=$('biModalTitle'); t.textContent=title; t.dataset.filename=fileBase;
    $('biModal').classList.remove('hidden');
  }

  // ---- חישוב רשומות כפולות עבור ערך שנלחץ ----
  function rowsForDuplicate(kind, value){
    const rows = filterRowsByDept(getDataset());
    if (!rows.length) return [];
    const first = rows[0];
    let col, normVal = s=>String(s).trim();
    if (kind==='tracking'){ col = findCol(first, COLS.tracking); normVal = s=>String(s).replace(/\s+/g,'').trim(); }
    if (kind==='name')    { col = findCol(first, COLS.name);     normVal = s=>String(s).replace(/\s+/g,' ').trim(); }
    if (kind==='email')   { col = findCol(first, COLS.email);    normVal = s=>String(s).trim().toLowerCase(); }
    if (!col) return [];
    const target = normVal(value);
    return rows.filter(r => isOpenRow(r) && normVal(r[col] ?? '') === target);
  }

  // ---- Delegation: מחבר קליקים לרשימות הכפילויות גם אחרי רינדור מחדש ----
  function bindDupClicks(containerId, kind, titlePrefix, filePrefix){
    const box = $(containerId);
    if (!box || box.__biBound) return;
    box.__biBound = true;
    box.addEventListener('click', (e)=>{
      const row = e.target.closest('#'+containerId+' > div');
      if (!row) return;
      const nameEl = row.querySelector('span');    // הטקסט הראשון בשורה
      const name = nameEl ? nameEl.textContent.trim() : '';
      if (!name) return;
      const rows = rowsForDuplicate(kind, name);
      openModal(rows, `${titlePrefix} — ${name}`, `${filePrefix}_${name}`.replace(/[\\/:*?"<>|]+/g,'_').slice(0,64));
    });
  }

  // חיבור ראשוני + לאחר כל שינוי מחלקה/קובץ
  function bindAll(){ 
    bindDupClicks('listTracking','tracking','מספר מעקב','dup_tracking');
    bindDupClicks('listName','name','שם לקוח','dup_name');
    bindDupClicks('listEmail','email','דוא״ל לקוח','dup_email');
  }
  bindAll();

  // כשסעיף 6 משנה מחלקה
  window.addEventListener('bi:dept-change', bindAll);

  // אחרי קליטת קובץ
  if (typeof window.updateSuccessUI==='function'){
    const prev=window.updateSuccessUI;
    window.updateSuccessUI=function(){ const r=prev.apply(this,arguments); Promise.resolve(r).finally(bindAll); };
  }
})();
  </script>
  <!-- === STEP 7 (FIX): בעלי מקרה — שם בלבד + חיפוש/מיון + מודאל עם חיפוש מלא === -->
<section id="biOwnersHost" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 7 (לפי בעלי מקרה: שם)</span>
      <span id="ownersSubtitle" class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">מחלקה: כללי</span>
      <span id="ownersColChip" class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10 hidden"></span>

      <div class="ms-auto flex items-center gap-2">
        <input id="ownersSearch" type="text" placeholder="חיפוש בעלי מקרה…"
               class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/15 focus:outline-none"
               style="min-width: 220px;">
        <select id="ownersSort" class="text-xs px-2 py-1.5 rounded-full bg-white/10 border border-white/15">
          <option value="count_desc">כמות: רב → מעט</option>
          <option value="count_asc">כמות: מעט → רב</option>
          <option value="name_asc">שם: א → ת</option>
          <option value="name_desc">שם: ת → א</option>
        </select>
      </div>
    </div>

    <div id="ownersMsg" class="text-xs text-ink-200/60 mb-3">טרם נטען קובץ.</div>

    <div class="overflow-auto rounded-2xl border border-white/10">
      <table class="w-full text-sm border-separate border-spacing-0">
        <thead>
          <tr class="text-ink-200/80 border-b border-white/10 bg-white/5">
            <th class="px-3 py-2 text-right">בעלי מקרה: שם</th>
            <th class="px-3 py-2 text-right">כמות פניות פתוחות</th>
          </tr>
        </thead>
        <tbody id="ownersTable"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- מודאל כללי עם חיפוש לכל העמודות -->
<section id="biModalHost"></section>

<script>
(() => {
  // ---------- Utils ----------
  const $ = (id) => document.getElementById(id);
  const HEB = /[\u0591-\u05C7]/g, SEP=/[·•:;|/_\-()\[\]{}]/g;
  const normHeader = s => String(s).replace(HEB,'').replace(SEP,'').replace(/\s+/g,'').toLowerCase();
  const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const normText = s => String(s ?? '').replace(HEB,'').toLowerCase().trim().replace(/\s+/g,' ');

  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  const COLS = {
    dept:   ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    status: ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status']
  };

  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }

  function findSimpleCol(row, candidates){
    if (!row) return null;
    for (const k of candidates) if (k in row) return k;
    const target = candidates.map(normHeader);
    for (const k in row) if (target.includes(normHeader(k))) return k;
    return null;
  }

  // ---------- NEW: בחירת "בעלי מקרה: שם" חכמה ----------
  function findOwnerNameCol(row0){
    if (!row0) return null;
    const headers = Object.keys(row0);

    // מילות חיוב (שם)
    const POS = ['שם','name','full name','שםבעלמקרה','שםמטפל'];
    // מילות שלילה (תפקיד)
    const NEG = ['תפקיד','role','position','title','team','agent','rep','super','manager'];

    // מועמדים כלליים תחת משפחת Owner/Assigned
    const FAMILY = [
      'בעלי מקרה','בעלי מקרה:','בעל מקרה','שם בעל מקרה','בעלי מקרה: שם','שם מטפל',
      'Owner','Case Owner','Assigned To','AssignedTo','Assigned','Owner Name'
    ];

    // ניקוד/נרמול
    const Hn = headers.map(h => ({raw:h, n:normHeader(h)}));

    // ציון לכל כותרת
    const scored = Hn.map(({raw,n})=>{
      let score = 0;
      // שייכות למשפחה
      if (FAMILY.some(f => n.includes(normHeader(f)))) score += 5;
      // חיוב על "שם"
      if (POS.some(p => n.includes(normHeader(p)))) score += 10;
      // שלילה על "תפקיד"
      if (NEG.some(p => n.includes(normHeader(p)))) score -= 12;
      // התאמות נפוצות בעברית
      if (n === normHeader('בעלי מקרה: שם')) score += 30;
      if (n === normHeader('שם בעל מקרה'))  score += 25;
      return {raw, score};
    });

    scored.sort((a,b)=>b.score-a.score);
    const best = scored[0];
    return (best && best.score > 0) ? best.raw : null;
  }

  function isOpenRow(row){
    const k = findSimpleCol(row, COLS.status);
    if (!k) return true;
    const v = String(row[k] ?? '').trim();
    return !CLOSED.some(c => v === c || v.includes(c));
  }
  function filterRowsByDept(rows){
    const d = activeDept();
    if (d === 'כללי') return rows;
    const col = rows.length ? findSimpleCol(rows[0], COLS.dept) : null;
    return col ? rows.filter(r => String(r[col] ?? '').trim() === d) : rows;
  }

  // ---------- Modal (search all columns) ----------
  let __ALL_ROWS__=[], __FILTERED__=[];
  function ensureModal(){
    if ($('biModal')) return;
    const html = `
      <div id="biModal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
          <div class="flex flex-wrap items-center gap-3 px-6 py-4 border-b border-white/10">
            <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
            <input id="biModalSearch" type="text" placeholder="חיפוש בכל העמודות…"
                   class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20 focus:outline-none"
                   style="min-width:280px">
            <button id="biExport" class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
            <button id="biClose" class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
          <div class="p-4 overflow-auto" style="max-height:70vh">
            <table class="w-full text-sm border-separate border-spacing-0">
              <thead id="biThead"></thead><tbody id="biTbody"></tbody>
            </table>
            <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
          </div>
        </div>
      </div>`;
    (document.getElementById('biModalHost')||document.body).insertAdjacentHTML('beforeend', html);
    $('biClose').onclick=()=>$('biModal').classList.add('hidden');
    $('biModal').onclick=e=>{ if(e.target.id==='biModal') e.currentTarget.classList.add('hidden'); };
    $('biExport').onclick=()=>exportXLSX(($('biModalTitle').dataset.filename||'export')+'.xlsx');
    $('biModalSearch').addEventListener('input', onModalSearch);
  }
  function renderModalTable(rows){
    const H=$('biThead'), B=$('biTbody'), E=$('biEmpty');
    if(!rows.length){ H.innerHTML=''; B.innerHTML=''; E.classList.remove('hidden'); return; }
    E.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
    H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${esc(h)}</th>`).join('')+'</tr>';
    B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${esc(r[h]??'')}</td>`).join('')+'</tr>').join('');
  }
  function onModalSearch(){
    const q = normText($('biModalSearch').value);
    if (!q){ __FILTERED__ = __ALL_ROWS__.slice(); renderModalTable(__FILTERED__); return; }
    __FILTERED__ = __ALL_ROWS__.filter(row => normText(Object.values(row).join(' ')).includes(q));
    renderModalTable(__FILTERED__);
  }
  function exportXLSX(fn){
    if (!window.XLSX) return alert('XLSX לא נטענה');
    const ws=XLSX.utils.json_to_sheet(__FILTERED__); const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Data'); XLSX.writeFile(wb,fn);
  }
  function openModal(rows, title, fileBase){
    ensureModal();
    const t=$('biModalTitle'); t.textContent=title; t.dataset.filename=fileBase;
    __ALL_ROWS__ = rows || []; __FILTERED__ = __ALL_ROWS__.slice();
    $('biModalSearch').value = '';
    renderModalTable(__FILTERED__);
    $('biModal').classList.remove('hidden');
  }

  // ---------- Owners aggregation ----------
  const state = { items: [], query: '', sort: 'count_desc', ownerCol: null };

  function aggregateOwners(rows){
    const col = state.ownerCol;
    if (!col) return [];
    const m=new Map(); // name -> {count, rows}
    rows.forEach(r=>{
      if (!isOpenRow(r)) return;
      const key = String(r[col] ?? '').trim();
      if (!key) return;
      const b=m.get(key)||{count:0, rows:[]};
      b.count++; b.rows.push(r);
      m.set(key,b);
    });
    return Array.from(m.entries()).map(([owner,b])=>({ owner, count:b.count, rows:b.rows }));
  }

  function applySearchAndSort(items){
    const q = normText(state.query);
    let arr = q ? items.filter(it => normText(it.owner).includes(q)) : items.slice();
    switch(state.sort){
      case 'count_desc': arr.sort((a,b)=>b.count - a.count); break;
      case 'count_asc':  arr.sort((a,b)=>a.count - b.count); break;
      case 'name_asc':   arr.sort((a,b)=>normText(a.owner).localeCompare(normText(b.owner),'he')); break;
      case 'name_desc':  arr.sort((a,b)=>normText(b.owner).localeCompare(normText(a.owner),'he')); break;
    }
    return arr;
  }

  function renderOwners(){
    const all = getDataset();
    const rows = filterRowsByDept(all);
    $('ownersSubtitle').textContent = `מחלקה: ${activeDept()}`;

    const msg=$('ownersMsg'), body=$('ownersTable'), colChip=$('ownersColChip');

    if (!all.length){ msg.textContent='טרם נטען קובץ.'; body.innerHTML=''; colChip.classList.add('hidden'); return; }

    // מציאת עמודת שם בעל מקרה (עם עדיפות לשם ולא לתפקיד)
    state.ownerCol = rows.length ? findOwnerNameCol(rows[0]) : null;

    if (!state.ownerCol){
      msg.textContent='לא נמצאה עמודת „בעלי מקרה: שם” (מילים כמו: "בעלי מקרה: שם", "שם בעל מקרה", "Owner Name").';
      body.innerHTML=''; colChip.classList.add('hidden'); return;
    }

    colChip.textContent = `עמודה: ${state.ownerCol}`; colChip.classList.remove('hidden');

    state.items = aggregateOwners(rows);
    const view = applySearchAndSort(state.items);

    msg.textContent = state.items.length
      ? `נמצאו ${state.items.length.toLocaleString('he-IL')} בעלי מקרה (פתוחות בלבד). מסוננים: ${view.length.toLocaleString('he-IL')}.`
      : 'אין פניות פתוחות במחלקה זו.';

    body.innerHTML = view.map(it => `
      <tr class="border-b border-white/10">
        <td class="px-3 py-2">${esc(it.owner)}</td>
        <td class="px-3 py-2">
          <button class="px-2 py-1 text-xs rounded-full bg-white/10 border border-white/15 hover:bg-white/15 open-owner" data-owner="${esc(it.owner)}">
            ${it.count.toLocaleString('he-IL')}
          </button>
        </td>
      </tr>`).join('');

    // פתיחת טבלת הפניות לאותו בעל מקרה
    body.querySelectorAll('.open-owner').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.dataset.owner;
        const ownerRows = rows.filter(r => String(r[state.ownerCol] ?? '').trim() === name);
        openModal(ownerRows, `פניות פתוחות — ${name} (${activeDept()})`, `owners_${name}`.replace(/[\\/:*?"<>|]+/g,'_').slice(0,64));
      });
    });
  }

  // ---------- Search + Sort ----------
  const searchEl=$('ownersSearch'), sortEl=$('ownersSort'); let t=null;
  searchEl.addEventListener('input', ()=>{ state.query = searchEl.value || ''; clearTimeout(t); t=setTimeout(renderOwners, 180); });
  sortEl.addEventListener('change', ()=>{ state.sort = sortEl.value; renderOwners(); $('ownersSearch').value=state.query; });

  // ---------- Wire-up ----------
  if (typeof window.updateSuccessUI === 'function'){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){ const ret=prev.apply(this,arguments); Promise.resolve(ret).finally(renderOwners); };
  }
  window.addEventListener('bi:dept-change', renderOwners);
  if (getDataset().length) renderOwners();
})();
</script>
  <script>
// --- HOTFIX לבעלי מקרה: פתיחת טבלה בקליק על המספר (delegation) ---
(() => {
  const $ = (id) => document.getElementById(id);
  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  const ownersTbody = document.getElementById('ownersTable');
  if (!ownersTbody) return;

  // כלי עזר תואם סעיפים קודמים
  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }
  function findSimpleCol(row, candidates){
    if (!row) return null;
    for (const k of candidates) if (k in row) return k;
    const norm = s => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = candidates.map(norm);
    for (const k in row) if (targets.includes(norm(k))) return k;
    return null;
  }
  function isOpenRow(row, statusCols){
    const k = findSimpleCol(row, statusCols);
    if (!k) return true;
    const v = String(row[k] ?? '').trim();
    return !CLOSED.some(c => v === c || v.includes(c));
  }
  function filterRowsByDept(rows, deptCols){
    const d = activeDept();
    if (d === 'כללי') return rows;
    const col = rows.length ? findSimpleCol(rows[0], deptCols) : null;
    return col ? rows.filter(r => String(r[col] ?? '').trim() === d) : rows;
  }

  // ננסה להשתמש בעמודה שנבחרה והוצגה בצ'יפ; אם אין—נחפש לפי שם מדויק
  function getOwnerCol(rows){
    const chip = document.getElementById('ownersColChip');
    const hinted = chip && chip.textContent && chip.textContent.replace(/^עמודה:\s*/,'').trim();
    if (hinted && rows.length && hinted in rows[0]) return hinted;

    // fallback: נסי כותרים שכיחים
    const candidates = [
      'בעלי מקרה: שם','שם בעל מקרה','בעלי מקרה','בעל מקרה','שם מטפל',
      'Owner Name','Owner','Case Owner','Assigned To','AssignedTo'
    ];
    return rows.length ? findSimpleCol(rows[0], candidates) : null;
  }

  // אם אין פונקציות מודאל קיימות – נוודא שיש (קומפקט)
  function ensureModal(){
    if (document.getElementById('biModal')) return;
    const html = `
      <div id="biModal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
          <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
            <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
            <button id="biExport" class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
            <button id="biClose" class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
          <div class="p-4 overflow-auto" style="max-height:70vh">
            <table class="w-full text-sm border-separate border-spacing-0">
              <thead id="biThead"></thead><tbody id="biTbody"></tbody>
            </table>
            <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
          </div>
        </div>
      </div>`;
    (document.getElementById('biModalHost')||document.body).insertAdjacentHTML('beforeend', html);
    document.getElementById('biClose').onclick=()=>document.getElementById('biModal').classList.add('hidden');
    document.getElementById('biModal').onclick=e=>{ if(e.target.id==='biModal') e.currentTarget.classList.add('hidden'); };
    document.getElementById('biExport').onclick=()=> {
      if (!window.XLSX) return alert('XLSX לא נטענה');
      const ws=XLSX.utils.json_to_sheet(window.__BI_ROWS__||[]);
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Data');
      const fn=(document.getElementById('biModalTitle').dataset.filename||'export')+'.xlsx';
      XLSX.writeFile(wb,fn);
    };
  }
  function renderModal(rows, title, fileBase){
    ensureModal();
    window.__BI_ROWS__ = rows || [];
    const H=document.getElementById('biThead'), B=document.getElementById('biTbody'), E=document.getElementById('biEmpty');
    if(!rows.length){ H.innerHTML=''; B.innerHTML=''; E.classList.remove('hidden'); }
    else{
      E.classList.add('hidden');
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${h}</th>`).join('')+'</tr>';
      const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${esc(r[h])}</td>`).join('')+'</tr>').join('');
    }
    const t=document.getElementById('biModalTitle'); t.textContent=title; t.dataset.filename=fileBase;
    document.getElementById('biModal').classList.remove('hidden');
  }

  // האזנה אחת לטבלה כולה – קליק על הכפתור עם המספר
  ownersTbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('.open-owner');
    if (!btn) return;

    // שם בעל המקרה – מהתא הראשון בשורה (לא מ-data-attr)
    const tr = e.target.closest('tr');
    const nameCell = tr && tr.querySelector('td:first-child');
    const ownerName = nameCell ? nameCell.textContent.trim() : '';
    if (!ownerName) return;

    // מסננים לפי מחלקה פעילה, ורק פניות פתוחות
    const all = getDataset();
    const rowsDept = filterRowsByDept(all, ['מחלקה מטפלת','מחלקה','מחלקה מטפלת ']);
    if (!rowsDept.length) return;

    const ownerCol = getOwnerCol(rowsDept);
    if (!ownerCol) return;

    const openRows = rowsDept.filter(r => isOpenRow(r, ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status']));
    const rows = openRows.filter(r => String(r[ownerCol] ?? '').trim() === ownerName);

    renderModal(rows, `פניות פתוחות — ${ownerName} (${activeDept()})`, `owners_${ownerName}`.replace(/[\\/:*?"<>|]+/g,'_').slice(0,64));
  });
})();
  </script>
  <!-- === STEP 8 (MINI + אחוזים): עומד בזמנים / חריג — כללי + לפי מחלקה === -->
<section id="biAgingMini" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — עמידה בזמנים (תאריך פתיחה → היום)</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">TZ: Asia/Jerusalem</span>
    </div>

    <!-- כללי: כל המחלקות -->
    <div class="mb-4">
      <div class="text-xs text-ink-200/70 mb-1">כל המחלקות</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">עומד בזמנים — כללי</div>
          <div id="kpiAllOk" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiAllOkPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">חריג — כללי</div>
          <div id="kpiAllOver" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiAllOverPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
      </div>
    </div>

    <!-- לפי המחלקה הנוכחית (הטאב) -->
    <div>
      <div id="deptTitleMini" class="text-xs text-ink-200/70 mb-1">מחלקה: כללי</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">עומד בזמנים — מחלקה</div>
          <div id="kpiDeptOk" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiDeptOkPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">חריג — מחלקה</div>
          <div id="kpiDeptOver" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiDeptOverPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
      </div>
    </div>

    <div class="mt-6 text-[11px] text-ink-200/60">
      חישוב לפי <b>„שעת/תאריך פתיחה ”</b> (תאריך בלבד, ללא שעה). כללים: 24ש (פניה לקבלת מידע/תקלה בפורטל), 8 ימים (חלוקת/יחידות דואר), 30 ימים (פנים-ארצי/שליחים), 60 ימים (בינלאומי). לחיצה על המספר תציג את הרשימה ותאפשר יצוא ל-XLSX.
    </div>
  </div>
</section>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Jerusalem';
  const DAY = 24*60*60*1000;
  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];

  const COLS = {
    openedAt: ['שעת/תאריך פתיחה ','שעת/תאריך פתיחה','תאריך/שעת פתיחה','תאריך פתיחה','פתיחה'],
    dept:     ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    status:   ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'],
    product:  ['סיווג מוצר','קו מוצר','סיווג נושא','נושא','סיווג בעיה','קטגוריה','Category']
  };

  function findCol(row, keys){
    if (!row) return null;
    for (const k of keys) if (k in row) return k;
    const norm = s => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = keys.map(norm);
    for (const k in row) if (targets.includes(norm(k))) return k;
    return null;
  }

  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }
  const normHe = s => String(s||'').replace(/[\u0591-\u05C7]/g,'').toLowerCase();

  // === תאריך ===
  function ymdFromDateTZ(date){
    const parts = new Intl.DateTimeFormat('he-IL',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
    const m = Object.fromEntries(parts.map(p=>[p.type,p.value]));
    return { y:+m.year, m:+m.month, d:+m.day };
  }
  function dateUTC(ymd){ return new Date(Date.UTC(ymd.y, ymd.m-1, ymd.d)); }
  function addDays(ymd,n){ const d=dateUTC(ymd); const d2=new Date(d.getTime()+n*DAY); return { y:d2.getUTCFullYear(), m:d2.getUTCMonth()+1, d:d2.getUTCDate() }; }
  function cmpYMD(a,b){ if(a.y!==b.y) return a.y-b.y; if(a.m!==b.m) return a.m-b.m; return a.d-b.d; }
  function todayYMD(){ return ymdFromDateTZ(new Date()); }
  function diffDays(a,b){ return Math.floor((dateUTC(a)-dateUTC(b))/DAY); }
  function fmtYMD(ymd){ return `${String(ymd.d).padStart(2,'0')}/${String(ymd.m).padStart(2,'0')}/${ymd.y}`; }

  function ymdFromCell(cellVal){
    if (!cellVal) return null;
    if (typeof cellVal==='number'){ const d=new Date(Date.UTC(1899,11,30)+Math.floor(cellVal)*DAY); return ymdFromDateTZ(d); }
    const s=String(cellVal).trim();
    const m=s.match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if(m){let [_,dd,mm,yy]=m;if(yy.length===2)yy='20'+yy;return{y:+yy,m:+mm,d:+dd};}
    const d=new Date(s);if(!isNaN(d))return ymdFromDateTZ(d);
    return null;
  }

  function pickTargetDays(row){
    const pk=findCol(row,COLS.product); const prod=normHe(pk?row[pk]:'');
    if(prod.includes('מידע')||prod.includes('תקלה')||prod.includes('portal')) return 1;
    if(prod.includes('חלוקת')||prod.includes('יחיד')) return 8;
    const dk=findCol(row,COLS.dept); const dept=normHe(dk?row[dk]:'');
    if(dept.includes('בינלאומי')) return 60;
    if(dept.includes('שליח')) return 30;
    if(dept.includes('פנים')&&dept.includes('ארצי')) return 30;
    return 30;
  }

  function isOpenRow(row){
    const k=findCol(row,COLS.status); if(!k) return true;
    const v=String(row[k]??'').trim();
    return !CLOSED.some(c=>v===c||v.includes(c));
  }

  function annotateRow(row){
    const openedKey=findCol(row,COLS.openedAt);
    const openYMD=openedKey?ymdFromCell(row[openedKey]):null;
    if(!openYMD) return {...row,__status:'unknown'};
    const dueYMD=addDays(openYMD,pickTargetDays(row));
    const today=todayYMD();
    const status=(cmpYMD(dueYMD,today)>=0)?'ok':'over';
    return {...row,'תאריך פתיחה (תאריך בלבד)':fmtYMD(openYMD),'תאריך יעד':fmtYMD(dueYMD),'גיל (ימים)':diffDays(today,openYMD),__status:status};
  }

  // === מודאל (לפתיחת טבלאות) ===
  function ensureModal(){
    if($('biModal')) return;
    const html=`<div id="biModal" class="fixed inset-0 z-[1000] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
          <button id="biExport" class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
          <button id="biClose" class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
        </div>
        <div class="p-4 overflow-auto" style="max-height:70vh">
          <table class="w-full text-sm border-separate border-spacing-0"><thead id="biThead"></thead><tbody id="biTbody"></tbody></table>
          <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
        </div>
      </div></div>`;
    (document.body).insertAdjacentHTML('beforeend',html);
    $('biClose').onclick=()=>$('biModal').classList.add('hidden');
    $('biModal').onclick=e=>{if(e.target.id==='biModal')e.currentTarget.classList.add('hidden');};
    $('biExport').onclick=()=>{
      if(!window.XLSX)return alert('XLSX לא נטענה');
      const ws=XLSX.utils.json_to_sheet(window.__BI_MODAL_ROWS__||[]);
      const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Data');
      const fn=($('biModalTitle').dataset.filename||'export')+'.xlsx';XLSX.writeFile(wb,fn);
    };
  }
  function renderTable(rows){
    const H=$('biThead'),B=$('biTbody'),E=$('biEmpty');
    window.__BI_MODAL_ROWS__=rows;
    if(!rows.length){H.innerHTML='';B.innerHTML='';E.classList.remove('hidden');return;}
    E.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))].filter(k=>!k.startsWith('__'));
    const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${esc(h)}</th>`).join('')+'</tr>';
    B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${esc(r[h])}</td>`).join('')+'</tr>').join('');
  }
  function openModal(rows,title,file){
    ensureModal();renderTable(rows);
    const t=$('biModalTitle');t.textContent=title;t.dataset.filename=file;
    $('biModal').classList.remove('hidden');
  }

  // === חישוב ===
  function compute(){
    const allRaw=getDataset().filter(isOpenRow);
    const allAnn=allRaw.map(annotateRow).filter(r=>r.__status!=='unknown');
    const dept=activeDept();
    $('deptTitleMini').textContent=`מחלקה: ${dept}`;
    let deptAnn=allAnn;
    if(dept!=='כללי'){
      const dk=findCol(allRaw[0]||{},COLS.dept);
      deptAnn=dk?allAnn.filter(r=>String(r[dk]??'').trim()===dept):[];
    }
    const allOk=allAnn.filter(r=>r.__status==='ok');
    const allOver=allAnn.filter(r=>r.__status==='over');
    const dOk=deptAnn.filter(r=>r.__status==='ok');
    const dOver=deptAnn.filter(r=>r.__status==='over');

    const fmt=n=>n.toLocaleString('he-IL');
    const pct=(part,total)=>total?`${Math.round(part*100/total)}%`:'—';
    const bind=(node,pctNode,rows,title,file,total)=>{
      node.textContent=fmt(rows.length);
      pctNode.textContent=pct(rows.length,total);
      node.classList.add('cursor-pointer','underline','underline-offset-4','decoration-white/30');
      node.onclick=()=>openModal(rows,title,file);
    };

    bind($('kpiAllOk'),$('kpiAllOkPct'),allOk,'עומד בזמנים — כל המחלקות','all_on_time',allAnn.length);
    bind($('kpiAllOver'),$('kpiAllOverPct'),allOver,'חריג — כל המחלקות','all_overdue',allAnn.length);
    bind($('kpiDeptOk'),$('kpiDeptOkPct'),dOk,`עומד בזמנים — ${dept}`,'dept_on_time',deptAnn.length);
    bind($('kpiDeptOver'),$('kpiDeptOverPct'),dOver,`חריג — ${dept}`,'dept_overdue',deptAnn.length);
  }

  if(typeof window.updateSuccessUI==='function'){
    const prev=window.updateSuccessUI;
    window.updateSuccessUI=function(){const r=prev.apply(this,arguments);Promise.resolve(r).finally(compute);};
  }
  window.addEventListener('bi:dept-change',compute);
  if(getDataset().length)compute();
})();
</script>
<!-- === STEP 9 (MINI + אחוזים): עומד / חריג לפי "תאריך שינוי אחרון" (72 שעות) — כללי + לפי מחלקה === -->
<section id="biStaleMini" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <span class="text-sm font-semibold text-ink-200/80">מעקב שינוי אחרון — 72 שעות</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">TZ: Asia/Jerusalem</span>
    </div>

    <!-- כללי: כל המחלקות -->
    <div class="mb-4">
      <div class="text-xs text-ink-200/70 mb-1">כל המחלקות</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">עומד בזמנים — כללי (≤ 72ש')</div>
          <div id="kpiStaleAllOk" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiStaleAllOkPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">חריג — כללי (> 72ש')</div>
          <div id="kpiStaleAllOver" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiStaleAllOverPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
      </div>
    </div>

    <!-- לפי המחלקה הנוכחית (הטאב) -->
    <div>
      <div id="deptTitleStale" class="text-xs text-ink-200/70 mb-1">מחלקה: כללי</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">עומד בזמנים — מחלקה (≤ 72ש')</div>
          <div id="kpiStaleDeptOk" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiStaleDeptOkPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">חריג — מחלקה (> 72ש')</div>
          <div id="kpiStaleDeptOver" class="text-3xl font-bold mt-1">—</div>
          <div id="kpiStaleDeptOverPct" class="text-xs text-ink-200/70 mt-1"></div>
        </div>
      </div>
    </div>

    <div class="mt-6 text-[11px] text-ink-200/60">
      מבוסס על עמודה <b>„תאריך שינוי אחרון”</b>. נחשב חריג אם עברו יותר מ-72 שעות מאז השינוי האחרון.<br/>
      לחיצה על המספר תציג את הרשימה ותאפשר יצוא ל-XLSX. מסונן לפי המחלקה שנבחרה בטאבים.
    </div>
  </div>
</section>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Jerusalem';
  const HOUR = 60 * 60 * 1000;
  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];

  const COLS = {
    lastChange: ['תאריך שינוי אחרון','שעת/תאריך שינוי אחרון','עדכון אחרון','תאריך עדכון אחרון',
                 'שינוי אחרון','עודכן בתאריך','תאריך שינוי','שעת/תאריך עדכון אחרון',
                 'Last Update','Last Updated','Updated At','updated_at','last_update','modified_at'],
    dept:   ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    status: ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status']
  };

  function findCol(row, keys){
    if (!row) return null;
    for (const k of keys) if (k in row) return k;
    const norm = s => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = keys.map(norm);
    for (const k in row) if (targets.includes(norm(k))) return k;
    return null;
  }
  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }

  function dtFromCell(cellVal){
    if (cellVal == null || cellVal === '') return null;
    if (typeof cellVal === 'number'){ 
      const epoch = new Date(Date.UTC(1899,11,30));
      const ms = Math.round(cellVal * 24 * 60 * 60 * 1000);
      return new Date(epoch.getTime() + ms);
    }
    const s = String(cellVal).trim();
    const m = s.match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m){
      let [_, dd, mm, yy, HH='00', MM='00', SS='00'] = m;
      if (yy.length === 2) yy = '20' + yy;
      return new Date(+yy, (+mm)-1, +dd, +HH, +MM, +SS);
    }
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function fmtDateTimeTZ(date){
    try {
      const p = new Intl.DateTimeFormat('he-IL',{ timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).formatToParts(date);
      const m = Object.fromEntries(p.map(x=>[x.type,x.value]));
      return `${m.day}/${m.month}/${m.year} ${m.hour}:${m.minute}`;
    } catch { return date.toLocaleString('he-IL'); }
  }

  function isOpenRow(row){
    const k = findCol(row, COLS.status);
    if (!k) return true;
    const v = String(row[k] ?? '').trim();
    return !CLOSED.some(c => v === c || v.includes(c));
  }

  function annotateRow(row){
    const k = findCol(row, COLS.lastChange);
    const dt = k ? dtFromCell(row[k]) : null;
    if (!dt) return { ...row, __status:'unknown' };

    const now = new Date();
    const hours = Math.floor((now.getTime() - dt.getTime()) / HOUR);
    const status = hours > 72 ? 'over' : 'ok';

    return {
      ...row,
      'שינוי אחרון (IZ)': fmtDateTimeTZ(dt),
      'שעות מאז שינוי': hours,
      __status: status
    };
  }

  function filterDeptRows(rows){
    const d = activeDept();
    if (d === 'כללי') return rows;
    const dk = rows.length ? findCol(rows[0], COLS.dept) : null;
    return dk ? rows.filter(r => String(r[dk] ?? '').trim() === d) : rows;
  }

  function computeStale(){
    const base = getDataset().filter(isOpenRow);
    const ann  = base.map(annotateRow).filter(r => r.__status !== 'unknown');
    const dept = activeDept();
    $('deptTitleStale').textContent = `מחלקה: ${dept}`;
    const deptAnn = filterDeptRows(ann);

    const allOk   = ann.filter(r => r.__status === 'ok');
    const allOver = ann.filter(r => r.__status === 'over');
    const dOk     = deptAnn.filter(r => r.__status === 'ok');
    const dOver   = deptAnn.filter(r => r.__status === 'over');

    const fmt = n => n.toLocaleString('he-IL');
    const pct = (part, total) => total ? `${Math.round(part * 100 / total)}%` : '—';

    const bind = (node, pctNode, rows, title, file, total) => {
      node.textContent = fmt(rows.length);
      pctNode.textContent = pct(rows.length, total);
      node.classList.add('cursor-pointer','underline','underline-offset-4','decoration-white/30');
      node.onclick = () => openModal(rows, title, file);
    };

    bind($('kpiStaleAllOk'),   $('kpiStaleAllOkPct'),   allOk,   'עומד בזמנים (≤72ש) — כל המחלקות', 'stale_all_ok', ann.length);
    bind($('kpiStaleAllOver'), $('kpiStaleAllOverPct'), allOver, 'חריג (>72ש) — כל המחלקות',        'stale_all_over', ann.length);
    bind($('kpiStaleDeptOk'),  $('kpiStaleDeptOkPct'),  dOk,     `עומד בזמנים (≤72ש) — ${dept}`,     'stale_dept_ok', deptAnn.length);
    bind($('kpiStaleDeptOver'),$('kpiStaleDeptOverPct'),dOver,   `חריג (>72ש) — ${dept}`,             'stale_dept_over', deptAnn.length);
  }

  if (typeof window.updateSuccessUI === 'function'){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){ const r = prev.apply(this, arguments); Promise.resolve(r).finally(computeStale); };
  }
  window.addEventListener('bi:dept-change', computeStale);
  if (getDataset().length) computeStale();
})();
        </script>
  <!-- === STEP 10: Aging Buckets — >3M & >6M (by "שעת/תאריך פתיחה") === -->
<section id="biAgingBuckets" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <span class="text-sm font-semibold text-ink-200/80">זמן פתיחה עד היום — פניות פתוחות</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">מבוסס תאריך בלבד מ-„שעת/תאריך פתיחה”</span>
    </div>

    <!-- כל המחלקות -->
    <div class="mb-4">
      <div class="text-xs text-ink-200/70 mb-1">כל המחלקות</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">מעל 3 חודשים — כללי</div>
          <div id="kpiAllOver3m" class="text-3xl font-bold mt-1">—</div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">מעל חצי שנה — כללי</div>
          <div id="kpiAllOver6m" class="text-3xl font-bold mt-1">—</div>
        </div>
      </div>
    </div>

    <!-- לפי המחלקה הנוכחית -->
    <div>
      <div id="deptTitleAging" class="text-xs text-ink-200/70 mb-1">מחלקה: כללי</div>
      <div class="grid grid-cols-2 gap-4">
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">מעל 3 חודשים — מחלקה</div>
          <div id="kpiDeptOver3m" class="text-3xl font-bold mt-1">—</div>
        </div>
        <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
          <div class="text-xs text-ink-200/70">מעל חצי שנה — מחלקה</div>
          <div id="kpiDeptOver6m" class="text-3xl font-bold mt-1">—</div>
        </div>
      </div>
    </div>

    <div class="mt-6 text-[11px] text-ink-200/60">
      חישוב לפי „שעת/תאריך פתיחה” — מתעלם מהשעה ולוקח תאריך בלבד (Asia/Jerusalem). לחיצה על מספר פותחת טבלה עם אפשרות יצוא ל-XLSX.
    </div>
  </div>
</section>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const TZ = 'Asia/Jerusalem';
  const DAY = 24*60*60*1000;
  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];

  const COLS = {
    openedAt: ['שעת/תאריך פתיחה ','שעת/תאריך פתיחה','תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'],
    dept:     ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    status:   ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status']
  };

  function findCol(row, keys){
    if (!row) return null;
    for (const k of keys) if (k in row) return k;
    const norm = s => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = keys.map(norm);
    for (const k in row) if (targets.includes(norm(k))) return k;
    return null;
  }
  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }
  function activeDept(){ return window.__biActiveDept || 'כללי'; }
  function isOpenRow(row){
    const k = findCol(row, COLS.status); if (!k) return true;
    const v = String(row[k] ?? '').trim();
    return !CLOSED.some(c => v === c || v.includes(c));
  }

  // תאריך־בלבד לפי ישראל
  function ymdFromDateTZ(date){
    const parts = new Intl.DateTimeFormat('he-IL',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
    const m = Object.fromEntries(parts.map(p=>[p.type,p.value]));
    return { y:+m.year, m:+m.month, d:+m.day };
  }
  function ymdFromCell(cellVal){
    if (cellVal==null || cellVal==='') return null;
    if (typeof cellVal==='number'){ const epoch=new Date(Date.UTC(1899,11,30)); const d=new Date(epoch.getTime()+Math.floor(cellVal)*DAY); return ymdFromDateTZ(d); }
    const s=String(cellVal).trim();
    const m=s.match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if (m){ let [_,dd,mm,yy]=m; if(yy.length===2) yy='20'+yy; return { y:+yy, m:+mm, d:+dd }; }
    const d=new Date(s); if (!isNaN(d)) return ymdFromDateTZ(d);
    return null;
  }
  function dateUTC(ymd){ return new Date(Date.UTC(ymd.y, ymd.m-1, ymd.d)); }
  function diffDays(a,b){ return Math.floor((dateUTC(a) - dateUTC(b))/DAY); } // a - b בימים
  function fmtYMD(ymd){ return `${String(ymd.d).padStart(2,'0')}/${String(ymd.m).padStart(2,'0')}/${ymd.y}`; }

  // ספים: 3 חודשים ≈ 90 ימים | חצי שנה ≈ 183 ימים
  const THRESH_3M = 90, THRESH_6M = 183;

  // מודאל כללי (ממחזר את זה שיש אם כבר הוגדר במקום אחר)
  function ensureModal(){
    if (document.getElementById('biModal')) return;
    const html = `<div id="biModal" class="fixed inset-0 z-[1000] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div id="biModalTitle" class="text-lg font-bold">נתונים</div>
          <button id="biExport" class="ms-auto text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">ייצוא</button>
          <button id="biClose"  class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
        </div>
        <div class="p-4 overflow-auto" style="max-height:70vh">
          <table class="w-full text-sm border-separate border-spacing-0">
            <thead id="biThead"></thead><tbody id="biTbody"></tbody>
          </table>
          <div id="biEmpty" class="hidden text-ink-200/70 text-sm p-4">אין נתונים.</div>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.getElementById('biClose').onclick=()=>document.getElementById('biModal').classList.add('hidden');
    document.getElementById('biModal').onclick=e=>{ if(e.target.id==='biModal') e.currentTarget.classList.add('hidden'); };
    document.getElementById('biExport').onclick=()=>{
      if(!window.XLSX) return alert('XLSX לא נטענה');
      const ws=XLSX.utils.json_to_sheet(window.__BI_MODAL_ROWS__||[]);
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Data');
      const fn=(document.getElementById('biModalTitle').dataset.filename||'export')+'.xlsx';
      XLSX.writeFile(wb,fn);
    };
  }
  function renderTable(rows){
    const H=document.getElementById('biThead'), B=document.getElementById('biTbody'), E=document.getElementById('biEmpty');
    window.__BI_MODAL_ROWS__ = rows;
    if(!rows.length){ H.innerHTML=''; B.innerHTML=''; E.classList.remove('hidden'); return; }
    E.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))].filter(k=>!k.startsWith('__'));
    const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    H.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${esc(h)}</th>`).join('')+'</tr>';
    B.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2 border-b border-white/5">${esc(r[h])}</td>`).join('')+'</tr>').join('');
  }
  function openModal(rows, title, file){
    ensureModal(); renderTable(rows);
    const t=document.getElementById('biModalTitle'); t.textContent=title; t.dataset.filename=file;
    document.getElementById('biModal').classList.remove('hidden');
  }

  // חישוב קבוצות
  function annotate(row){
    const k = findCol(row, COLS.openedAt);
    const openYMD = k ? ymdFromCell(row[k]) : null;
    if (!openYMD) return { ...row, __ageDays: null };
    const today = ymdFromDateTZ(new Date());
    const age = diffDays(today, openYMD);
    return { ...row, 'תאריך פתיחה (תאריך בלבד)': fmtYMD(openYMD), 'גיל (ימים)': age, __ageDays: age };
  }

  function compute(){
    const base = getDataset().filter(isOpenRow).map(annotate).filter(r => r.__ageDays != null);

    // כללי
    const allOver3 = base.filter(r => r.__ageDays > THRESH_3M);
    const allOver6 = base.filter(r => r.__ageDays > THRESH_6M);

    // לפי מחלקה
    const dept = activeDept();
    $('deptTitleAging').textContent = `מחלקה: ${dept}`;
    let deptRows = base;
    if (dept !== 'כללי'){
      const dk = findCol(base[0]||{}, COLS.dept);
      deptRows = dk ? base.filter(r => String(r[dk] ?? '').trim() === dept) : [];
    }
    const dOver3 = deptRows.filter(r => r.__ageDays > THRESH_3M);
    const dOver6 = deptRows.filter(r => r.__ageDays > THRESH_6M);

    const fmt = n => n.toLocaleString('he-IL');
    const bind = (id, rows, title, file) => {
      const el = $(id); if (!el) return;
      el.textContent = fmt(rows.length);
      el.classList.add('cursor-pointer','underline','underline-offset-4','decoration-white/30');
      el.onclick = () => openModal(rows, title, file);
    };

    bind('kpiAllOver3m', allOver3, 'פתוחות מעל 3 חודשים — כללי', 'over_3m_all');
    bind('kpiAllOver6m', allOver6, 'פתוחות מעל חצי שנה — כללי', 'over_6m_all');
    bind('kpiDeptOver3m', dOver3,  `פתוחות מעל 3 חודשים — ${dept}`, 'over_3m_dept');
    bind('kpiDeptOver6m', dOver6,  `פתוחות מעל חצי שנה — ${dept}`,  'over_6m_dept');
  }

  if (typeof window.updateSuccessUI === 'function'){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){ const r = prev.apply(this, arguments); Promise.resolve(r).finally(compute); };
  }
  window.addEventListener('bi:dept-change', compute);
  if (getDataset().length) compute();
})();
</script>
  <!-- === FIX: Export to XLSX Patch === -->
<script>
(() => {
  // עוטפים את הפונקציה הגלובלית שלנו לכתיבה לקובץ
  if (window.XLSX && XLSX.writeFile) {
    const orig = XLSX.writeFile;
    XLSX.writeFile = function(wb, filename, opts) {
      if (typeof filename === 'string' && !filename.endsWith('.xlsx')) {
        filename = filename.replace(/\.[^/.]+$/, '') + '.xlsx';
      }
      return orig.call(this, wb, filename, opts);
    };
  }
})();
</script> 
  <!-- ==== STEP 11-PRO: דשבורד מתקדם (חלון חדש) ==== -->
<script>
(function(){
  const TZ='Asia/Jerusalem', DAY=24*60*60*1000;
  const HEB=/[\u0591-\u05C7]/g, norm=s=>String(s||'').replace(HEB,'').replace(/\s+/g,'').toLowerCase();
  const CLOSED=['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  const $=id=>document.getElementById(id);

  // טוען ספריות אם צריך
  async function ensureScript(src){ return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);}); }
  async function ensureDeps(){
    if(!window.Chart) await ensureScript('https://cdn.jsdelivr.net/npm/chart.js');
    if(!window.ChartDataLabels) await ensureScript('https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2');
    if(!window.html2canvas) await ensureScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
  }

  // כפתור לפתיחת החלון
  if(!$('biDashProOpen')){
    const b=document.createElement('button');
    b.id='biDashProOpen';
    b.type='button';
    b.textContent='דשבורד מתקדם';
    b.className='fixed bottom-16 left-4 z-[1900] px-4 py-2 rounded-full bg-gradient-to-r from-brand-600 to-gold-500 text-white font-semibold shadow-lg hover:opacity-90';
    document.body.appendChild(b);
    b.addEventListener('click', async()=>{ await ensureDeps(); openPro(); });
  }

  // חלון הדשבורד המתקדם
  if(!$('biDashPro')){
    const html=`
    <div id="biDashPro" class="fixed inset-0 z-[2100] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-6 max-w-7xl w-[96%] rounded-3xl bg-[#0b1220] border border-white/10 shadow-luxe">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div class="text-lg font-bold">דשבורד מתקדם — לוח מחוונים</div>
          <div class="ms-auto flex items-center gap-2">
            <label class="text-xs text-ink-200/70">מחלקה:</label>
            <select id="biDashProDept" class="text-sm bg-white/10 border border-white/20 rounded-full px-3 py-1.5">
              <option value="__ACTIVE__">מהטאב הפעיל</option>
              <option value="כללי">כללי</option>
            </select>
            <button id="biDashProExport" class="text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-brand-600 to-gold-500">הורד תמונה</button>
            <button id="biDashProClose" class="text-xs px-3 py-1.5 rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
        </div>
        <div id="biDashProBody" class="p-5 space-y-6 overflow-y-auto" style="max-height:78vh">
          <!-- KPI -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4 text-center">
              <div class="text-xs text-ink-200/70">סה״כ פתוחות</div><div id="proKpiOpen" class="text-3xl font-bold mt-1">—</div>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4 text-center">
              <div class="text-xs text-ink-200/70">נפתחו היום</div><div id="proKpiToday" class="text-3xl font-bold mt-1">—</div>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4 text-center">
              <div class="text-xs text-ink-200/70">נפתחו אתמול</div><div id="proKpiYest" class="text-3xl font-bold mt-1">—</div>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4 text-center">
              <div class="text-xs text-ink-200/70">מס׳ מחלקות</div><div id="proKpiDepts" class="text-3xl font-bold mt-1">—</div>
            </div>
          </div>

          <!-- גרפים -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
              <div class="text-sm text-ink-200/80 mb-2">מקור פניה — פתוחות (מתעדכן לפי מחלקה)</div>
              <canvas id="proSrcPie" height="220"></canvas>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
              <div class="text-sm text-ink-200/80 mb-2">פתיחות 30 הימים האחרונים</div>
              <canvas id="proOpenLine" height="220"></canvas>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
              <div class="text-sm text-ink-200/80 mb-2">ערים מובילות (100+)</div>
              <canvas id="proCityBar" height="230"></canvas>
            </div>
            <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
              <div class="text-sm text-ink-200/80 mb-2">יחידות דואר מובילות (100+)</div>
              <canvas id="proUnitBar" height="230"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    $('biDashProClose').addEventListener('click', ()=>$('biDashPro').classList.add('hidden'));
    $('biDashPro').addEventListener('click', e=>{ if(e.target.id==='biDashPro') $('biDashPro').classList.add('hidden'); });
    $('biDashProExport').addEventListener('click', async ()=>{
      const box=$('biDashProBody').parentElement;
      const c=await html2canvas(box,{backgroundColor:'#0b1220',scale:2});
      const a=document.createElement('a'); a.download='dashboard_pro.png'; a.href=c.toDataURL('image/png'); a.click();
    });
  }

  // עזרי נתונים
  const COLS={
    openedAt:['שעת/תאריך פתיחה ','שעת/תאריך פתיחה','תאריך/שעת פתיחה','תאריך פתיחה','opened_at','date_opened'],
    source:['מקור פניה','מקור הפניה','מקור הפנייה','source','referral'],
    status:['סטאטוס פניה','סטטוס פניה','סטאטוס','status'],
    dept:['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    city:['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'],
    unit:['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'],
  };
  function findCol(row, keys){
    if (!row) return null;
    for (const k of keys) if (k in row) return k;
    const t=keys.map(norm); for (const k in row) if (t.includes(norm(k))) return k;
    return null;
  }
  function toPartsYMD(date){
    const p=new Intl.DateTimeFormat('he-IL',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
    const m=Object.fromEntries(p.map(x=>[x.type,x.value])); return {y:+m.year,m:+m.month,d:+m.day};
  }
  const ymd=p=>`${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`;
  const todayKey=()=>ymd(toPartsYMD(new Date()));
  const yesterdayKey=()=>{const t=toPartsYMD(new Date()); const d=new Date(Date.UTC(t.y,t.m-1,t.d)-DAY); return ymd(toPartsYMD(d));};
  function normalizeDateOnly(cell){
    if (cell==null||cell==='') return null;
    if (typeof cell==='number'){ const epoch=new Date(Date.UTC(1899,11,30)); const d=new Date(epoch.getTime()+Math.floor(cell)*DAY); return ymd(toPartsYMD(d)); }
    const s=String(cell), m=s.match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if (m){ let[_,dd,mm,yy]=m; if(yy.length===2) yy='20'+yy; const d=new Date(`${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T00:00:00`); return ymd(toPartsYMD(d)); }
    const d=new Date(s); if(!isNaN(d)) return ymd(toPartsYMD(d)); return null;
  }
  const isOpenRow=r=>{const k=findCol(r,COLS.status); if(!k) return true; const v=String(r[k]??'').trim(); return !CLOSED.some(c=>v===c||v.includes(c));};

  // רנדררים עם DataLabels (מספרים + אחוזים)
  function pieWithLabels(ctx, labels, data, total){
    return new Chart(ctx,{type:'pie',plugins:[ChartDataLabels],
      data:{labels,datasets:[{data}]},
      options:{plugins:{legend:{labels:{color:'#cbd5e1'}},
        datalabels:{color:'#fff',formatter:v=>`${v}\n${total?Math.round(v*100/total):0}%`,font:{weight:'600'}}}}});
  }
  function barWithLabels(ctx, labels, data, total){
    return new Chart(ctx,{type:'bar',plugins:[ChartDataLabels],
      data:{labels,datasets:[{data}]},
      options:{plugins:{legend:{display:false},
        datalabels:{anchor:'end',align:'end',color:'#fff',formatter:v=>`${v} (${total?Math.round(v*100/total):0}%)`}},
        scales:{x:{ticks:{color:'#cbd5e1'}},y:{ticks:{color:'#cbd5e1'}}}}});
  }
  function lineBasic(ctx, labels, data){
    return new Chart(ctx,{type:'line',
      data:{labels,datasets:[{data,fill:false,tension:.25}]},
      options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#cbd5e1'}},y:{ticks:{color:'#cbd5e1'}}}}});
  }

  async function ensureDataset(){
    if (Array.isArray(window.__dataset) && window.__dataset.length) return window.__dataset;
    if (!window.__lastFile || !window.XLSX) return [];
    try{
      const buf=await window.__lastFile.arrayBuffer();
      const wb=XLSX.read(buf,{type:'array'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      window.__dataset=XLSX.utils.sheet_to_json(sheet,{defval:null});
      return window.__dataset;
    }catch(e){ console.warn('ensureDataset failed',e); return []; }
  }

  // פתיחה + רענון
  async function openPro(){
    // מילוי מחלקות בסלקט (פעם ראשונה)
    const data=(await ensureDataset()).filter(isOpenRow);
    const dk=findCol(data[0],COLS.dept);
    const sel=$('biDashProDept');
    if (dk && sel && !sel.dataset.filled){
      const set=new Set(); data.forEach(r=>{const v=String(r[dk]??'').trim(); if(v) set.add(v);});
      [...set].forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o); });
      sel.dataset.filled='1';
    }
    $('biDashPro').classList.remove('hidden');
    renderPro();
  }

  // רנדר הדשבורד המתקדם
  async function renderPro(){
    const body=$('biDashProBody'); if(!body) return;
    const raw=await ensureDataset();
    if (!raw.length){ body.innerHTML='<div class="text-sm text-ink-200/70">לא נטענו נתונים. טעני קובץ XLSX.</div>'; return; }

    // סינון פתוחות
    let rows=raw.filter(isOpenRow);

    // סינון לפי מחלקה
    const sel=$('biDashProDept');
    const activeDept = (sel?.value==='__ACTIVE__' ? (window.__biActiveDept||'כללי') : sel?.value)||'כללי';
    const dk=findCol(rows[0],COLS.dept);
    if (activeDept!=='כללי' && dk) rows=rows.filter(r=>String(r[dk]??'').trim()===activeDept);

    // עמודות
    const openedCol=findCol(rows[0],COLS.openedAt);
    const sourceCol=findCol(rows[0],COLS.source);
    const cityCol=findCol(rows[0],COLS.city);
    const unitCol=findCol(rows[0],COLS.unit);

    // KPI
    const tKey=todayKey(), yKey=yesterdayKey();
    const dateKeyOf=r=>openedCol?normalizeDateOnly(r[openedCol]):null;
    const todayRows = openedCol? rows.filter(r=>dateKeyOf(r)===tKey):[];
    const yestRows  = openedCol? rows.filter(r=>dateKeyOf(r)===yKey):[];
    const deptCount = dk ? new Set(rows.map(r=>String(r[dk]??'').trim()).filter(Boolean)).size : 1;

    $('proKpiOpen').textContent   = rows.length.toLocaleString('he-IL');
    $('proKpiToday').textContent  = todayRows.length.toLocaleString('he-IL');
    $('proKpiYest').textContent   = yestRows.length.toLocaleString('he-IL');
    $('proKpiDepts').textContent  = deptCount.toLocaleString('he-IL');

    // השמד גרפים קודמים
    (window.__BI_DASH_PRO__||[]).forEach(c=>{try{c.destroy()}catch{}});
    window.__BI_DASH_PRO__=[];

    // מקור פניה – עוגה (מספרים + אחוזים)
    if (sourceCol){
      const m=new Map(); rows.forEach(r=>{const v=String(r[sourceCol]??'(ללא)').trim()||'(ללא)'; m.set(v,(m.get(v)||0)+1);});
      const list=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
      const c=pieWithLabels($('proSrcPie').getContext('2d'), list.map(x=>x[0]), list.map(x=>x[1]), rows.length);
      window.__BI_DASH_PRO__.push(c);
    } else {
      $('proSrcPie').parentElement.innerHTML='<div class="text-xs text-ink-200/70">לא נמצאה עמודת "מקור פניה".</div>';
    }

    // פתיחות 30 יום
    if (openedCol){
      const map=new Map();
      for(let i=29;i>=0;i--){ const d=new Date(Date.now()-i*DAY); map.set(ymd(toPartsYMD(d)),0); }
      rows.forEach(r=>{ const k=dateKeyOf(r); if (map.has(k)) map.set(k, map.get(k)+1); });
      const labels=[...map.keys()], data=[...map.values()];
      const c=lineBasic($('proOpenLine').getContext('2d'), labels, data);
      window.__BI_DASH_PRO__.push(c);
    } else {
      $('proOpenLine').parentElement.innerHTML='<div class="text-xs text-ink-200/70">לא נמצאה עמודת "שעת/תאריך פתיחה".</div>';
    }

    // ערים/יחידות (100+) – עמודות עם מספר + אחוז
    function topBar(col, canvasId, title){
      if (!col){ $(canvasId).parentElement.innerHTML=`<div class="text-xs text-ink-200/70">לא נמצאה עמודת ${title}.</div>`; return; }
      const m=new Map(); rows.forEach(r=>{const v=String(r[col]??'').trim(); if(!v) return; m.set(v,(m.get(v)||0)+1);});
      const arr=[...m.entries()].filter(([,c])=>c>=100).sort((a,b)=>b[1]-a[1]).slice(0,12);
      if (!arr.length){ $(canvasId).parentElement.innerHTML='<div class="text-xs text-ink-200/70">אין ערכים מעל 100.</div>'; return; }
      const total=arr.reduce((s,[,c])=>s+c,0);
      const c=barWithLabels($(canvasId).getContext('2d'), arr.map(x=>x[0]), arr.map(x=>x[1]), total);
      window.__BI_DASH_PRO__.push(c);
    }
    topBar(cityCol,'proCityBar','"עיר"');
    topBar(unitCol,'proUnitBar','"יחידת דואר: שם"');
  }

  // האזנות
  $('biDashProDept')?.addEventListener('change', renderPro);
  document.addEventListener('bi:data-loaded', ()=>{ if(!$('biDashPro').classList.contains('hidden')) renderPro(); });

  // אם יש updateSuccessUI – נדליק אירוע אחרי טעינת קובץ
  if (typeof window.updateSuccessUI==='function' && !window.__BI_DASH_PRO_WRAP){
    const prev=window.updateSuccessUI;
    window.updateSuccessUI=function(){ const r=prev.apply(this,arguments); Promise.resolve(r).then(()=>document.dispatchEvent(new Event('bi:data-loaded'))); };
    window.__BI_DASH_PRO_WRAP=true;
  }

})();
  </script>
  <!-- ==== XLSX Export Fix (robust, with stable headers & table fallback) ==== -->
<script>
(function(){
  if (!window.XLSX) { console.warn('XLSX not loaded'); return; }

  // איסוף כל הכותרות מכל השורות, לפי סדר הופעה יציב
  function collectHeaders(rows){
    const seen = new Set(); const headers = [];
    rows.forEach(r=>{
      Object.keys(r||{}).forEach(k=>{
        if(!seen.has(k)){ seen.add(k); headers.push(k); }
      });
    });
    return headers;
  }

  // המרה בטוחה של שורות -> Worksheet (כולל כותרות)
  function rowsToWorksheet(rows){
    const headers = collectHeaders(rows);
    if (!headers.length) return XLSX.utils.aoa_to_sheet([['(אין כותרות)','']]);

    // בניית AOA: שורה ראשונה כותרות, אח"כ נתונים
    const aoa = [headers];
    rows.forEach(r=>{
      const line = headers.map(h=>{
        let v = (r && r[h] != null) ? r[h] : '';
        // תאריכים: אם זה אובייקט Date – נהפוך לטקסט קריא (שקל לפתוח באקסל)
        if (v instanceof Date && !isNaN(v)) {
          try {
            // dd/mm/yyyy hh:mm
            const d = new Intl.DateTimeFormat('he-IL', {year:'numeric',month:'2-digit',day:'2-digit',
              hour:'2-digit',minute:'2-digit'}).format(v);
            v = d.replace(',', '');
          } catch(_) {}
        }
        return v;
      });
      aoa.push(line);
    });

    const ws = XLSX.utils.aoa_to_sheet(aoa);

    // רוחבי עמודות אוטומטיים בסיסיים
    const colWidths = headers.map((h,i)=>{
      const maxLen = Math.max(
        String(h).length,
        ...rows.map(r => String((r && r[h] != null) ? r[h] : '').length)
      );
      return { wch: Math.min(Math.max(8, maxLen + 2), 60) };
    });
    ws['!cols'] = colWidths;

    return ws;
  }

  // קריאת נתונים מהטבלה במסך אם אין __BI_CURRENT_ROWS
  function tableToRows(){
    const table = document.getElementById('biTable');
    if (!table) return null;
    const ths = [...(table.querySelectorAll('thead th')||[])].map(th=>th.textContent.trim());
    const trs = [...(table.querySelectorAll('tbody tr')||[])];
    if (!ths.length || !trs.length) return null;
    return trs.map(tr=>{
      const tds = [...tr.querySelectorAll('td')];
      const obj = {};
      ths.forEach((h,idx)=>{ obj[h] = (tds[idx]?.textContent||'').trim(); });
      return obj;
    });
  }

  // הורדה בפועל
  function downloadXLSX(rows, filename){
    if (!Array.isArray(rows) || !rows.length){
      alert('אין נתונים לייצוא.');
      return;
    }
    const ws = rowsToWorksheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    // כתיבה כ-.xlsx אמיתי (לא .bin), עם דחיסה
    XLSX.writeFile(wb, filename || 'export.xlsx', { bookType:'xlsx', compression:true });
  }

  // API גלובלי (עוקף ישן): window.exportXLSX(rows, name)
  window.exportXLSX = function(rows, name){
    const src = Array.isArray(rows) && rows.length ? rows
              : (Array.isArray(window.__BI_CURRENT_ROWS) && window.__BI_CURRENT_ROWS.length ? window.__BI_CURRENT_ROWS
              : tableToRows());
    const fn = name || (document.getElementById('biModalTitle')?.dataset?.filename) || 'export.xlsx';
    downloadXLSX(src || [], fn);
  };

  // חיבור אוטומטי לכפתור במודאל אם קיים
  document.addEventListener('click', (e)=>{
    const id = e.target?.id || '';
    if (id === 'biExportBtn' || e.target?.closest('#biExportBtn')){
      e.preventDefault();
      window.exportXLSX();
    }
    // תמיכה גם בכל אלמנט עם data-export-xlsx
    if (e.target?.closest('[data-export-xlsx]')){
      e.preventDefault();
      window.exportXLSX();
    }
  });

  console.log('XLSX Export Fix loaded');
})();
</script>
  <!-- === Quick Fix: Ensure XLSX + File Upload + Dataset + Insights Button === -->
<script>
(function(){
  // -------- 1) Ensure SheetJS (XLSX) is loaded, with fallback --------
  function ensureXLSX(){
    return new Promise((resolve)=>{
      if (window.XLSX) return resolve(true);
      // נסה לטעון CDN חלופי
      const s=document.createElement('script');
      s.src="https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js";
      s.onload=()=>resolve(!!window.XLSX);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
  }

  // -------- 2) Uploader re-bind (file input + drag&drop) --------
  async function bindUploader(){
    const fileInput=document.getElementById('fileInput');
    const dropzone =document.getElementById('dropzone');
    if (!fileInput && !dropzone) return;

    async function parseFile(file){
      if (!file) return;
      const ok=await ensureXLSX();
      if (!ok){ alert('טעינת ספריית XLSX נכשלה. בדקי חיבור אינטרנט ונסי שוב.'); return; }
      try{
        // UI: אם קיימות פונקציות מצב קיים, נשתמש; אחרת נציג הודעת ברירת מחדל
        const setLoading=window.setLoadingState||(()=>{});
        const onSuccess=window.updateSuccessUI||((name,rows)=>console.log('Loaded:',name,rows));
        const onError  =window.updateErrorUI||((msg)=>alert(msg||'שגיאה בקריאת הקובץ'));

        setLoading(true);
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const first=wb.SheetNames && wb.SheetNames[0];
        if (!first){ onError('לא נמצאו גיליונות בקובץ.'); setLoading(false); return; }
        const sheet=wb.Sheets[first];
        const json =XLSX.utils.sheet_to_json(sheet,{defval:null});

        if (!Array.isArray(json) || !json.length){
          onError('הקובץ ריק או כותרות העמודות לא זוהו.');
        }else{
          // נשמור גלובלית, נעדכן UI, ונשדר אירוע לכל המודולים
          window.__dataset=json;
          window.__lastFile=file;
          onSuccess(file.name, json.length);
          document.dispatchEvent(new CustomEvent('bi:data-loaded',{detail:{rows:json.length,file:file.name}}));
        }
        setLoading(false);
      }catch(err){
        console.error(err);
        (window.updateErrorUI||alert)('שגיאה בקריאת הקובץ. נסי לשמור מחדש כ־XLSX.');
      }
    }

    // קישור file input
    if (fileInput && !fileInput.dataset.bound){
      fileInput.addEventListener('change', (e)=>{
        const f=e.target.files && e.target.files[0];
        if (f) parseFile(f);
      });
      fileInput.dataset.bound='1';
    }
    // קישור Drag & Drop
    if (dropzone && !dropzone.dataset.bound){
      // הפיכת הקופסה ללחיצה לפתיחת קובץ
      dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
      ['dragenter','dragover'].forEach(evt=>{
        dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); });
      });
      ['dragleave','drop'].forEach(evt=>{
        dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); });
      });
      dropzone.addEventListener('drop', (e)=>{
        const f=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) parseFile(f);
      });
      dropzone.dataset.bound='1';
    }
  }

  // -------- 4) Hook: אם יש כבר __lastFile אבל __dataset לא קיים, נטען כעת --------
  async function recoverLastFile(){
    if (window.__dataset && Array.isArray(window.__dataset) && window.__dataset.length) return;
    if (!window.__lastFile) return;
    const ok=await ensureXLSX();
    if (!ok) return;
    try{
      const buf=await window.__lastFile.arrayBuffer();
      const wb=XLSX.read(buf,{type:'array'});
      const first=wb.SheetNames && wb.SheetNames[0];
      if (!first) return;
      const sheet=wb.Sheets[first];
      const json=XLSX.utils.sheet_to_json(sheet,{defval:null});
      if (json && json.length){
        window.__dataset=json;
        document.dispatchEvent(new CustomEvent('bi:data-loaded',{detail:{rows:json.length,file:window.__lastFile.name}}));
      }
    }catch(e){ console.warn('recoverLastFile failed', e); }
  }

  // -------- 5) Init now --------
  ensureXLSX().then(bindUploader).then(recoverLastFile);
  ensureInsightsButton();

  // -------- 6) עזרה לאיתור תקלות --------
  // אם אין כפתור/אין XLSX—נוסיף הודעת דיאגנוסטיקה קצרה בקונסול
  window.addEventListener('load', ()=>{
    if (!window.XLSX) console.warn('[BI Fix] XLSX לא נטען. יתכן חסימת CDN. נוסה CDN חלופי.');
    if (!document.getElementById('fileInput')) console.warn('[BI Fix] לא נמצא #fileInput בדף.');
    if (!document.getElementById('dropzone')) console.warn('[BI Fix] לא נמצא #dropzone בדף.');
    if (!document.getElementById('biInsightsBtn')) console.warn('[BI Fix] כפתור תובנות לא נוצר.');
  });
})();
</script>
    <!-- === BI: Uploader+XLSX Fix + Insights Modal (ONE BLOCK) === -->
<script>
(function(){
  /* =========================
   * 1) Ensure XLSX + Uploader
   * ========================= */
  const DAY=24*60*60*1000;

  function ensureXLSX(){
    return new Promise((resolve)=>{
      if (window.XLSX) return resolve(true);
      const s=document.createElement('script');
      // CDN חלופי אמין
      s.src="https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js";
      s.onload=()=>resolve(!!window.XLSX);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
  }

  async function parseFile(file){
    if (!file) return;
    const ok=await ensureXLSX();
    if (!ok){ alert('טעינת ספריית XLSX נכשלה.'); return; }
    try{
      (window.setLoadingState||(()=>{}))(true);
      const buf=await file.arrayBuffer();
      const wb=XLSX.read(buf,{type:'array'});
      const first=wb.SheetNames && wb.SheetNames[0];
      if (!first){ (window.updateErrorUI||alert)('לא נמצאו גיליונות בקובץ.'); return; }
      const sheet=wb.Sheets[first];
      const json =XLSX.utils.sheet_to_json(sheet,{defval:null});
      if (!json.length){ (window.updateErrorUI||alert)('הקובץ ריק או כותרות לא זוהו.'); return; }

      window.__dataset=json;
      window.__lastFile=file;
      (window.updateSuccessUI||(()=>{}))(file.name, json.length);
      document.dispatchEvent(new CustomEvent('bi:data-loaded',{detail:{rows:json.length,file:file.name}}));
    }catch(e){
      console.error(e);
      (window.updateErrorUI||alert)('שגיאה בקריאת הקובץ.');
    }finally{
      (window.setLoadingState||(()=>{}))(false);
    }
  }

  function bindUploader(){
    const fileInput=document.getElementById('fileInput');
    const dropzone =document.getElementById('dropzone');

    if (fileInput && !fileInput.dataset.bound){
      fileInput.addEventListener('change', e=>{
        const f=e.target.files && e.target.files[0];
        if (f) parseFile(f);
      });
      fileInput.dataset.bound='1';
    }
    if (dropzone && !dropzone.dataset.bound){
      dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
      ['dragenter','dragover'].forEach(evt=>{
        dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); });
      });
      ['dragleave','drop'].forEach(evt=>{
        dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); });
      });
      dropzone.addEventListener('drop', e=>{
        const f=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) parseFile(f);
      });
      dropzone.dataset.bound='1';
    }
  }

  // פונקציית ייצוא גלובלית אם חסרה
  if (typeof window.exportXLSX!=='function'){
    window.exportXLSX=function(rows, filename='export.xlsx'){
      if (!window.XLSX){ alert('XLSX לא טעון'); return; }
      const ws=XLSX.utils.json_to_sheet(rows||[]);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Data');
      XLSX.writeFile(wb, filename);
    };
  }

  // Init uploader + נסיון לשחזר קובץ אחרון
  ensureXLSX().then(bindUploader).then(async ()=>{
    if (!window.__dataset && window.__lastFile){
      try{
        const buf=await window.__lastFile.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        window.__dataset=XLSX.utils.sheet_to_json(sheet,{defval:null});
        if (window.__dataset?.length){
          document.dispatchEvent(new CustomEvent('bi:data-loaded',{detail:{rows:window.__dataset.length,file:window.__lastFile.name}}));
        }
      }catch(e){/* ignore */}
    }
  });
  <script>
/* --- PATCH שלב 3: 50+ פניות + כיבוד מחלקה מטפלת --- */
(() => {
  const MIN_COUNT = 50; // במקום 100
  const HEB_DIACRITICS=/[\u0591-\u05C7]/g;
  const normHeader=s=>String(s).replace(HEB_DIACRITICS,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();

  // התאמות עמודות גמישות
  const CITY_EXACT=['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'];
  const CITY_KW   =[['עיר'],['יישוב']];
  const UNIT_EXACT=['יחידת דואר: שם','יחידת דואר שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה'];
  const UNIT_KW   =[['יחידת','דואר','שם'],['שם','יחידה']];
  const STATUS_CAND=['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];
  const DEPT_CAND  =['מחלקה מטפלת','מחלקה','מחלקה מטפלת '];

  function headerIncludesAll(col, kwSet){ const n=normHeader(col); return kwSet.every(k=>n.includes(normHeader(k))); }
  function findColumnFlexible(row0, exactList, keywordSets){
    if (!row0) return null;
    const headers=Object.keys(row0);
    for (const h of headers){
      if (exactList.includes(h)) return h;
      const hN=normHeader(h); for(const ex of exactList){ if(hN===normHeader(ex)) return h; }
    }
    for (const h of headers){ if (keywordSets.some(set=>headerIncludesAll(h,set))) return h; }
    return null;
  }
  function findCol(row,cands){
    if (!row) return null;
    for (const c of cands) if (c in row) return c;
    const target=cands.map(normHeader);
    for (const k in row) if (target.includes(normHeader(k))) return k;
    return null;
  }

  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  function isOpenRow(row){
    const k=findCol(row,STATUS_CAND);
    if (!k) return true;
    const v=String(row[k]??'').trim();
    return !CLOSED.some(c=>v===c||v.includes(c));
  }

  // כיבוד הטאב הפעיל של מחלקה מטפלת
  function getActiveDept(){
    const tabs=document.getElementById('deptTabs');
    if (!tabs) return 'כללי';
    const active=[...tabs.querySelectorAll('button')].find(b => b.className.includes('from-brand-600') || b.className.includes('bg-gradient-to-r'));
    return (active?.textContent||'כללי').trim();
  }
  function scopeRowsByDept(rows){
    const dept=getActiveDept();
    if (dept==='כללי') return rows;
    const key = rows.length ? findCol(rows[0], DEPT_CAND) : null;
    if (!key) return rows;
    return rows.filter(r=>String(r[key]??'').trim()===dept);
  }

  function aggregateCounts(rows, which){
    rows = scopeRowsByDept(rows).filter(isOpenRow);
    if (!rows.length) return { col:null, items:[] };

    let col=null;
    if (which==='city') col=findColumnFlexible(rows[0], CITY_EXACT, CITY_KW);
    else if (which==='unit') col=findColumnFlexible(rows[0], UNIT_EXACT, UNIT_KW);
    if (!col) return { col:null, items:[] };

    const map=new Map();
    for (const r of rows){
      const key=(r[col]==null?'':String(r[col]).trim());
      if (!key) continue;
      map.set(key, (map.get(key)||0)+1);
    }
    const items=[...map.entries()]
      .filter(([,c])=>c>=MIN_COUNT) // ← עכשיו 50+
      .sort((a,b)=>b[1]-a[1])
      .map(([name,count])=>({name,count}));
    return { col, items };
  }

  function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function renderList(containerId, items){
    const el=document.getElementById(containerId); if (!el) return;
    el.innerHTML='';
    items.forEach(it=>{
      const row=document.createElement('div');
      row.className='py-2 flex items-center gap-3';
      row.innerHTML = `
        <span class="text-ink-50/90">${escapeHTML(it.name)}</span>
        <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10 font-semibold">${it.count.toLocaleString('he-IL')} פניות</span>
      `;
      el.appendChild(row);
    });
  }

  async function ensureDataset(){
    if (Array.isArray(window.__dataset) && window.__dataset.length) return true;
    return false;
  }

  async function renderStep3Patched(){
    if (!await ensureDataset()) return;
    const rows = window.__dataset || [];
    const byCity = aggregateCounts(rows, 'city');
    const byUnit = aggregateCounts(rows, 'unit');

    renderList('listByCity', byCity.items);
    renderList('listByUnit', byUnit.items);

    const msgCity=document.getElementById('msgCity');
    const msgUnit=document.getElementById('msgUnit');
    if (msgCity) msgCity.textContent = (!byCity.col) ? 'לא נמצאה עמודת עיר/יישוב.' : (!byCity.items.length ? `אין ערים עם לפחות ${MIN_COUNT} פניות פתוחות.` : '');
    if (msgUnit) msgUnit.textContent = (!byUnit.col) ? 'לא נמצאה עמודת "יחידת דואר: שם".' : (!byUnit.items.length ? `אין יחידות עם לפחות ${MIN_COUNT} פניות פתוחות.` : '');
  }

  // מרנדר אחרי קליטת קובץ
  if (typeof window.updateSuccessUI === 'function' && !window.__STEP3_PATCHED){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){
      prev.apply(this, arguments);
      setTimeout(renderStep3Patched, 0);
    };
    window.__STEP3_PATCHED = true;
  }

  // מרנדר גם בשינוי טאב של מחלקה
  const tabs=document.getElementById('deptTabs');
  if (tabs && !tabs.dataset.step3watch){
    tabs.addEventListener('click', e=>{
      if (e.target.tagName==='BUTTON') setTimeout(renderStep3Patched, 0);
    });
    tabs.dataset.step3watch = '1';
  }

  // ניסיון ראשוני אם יש נתונים
  setTimeout(renderStep3Patched, 200);
})();
  </script>
  <script>
function renderInsights(){
  ensureInsightsModal();

  const openOnly = document.getElementById('insOpenOnly').checked;
  const rowsAll  = Array.isArray(window.__dataset)? window.__dataset : [];
  if (!rowsAll.length) return;

  let rows = scopeByDept(rowsAll);
  if (openOnly) rows = rows.filter(isOpenRow);

  const r0 = rows[0] || {};
  const cityCol  = findCol(r0, COL.city);
  const unitCol  = findCol(r0, COL.dept); // יחידה = מחלקה מטפלת
  const subjCol  = findCol(r0, COL.subj);
  const probCol  = findCol(r0, COL.prob);
  const prodCol  = findCol(r0, COL.prod);

  // --- בחירת Scope ---
  const scopeSel = document.getElementById('insScope');
  if (!scopeSel.innerHTML){
    scopeSel.innerHTML = `
      <option value="all">(כללי)</option>
      <option value="city">לפי עיר</option>
      <option value="unit">לפי יחידה</option>`;
    scopeSel.value = "all";
    scopeSel.onchange = () => renderInsights();
  }

  let scopeKey = null;
  if (scopeSel.value==="city") scopeKey=cityCol;
  if (scopeSel.value==="unit") scopeKey=unitCol;

  let mapScope=new Map();
  if (scopeKey){
    rows.forEach(r=>{
      const k=(r[scopeKey]??'').toString().trim();
      if (!k) return;
      mapScope.set(k,(mapScope.get(k)||0)+1);
    });
  }

  // populate value select
  const valSel=document.getElementById('insValue');
  valSel.innerHTML='';
  if (scopeKey){
    [...mapScope.entries()]
      .sort((a,b)=>b[1]-a[1])
      .forEach(([name,c])=>{
        const opt=document.createElement('option');
        opt.value=name; opt.textContent=`${name} — ${c.toLocaleString('he-IL')}`;
        valSel.appendChild(opt);
      });
    if(!valSel.value && valSel.options.length) valSel.selectedIndex=0;
  }
  valSel.onchange=()=>renderInsights();

  // --- רשומות נבחרות ---
  let chosenRows=rows;
  let chosenLabel="כללי";
  if (scopeKey && valSel.value){
    chosenRows=rows.filter(r=>String(r[scopeKey]||'').trim()===valSel.value);
    chosenLabel=valSel.value;
  }

  // כותרת
  document.getElementById('insCityName').textContent=chosenLabel;
  document.getElementById('insCityTotal').textContent=chosenRows.length+" פניות";

  // ניתוח
  renderTopList('insCitySubject', chosenRows, subjCol);
  renderTopList('insCityProblem', chosenRows, probCol);

  const topSubj=topKey(chosenRows, subjCol);
  const topProb=topKey(chosenRows, probCol);
  document.getElementById('insCityHypo').innerHTML=buildHypothesisBlock(topSubj, topProb);

  // Faults
  const faultRows=chosenRows.filter(isFaultRow);
  renderRates('insProdFaults', rateByKey(chosenRows, prodCol, isFaultRow));
  renderRates('insSubjFaults', rateByKey(chosenRows, subjCol, isFaultRow));

  // SLA Breach
  const slaRows=chosenRows.filter(isSLABreach);
  renderRates('insSLAProd', rateByKey(chosenRows, prodCol, isSLABreach), true);
  renderRates('insSLASubj', rateByKey(chosenRows, subjCol, isSLABreach), true);
  renderRates('insSLAProb', rateByKey(chosenRows, probCol, isSLABreach), true);

  document.getElementById('insSLARecommendations').innerHTML=
    buildSLASuggestions(topSubj.name, topSubj.name, topProb.name);
}
      </script>
  <script>
/* --- Insights: Smart Notes (Top City / Top Unit) ----------------------- */
(function(){
  // מוודא שיש קופסת הערות בתוך מודאל התובנות
  function ensureNotesBox(){
    const modal = document.getElementById('biInsightsModal');
    if (!modal) return;
    const scroller = modal.querySelector('.p-5.space-y-5');
    if (!scroller) return;
    if (!document.getElementById('insNotesBox')) {
      const box = document.createElement('section');
      box.id = 'insNotesBox';
      box.className = 'rounded-2xl bg-white/5 border border-white/10 p-4';
      box.innerHTML = `
        <div class="flex items-center gap-2 mb-2">
          <h3 class="font-bold">הערות חכמות</h3>
        </div>
        <div id="insNotes" class="text-sm space-y-1"></div>
      `;
      // מכניסים את ההערות אחרי פסקת ההסבר למעלה
      scroller.insertBefore(box, scroller.children[1] || null);
    }
  }

  // עוזר למציאת TOP ממפה שם->כמות
  function topFromMap(map){
    const arr = [...map.entries()];
    if (!arr.length) return { name: '—', count: 0 };
    arr.sort((a,b)=>b[1]-a[1]);
    return { name: arr[0][0], count: arr[0][1] };
  }

  // בונה מפת ערכים לפי עמודה
  function countByCol(rows, col){
    const m = new Map();
    if (!col) return m;
    rows.forEach(r=>{
      const k = (r[col] ?? '').toString().trim();
      if (!k) return;
      m.set(k, (m.get(k)||0)+1);
    });
    return m;
  }

  // נעטוף/נרחיב את renderInsights כך שבכל רענון נוסיף הערות
  const prevRender = window.renderInsights;
  window.renderInsights = function(){
    // מריץ את המקורית (כבר מחשבת הכל ומכבדת מחלקה/עיר/יחידה/פתוחות)
    if (typeof prevRender === 'function') prevRender();

    // עכשיו מוסיפים הערות
    try{
      ensureNotesBox();

      const rowsAll  = Array.isArray(window.__dataset)? window.__dataset : [];
      if (!rowsAll.length) { 
        const el = document.getElementById('insNotes');
        if (el) el.textContent = 'אין נתונים להצגה.';
        return;
      }

      // נעזרים בפונקציות מהסקריפט הקיים
      const r0 = rowsAll[0] || {};
      const cityCol = (typeof findCol === 'function') ? findCol(r0, COL.city) : null;
      const unitCol = (typeof findCol === 'function') ? findCol(r0, COL.dept) : null;

      // מצב "רק פתוחות"
      const openOnlyCb = document.getElementById('insOpenOnly');
      const openOnly = openOnlyCb ? !!openOnlyCb.checked : true;

      // 1) חתך כללי (כל המחלקות)
      let globalRows = rowsAll.slice();
      if (openOnly && typeof isOpenRow === 'function') {
        globalRows = globalRows.filter(isOpenRow);
      }
      const topCityGlobal = topFromMap(countByCol(globalRows, cityCol));
      const topUnitGlobal = topFromMap(countByCol(globalRows, unitCol));

      // 2) חתך לפי בחירה נוכחית במודאל:
      //    מכבדים מחלקה (טאב), ואז scope (עיר/יחידה/כללי) + value
      let scoped = (typeof scopeByDept === 'function') ? scopeByDept(rowsAll) : rowsAll.slice();
      if (openOnly && typeof isOpenRow === 'function') scoped = scoped.filter(isOpenRow);

      // scope + value מהמודאל
      const scopeSel = document.getElementById('insScope');
      const valueSel = document.getElementById('insValue');
      const scopeVal = scopeSel ? scopeSel.value : 'all';
      const valueVal = valueSel ? valueSel.value : '';

      let scopeKey = null;
      if (scopeVal === 'city') scopeKey = cityCol;
      if (scopeVal === 'unit') scopeKey = unitCol;

      // rows לפי הבחירה ב־scope/value
      let chosenRows = scoped;
      if (scopeKey && valueVal) {
        chosenRows = chosenRows.filter(r => String(r[scopeKey]||'').trim() === valueVal);
      }

      const topCityChosen = topFromMap(countByCol(chosenRows, cityCol));
      const topUnitChosen = topFromMap(countByCol(chosenRows, unitCol));

      // רינדור טקסט הערות
      const el = document.getElementById('insNotes');
      if (el){
        const fmt = n => Number(n||0).toLocaleString('he-IL');
        el.innerHTML = `
          <div>🔹 <b>כללי – כל המחלקות:</b> העיר המובילה היא <b>${escapeHtml(topCityGlobal.name)}</b> (${fmt(topCityGlobal.count)} פניות),
          והיחידה המובילה היא <b>${escapeHtml(topUnitGlobal.name)}</b> (${fmt(topUnitGlobal.count)}).</div>
          <div>🔹 <b>לפי בחירה נוכחית:</b> העיר המובילה היא <b>${escapeHtml(topCityChosen.name)}</b> (${fmt(topCityChosen.count)} פניות),
          והיחידה המובילה היא <b>${escapeHtml(topUnitChosen.name)}</b> (${fmt(topUnitChosen.count)}).</div>
          <div class="text-xs text-ink-200/70">* הבחירה הנוכחית מושפעת גם מטאב "מחלקה מטפלת" וגם מהשדות בראש המודאל (כללי/עיר/יחידה).</div>
        `;
      }
    }catch(e){
      console.warn('Insights notes add-on error:', e);
    }
  };

  // עזר קטן לשמירה על בטיחות HTML
  function escapeHtml(s){ 
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;'); 
  }

  // אם המודאל כבר פתוח ונעשה אירוע טעינת נתונים – נרנדר כולל הערות
  document.addEventListener('bi:data-loaded', ()=>{
    const m=document.getElementById('biInsightsModal');
    if (m && !m.classList.contains('hidden')) {
      setTimeout(()=>window.renderInsights && window.renderInsights(), 0);
    }
  });
})();
  </script>
  <!-- === INSIGHTS (QUALITY ANALYSIS) — SINGLE DROP-IN BLOCK === -->
<script>
(function(){
  // ---------- Small dark-style fix for <select> ----------
  const styleId='insights-dark-select-style';
  if(!document.getElementById(styleId)){
    const css=document.createElement('style'); css.id=styleId; css.textContent=
`#biInsightsBtn{position:fixed;left:1rem;bottom:1rem;z-index:1500}
#insScope,#insValue,#insOpenOnly{accent-color:#8b5cf6}
#insScope, #insValue{background-color:#0b1220 !important;color:#fff !important;border:1px solid rgba(255,255,255,.2) !important;border-radius:.5rem;padding:.25rem .5rem}
#insScope option, #insValue option{background-color:#0b1220 !important;color:#fff !important}`;
    document.head.appendChild(css);
  }

  // ---------- Floating open button ----------
  if(!document.getElementById('biInsightsBtn')){
    const btn=document.createElement('button');
    btn.id='biInsightsBtn';
    btn.className='px-4 py-2 rounded-full bg-gradient-to-r from-brand-600 to-gold-500 text-white shadow';
    btn.textContent='🧠 תובנות';
    btn.title='חלון תובנות איכותיות';
    document.body.appendChild(btn);
    btn.addEventListener('click', openInsights);
  }

  // ---------- Modal skeleton (created once) ----------
  function ensureModal(){
    if (document.getElementById('biInsightsModal')) return;
    const html=`
    <div id="biInsightsModal" class="fixed inset-0 z-[1600] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-8 max-w-6xl w-[96%] rounded-3xl bg-[#0b1220] border border-white/10 shadow">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div class="text-xl font-bold">תובנות איכותיות</div>
          <div class="ms-auto flex flex-wrap items-center gap-3 text-sm">
            <label class="inline-flex items-center gap-2">טווח: 
              <select id="insScope">
                <option value="city">עיר</option>
                <option value="unit">יחידה</option>
              </select>
            </label>
            <label class="inline-flex items-center gap-2" title="הערכים מתעדכנים לפי הטווח והמחלקה הפעילה">
              ערך: <select id="insValue"></select>
            </label>
            <label class="inline-flex items-center gap-2"><input id="insOpenOnly" type="checkbox" checked/> רק פניות פתוחות</label>
            <button id="insRefresh" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15">רענון</button>
            <button id="insClose" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15">סגירה</button>
          </div>
        </div>
        <div class="p-5 space-y-5 overflow-auto" style="max-height:70vh">
          <div class="text-xs text-ink-200/70">
            הניתוח מכבד את הטאב הפעיל של <b>מחלקה מטפלת</b> (אם קיים). עמודות דרושות: עיר/יישוב, "יחידת דואר: שם", סיווג נושא/בעיה/מוצר, "שעת/תאריך פתיחה ".
          </div>

          <!-- A -->
          <section class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-bold"><span id="insScopeTitle">עיר</span> מובילה — למה יש הכי הרבה פניות?</h3>
              <span id="insChosenTotal" class="ms-auto text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10"></span>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-ink-200/80 mb-1">Top 3 — סיווג נושא</div>
                <div id="insTopSubject" class="space-y-1"></div>
              </div>
              <div>
                <div class="text-sm text-ink-200/80 mb-1">Top 3 — סיווג בעיה</div>
                <div id="insTopProblem" class="space-y-1"></div>
              </div>
            </div>
            <div id="insHypo" class="mt-3 text-sm"></div>
            <div class="mt-3 flex gap-2">
              <button id="insChosenRowsBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">פתח טבלה</button>
              <button id="insChosenExportBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">ייצוא לאקסל</button>
            </div>
          </section>

          <!-- B -->
          <section class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <h3 class="font-bold mb-2">מה גורם ליותר תקלות — סיווג מוצר או סיווג נושא?</h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-ink-200/80 mb-1">סיווג מוצר — שיעור “תקלות”</div>
                <div id="insProdFaults" class="space-y-1"></div>
              </div>
              <div>
                <div class="text-sm text-ink-200/80 mb-1">סיווג נושא — שיעור “תקלות”</div>
                <div id="insSubjFaults" class="space-y-1"></div>
              </div>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="insFaultRowsBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">פתח טבלה</button>
              <button id="insFaultExportBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">ייצוא לאקסל</button>
            </div>
          </section>

          <!-- C -->
          <section class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <h3 class="font-bold mb-2">איפה כמעט תמיד חורגים מ־SLA?</h3>
            <div class="grid md:grid-cols-3 gap-4">
              <div><div class="text-sm text-ink-200/80 mb-1">לפי סיווג מוצר</div><div id="insSLAProd" class="space-y-1"></div></div>
              <div><div class="text-sm text-ink-200/80 mb-1">לפי סיווג נושא</div><div id="insSLASubj" class="space-y-1"></div></div>
              <div><div class="text-sm text-ink-200/80 mb-1">לפי סיווג בעיה</div><div id="insSLAProb" class="space-y-1"></div></div>
            </div>
            <div id="insSLARecommendations" class="mt-3 text-sm"></div>
            <div class="mt-3 flex gap-2">
              <button id="insSLARowsBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">פתח טבלה</button>
              <button id="insSLAExportBtn" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 hover:bg-white/15 text-sm">ייצוא לאקסל</button>
            </div>
          </section>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    $('insClose').onclick = () => $('biInsightsModal').classList.add('hidden');
    $('biInsightsModal').addEventListener('click',(e)=>{ if(e.target.id==='biInsightsModal') e.currentTarget.classList.add('hidden'); });
    $('insRefresh').onclick = () => renderInsights();
    $('insScope').onchange   = () => populateValuesThenRender();  // כשמשנים טווח → טען רשימת ערכים מחדש
    $('insValue').onchange   = () => renderInsights();
    $('insOpenOnly').onchange= () => renderInsights();
  }

  function openInsights(){
    ensureModal();
    if (!dataset().length){ alert('לא נטען קובץ עדיין.'); return; }
    populateValuesThenRender(); // ממלא ערכים לפי הטווח (עיר/יחידה) ואז מרנדר
    $('biInsightsModal').classList.remove('hidden');
  }

  // ---------- Utilities ----------
  const DAY=24*60*60*1000;
  const CLOSED=['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  const HEB=/[\u0591-\u05C7]/g;
  const norm=s=>String(s||'').replace(HEB,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();
  const $=(id)=>document.getElementById(id);
  const has= (o,k)=>Object.prototype.hasOwnProperty.call(o,k);

  const COL={
    city:{exact:['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'],kw:[['עיר'],['יישוב']]},
    unit:{exact:['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'],kw:[['יחידת','דואר','שם'],['שם','יחידה']]},
    subj:{exact:['סיווג נושא','נושא','סיווג נושא '],kw:[['סיווג','נושא'],['נושא']]},
    prob:{exact:['סיווג בעיה','בעיה','סיווג בעיה '],kw:[['סיווג','בעיה'],['בעיה']]},
    prod:{exact:['סיווג מוצר','מוצר','שם מוצר'],kw:[['סיווג','מוצר'],['מוצר']]},
    dept:{exact:['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],kw:[['מחלקה','מטפלת'],['מחלקה']]},
    status:{exact:['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'],kw:[]},
    opened:{exact:['שעת/תאריך פתיחה ','שעת/תאריך פתיחה','תאריך/שעת פתיחה','תאריך פתיחה','opened_at','date_opened','פתיחה'],kw:[['פתיחה'],['תאריך']]}
  };

  function findColumnFlexible(row0, exactList, keywordSets){
    if(!row0) return null;
    const headers=Object.keys(row0);
    for(const h of headers){ if (exactList.includes(h)) return h;
      const hN=norm(h); for(const ex of exactList){ if (hN===norm(ex)) return h; } }
    for(const h of headers){ const n=norm(h); if (keywordSets?.some(set=>set.every(k=>n.includes(norm(k))))) return h; }
    return null;
  }
  function findCol(row0, spec){ return findColumnFlexible(row0, spec.exact, spec.kw); }

  function dataset(){ return Array.isArray(window.__dataset)? window.__dataset : []; }
  function activeDept(){
    const tabs=document.getElementById('deptTabs'); if(!tabs) return 'כללי';
    const btn=[...tabs.querySelectorAll('button')].find(b=>b.className.includes('from-brand-600')||b.className.includes('bg-gradient-to-r'));
    return (btn?.textContent||'כללי').trim();
  }
  function scopeRowsByDept(rows){
    const dept=activeDept(); if (dept==='כללי') return rows;
    const k=findCol(rows[0], COL.dept); if(!k) return rows;
    return rows.filter(r=>String(r[k]??'').trim()===dept);
  }
  function isOpenRow(r){ const k=findCol(r,COL.status); if(!k) return true; const v=String(r[k]??'').trim(); return !CLOSED.some(c=>v===c||v.includes(c)); }

  function excelToDate(n){ const epoch=new Date(Date.UTC(1899,11,30)); return new Date(epoch.getTime()+n*DAY); }
  function parseDate(val){
    if (val==null||val==='') return null;
    if (typeof val==='number') return excelToDate(val);
    const d=new Date(val); if(!isNaN(d)) return d;
    const m=String(val).match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?/);
    if (m){ let[_,dd,mm,yy,HH='00',MM='00']=m; if(yy.length===2) yy='20'+yy; const d2=new Date(`${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:00`); if(!isNaN(d2)) return d2; }
    return null;
  }

  // SLA rules (כמו שסיכמנו)
  function pickSLARule(row){
    const dept=norm(row[findCol(row, COL.dept)]||'');
    const subj=norm(row[findCol(row, COL.subj)]||'');
    const prob=norm(row[findCol(row, COL.prob)]||'');
    if (dept.includes('פנים')&&dept.includes('ארצי') && (subj.includes('חלוקתדואר')||subj.includes('יחידותדואר'))) return {ms:8*DAY,label:'8 ימים — חלוקת/יחידות דואר (פנים-ארצי)'};
    if ((prob.includes('תקל')&&prob.includes('פורטל')) && (dept.includes('שליח')||dept.includes('בינלאומי'))) return {ms:1*DAY,label:'24 שעות — תקלה בפורטל'};
    if ((prob.includes('איסוף')||prob.includes('הזמנה')) && dept.includes('שליח')) return {ms:1*DAY,label:'24 שעות — איסוף/הזמנה (שליחים)'};
    if ((dept.includes('פנים')&&dept.includes('ארצי')) || dept.includes('שליח')) return {ms:30*DAY,label:'30 ימים — ברירת מחדל'};
    if (dept.includes('בינלאומי')) return {ms:60*DAY,label:'60 ימים — ברירת מחדל (בינלאומי)'};
    return null;
  }
  function isSLABreach(row){
    if(!isOpenRow(row)) return false;
    const k=findCol(row,COL.opened); if(!k) return false;
    const opened=parseDate(row[k]); if(!opened) return false;
    const rule=pickSLARule(row); if(!rule) return false;
    return Date.now() > (opened.getTime()+rule.ms);
  }
  function isFaultRow(row){
    const pk=findCol(row, COL.prob), sk=findCol(row, COL.subj);
    const txt=(String(row[pk]||'')+' '+String(row[sk]||'')).toLowerCase();
    return /(תקלה|שגיאה|כשל|קריסה|פורטל)/.test(txt);
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function sanitize(s){ return String(s||'').replace(/[\\/:*?"<>|]+/g,'_').slice(0,60); }

  // ---------- Populate values (city / unit) ----------
  function populateValuesThenRender(){
    const rowsAll = dataset(); if(!rowsAll.length) return;
    ensureModal();
    const scope = $('insScope').value || 'city';
    $('insScopeTitle').textContent = (scope==='unit'?'יחידה':'עיר');

    let rows = scopeRowsByDept(rowsAll);
    const r0 = rows[0] || {};
    const col = findCol(r0, scope==='unit'? COL.unit : COL.city);

    const map=new Map();
    if (col){ rows.forEach(r=>{ const v=(r[col]??'').toString().trim(); if(!v) return; map.set(v,(map.get(v)||0)+1); }); }

    const items=[...map.entries()].sort((a,b)=>b[1]-a[1]).map(([name,c])=>({name,count:c}));
    const sel=$('insValue');
    sel.innerHTML = items.length
      ? items.map(x=>`<option value="${escapeHtml(x.name)}">${escapeHtml(x.name)} — ${x.count.toLocaleString('he-IL')}</option>`).join('')
      : '<option value="">(אין ערכים)</option>';

    renderInsights(); // מרנדר עם הערך הראשון (אם יש)
  }

  // ---------- Render ----------
  function renderInsights(){
    ensureModal();
    const rowsAll = dataset(); if(!rowsAll.length){ alert('לא נטען קובץ עדיין.'); return; }

    const openOnly = $('insOpenOnly').checked;
    const scope    = $('insScope').value || 'city';
    const chosen   = $('insValue').value || '';

    let rows = scopeRowsByDept(rowsAll);
    if (openOnly) rows = rows.filter(isOpenRow);

    const r0 = rows[0] || {};
    const cityCol = findCol(r0, COL.city);
    const unitCol = findCol(r0, COL.unit);
    const subjCol = findCol(r0, COL.subj);
    const probCol = findCol(r0, COL.prob);
    const prodCol = findCol(r0, COL.prod);

    // slice by chosen scope
    let chosenRows = rows;
    if (scope==='city' && cityCol && chosen) chosenRows = rows.filter(r => String(r[cityCol]||'').trim()===chosen);
    if (scope==='unit' && unitCol && chosen) chosenRows = rows.filter(r => String(r[unitCol]||'').trim()===chosen);

    $('insChosenTotal').textContent = chosen ? `${chosenRows.length.toLocaleString('he-IL')} פניות` : '';

    renderTopList('insTopSubject', chosenRows, subjCol);
    renderTopList('insTopProblem', chosenRows, probCol);
    $('insHypo').innerHTML = buildHypothesisBlock(topKey(chosenRows, subjCol), topKey(chosenRows, probCol));

    // buttons (chosen)
    $('insChosenRowsBtn').onclick   = ()=> openRowsModal(chosenRows, `${scope==='unit'?'יחידה':'עיר'} — ${chosen||'הכל'}`);
    $('insChosenExportBtn').onclick = ()=> exportAny(chosenRows, `${scope==='unit'?'unit':'city'}_${sanitize(chosen||'all')}.xlsx`);

    // Faults
    const faultRows = rows.filter(isFaultRow);
    renderRates('insProdFaults', rateByKey(rows, prodCol, isFaultRow));
    renderRates('insSubjFaults', rateByKey(rows, subjCol, isFaultRow));
    $('insFaultRowsBtn').onclick   = ()=> openRowsModal(faultRows, 'שורות — תקלות');
    $('insFaultExportBtn').onclick = ()=> exportAny(faultRows, 'fault_rows.xlsx');

    // SLA
    const slaRows = rows.filter(isSLABreach);
    const slaProd = rateByKey(rows, prodCol, isSLABreach);
    const slaSubj = rateByKey(rows, subjCol, isSLABreach);
    const slaProb = rateByKey(rows, probCol, isSLABreach);
    renderRates('insSLAProd', slaProd, true);
    renderRates('insSLASubj', slaSubj, true);
    renderRates('insSLAProb', slaProb, true);
    $('insSLARecommendations').innerHTML = buildSLASuggestions(slaProd.top?.name||'', slaSubj.top?.name||'', slaProb.top?.name||'');
    $('insSLARowsBtn').onclick   = ()=> openRowsModal(slaRows, 'שורות — חרגי SLA');
    $('insSLAExportBtn').onclick = ()=> exportAny(slaRows, 'sla_breach_rows.xlsx');
  }

  // ---------- Helpers (lists, rates, table, export) ----------
  function renderTopList(containerId, rows, col){
    const el=$(containerId); el.innerHTML='';
    if (!col || !rows.length){ el.textContent='—'; return; }
    const map=new Map(); rows.forEach(r=>{ const k=(r[col]??'').toString().trim(); if(!k) return; map.set(k,(map.get(k)||0)+1); });
    const items=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
    const total=rows.length||1;
    items.forEach(([name,count])=>{
      const row=document.createElement('div');
      row.className='flex items-center gap-2';
      row.innerHTML=`<span class="text-ink-50/90">${escapeHtml(name)}</span>
        <span class="ms-auto text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10">${count.toLocaleString('he-IL')} • ${Math.round(count*100/total)}%</span>`;
      el.appendChild(row);
    });
    if (!items.length) el.textContent='—';
  }
  function topKey(rows, col){
    if (!col) return {name:'',count:0,pct:0};
    const map=new Map(); rows.forEach(r=>{ const k=(r[col]??'').toString().trim(); if(!k) return; map.set(k,(map.get(k)||0)+1); });
    const items=[...map.entries()].sort((a,b)=>b[1]-a[1]);
    const total=rows.length||1;
    if (!items.length) return {name:'',count:0,pct:0};
    return {name:items[0][0],count:items[0][1],pct:Math.round(items[0][1]*100/total)};
  }
  function rateByKey(allRows, col, predicateFn, minN=20){
    if (!col || !allRows.length) return {list:[], top:null};
    const buckets=new Map();
    allRows.forEach(r=>{
      const key=(r[col]??'').toString().trim() || '(לא צוין)';
      const b=buckets.get(key)||{n:0,yes:0};
      b.n++; if (predicateFn(r)) b.yes++;
      buckets.set(key,b);
    });
    const list=[...buckets.entries()].map(([name,{n,yes}])=>({name,yes,n,rate:n?(yes/n):0}));
    const filtered=list.filter(x=>x.n>=minN).sort((a,b)=>b.rate-a.rate||b.n-a.n).slice(0,5);
    return {list:filtered, top:filtered[0]||null};
  }
  function renderRates(containerId,data,emphasizeHigh=false){
    const el=$(containerId); el.innerHTML='';
    if (!data.list.length){ el.textContent='—'; return; }
    data.list.forEach(item=>{
      const p=Math.round(item.rate*100);
      const bar=document.createElement('div'); bar.className='text-xs';
      bar.innerHTML=`<div class="flex items-center gap-2">
          <span class="text-ink-50/90">${escapeHtml(item.name)}</span>
          <span class="ms-auto">${item.yes.toLocaleString('he-IL')}/${item.n.toLocaleString('he-IL')} • ${p}%</span>
        </div>
        <div class="h-1.5 bg-white/10 rounded mt-1 overflow-hidden">
          <div class="${emphasizeHigh?'bg-red-500':'bg-brand-500'}" style="width:${p}%"></div>
        </div>`;
      el.appendChild(bar);
    });
  }
  function buildHypothesisBlock(topSubj, topProb){
    const hints=[];
    if ((topSubj.name||'').includes('חלוקת') || (topSubj.name||'').includes('יחידות דואר') || (topProb.name||'').includes('חלוקת')){
      hints.push({ issue:'עומס בחלוקת דואר/יחידות דואר', cause:'קיבולת שליחים/סניפים וזמני מיון', fix:'תיעדוף לפי SLA 8 ימים, ניטור עומסים והסטות בין יחידות' });
    }
    if ((topProb.name||'').includes('פורטל') || /(תקלה|שגיאה|כשל|קריסה)/.test(topProb.name||'')){
      hints.push({ issue:'תקלות מערכת/פורטלים', cause:'באגים/רגרסיות או זמינות נמוכה', fix:'ניטור שגיאות, בדיקות רגרסיה ותעדוף טיפול 24 ש׳' });
    }
    if (!hints.length){
      hints.push({ issue:'קטגוריה מובילה מרוכזת', cause:'תהליך שירות לא אופטימלי', fix:'סקירת תהליך קצה־לקצה, קיצור חיכוכים והדרכת צוותים' });
    }
    return `<div class="rounded-xl bg-white/5 border border-white/10 p-3">
      <div class="font-semibold mb-1">השערה ופעולה</div>
      <ul class="list-disc ms-5">
        ${hints.map(h=>`<li><b>בעיה:</b> ${escapeHtml(h.issue)} → <b>סיבה אפשרית:</b> ${escapeHtml(h.cause)} → <b>פתרון:</b> ${escapeHtml(h.fix)}</li>`).join('')}
      </ul>
    </div>`;
  }
  function buildSLASuggestions(prodName, subjName, probName){
    const keys=[prodName,subjName,probName].join(' ').toLowerCase();
    const recs=[];
    if (/חלוקת|יחידות/.test(keys)) recs.push('בקרות קיבולת ביחידות עמוסות, SLA 8 ימים, ניטור תפוקה יומי.');
    if (/פורטל|תקלה|שגיאה|כשל|קריסה/.test(keys)) recs.push('יציבות פורטל: ניטור שגיאות, רגרסיה אוטומטית ותור מהיר (24 ש׳).');
    if (/איסוף|הזמנה/.test(keys)) recs.push('שיפור זרימת הזמנות ותיאומי איסוף — SLA 24 ש׳.');
    if (/בינלאומי/.test(keys)) recs.push('תיאום עם ספקי חוץ/מכס והכוונת ציפיות (SLA 60 ימים).');
    if (!recs.length) recs.push('מיפוי תהליכים בקטגוריות החורגות והסרת צווארי בקבוק.');
    return `<div class="rounded-xl bg-white/5 border border-white/10 p-3">
      <div class="font-semibold mb-1">המלצות פעולה</div>
      <ul class="list-disc ms-5">${recs.map(r=>`<li>${escapeHtml(r)}</li>`).join('')}</ul>
    </div>`;
  }

  // ---------- Table + Export ----------
  function openRowsModal(rows, title){
    // שימוש במודאל הכללי אם קיים (מהמערכת שלך)
    if ($('biModal') && $('biThead') && $('biTbody')){
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      $('biModalTitle').textContent=title||'נתונים';
      $('biModalTitle').dataset.filename=sanitize(title||'export')+'.xlsx';
      if (rows.length){
        $('biThead').innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${escapeHtml(h)}</th>`).join('')+'</tr>';
        $('biTbody').innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2">${escapeHtml(r[h]??'')}</td>`).join('')+'</tr>').join('');
      } else { $('biThead').innerHTML=''; $('biTbody').innerHTML='<tr><td class="px-3 py-2 text-sm text-ink-200/70">אין נתונים</td></tr>'; }
      $('biModal').classList.remove('hidden'); return;
    }
    // מודאל מינימלי
    let host=$('insRowsModal');
    if(!host){
      document.body.insertAdjacentHTML('beforeend',`
        <div id="insRowsModal" class="fixed inset-0 z-[1700] hidden">
          <div class="absolute inset-0 bg-black/60"></div>
          <div class="relative mx-auto my-8 max-w-6xl w-[96%] rounded-2xl bg-[#0b1220] border border-white/10">
            <div class="flex items-center gap-2 px-4 py-3 border-b border-white/10">
              <div id="insRowsTitle" class="font-bold">נתונים</div>
              <button id="insRowsExport" class="ms-auto px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">ייצוא</button>
              <button id="insRowsClose" class="px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">סגירה</button>
            </div>
            <div class="p-3 overflow-auto" style="max-height:70vh">
              <table class="w-full text-sm border-separate border-spacing-0"><thead id="insRowsHead"></thead><tbody id="insRowsBody"></tbody></table>
            </div>
          </div>
        </div>`);
      host=$('insRowsModal');
      $('insRowsClose').onclick=()=>host.classList.add('hidden');
      $('insRowsExport').onclick=()=>{
        if (typeof window.exportXLSX==='function') window.exportXLSX(window.__INS_ROWS||[], sanitize($('insRowsTitle').textContent||'export')+'.xlsx');
        else alert('פונקציית ייצוא לא זמינה.');
      };
    }
    window.__INS_ROWS=rows;
    $('insRowsTitle').textContent=title||'נתונים';
    const head=$('insRowsHead'), body=$('insRowsBody');
    if (rows.length){
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      head.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${escapeHtml(h)}</th>`).join('')+'</tr>';
      body.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2">${escapeHtml(r[h]??'')}</td>`).join('')+'</tr>').join('');
    } else { head.innerHTML=''; body.innerHTML='<tr><td class="px-3 py-2 text-sm text-ink-200/70">אין נתונים</td></tr>'; }
    host.classList.remove('hidden');
  }
  function exportAny(rows, filename){
    if (typeof window.exportXLSX==='function') window.exportXLSX(rows, filename||'export.xlsx');
    else alert('פונקציית ייצוא לא זמינה (ודאי שהדבקת את תיקון ה־XLSX אצלך).');
  }

  // ---------- System hook (אם הדאטה נטענה מחדש) ----------
  document.addEventListener('bi:data-loaded', ()=>{
    if ($('biInsightsModal') && !$('biInsightsModal').classList.contains('hidden')){
      populateValuesThenRender();
    }
  });

})();
</script>
  <!-- === PERFORMANCE PATCH: cache + batched renders (paste before </body>) === -->
<script>
(function(){
  if (window.__BI_PERF_PATCH__) return; window.__BI_PERF_PATCH__=true;

  // --------- Light utils ----------
  const HEB=/[\u0591-\u05C7]/g, norm=s=>String(s||'').replace(HEB,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();
  function findColumnFlexible(row0, exactList, keywordSets){
    if(!row0) return null;
    const headers=Object.keys(row0);
    for(const h of headers){ if(exactList.includes(h)) return h; const n=norm(h); for(const ex of exactList){ if(n===norm(ex)) return h; } }
    for(const h of headers){ const n=norm(h); if (keywordSets?.some(set=>set.every(k=>n.includes(norm(k))))) return h; }
    return null;
  }

  // --------- Columns we touch a lot (one-time detect per dataset) ----------
  const COLSPEC = {
    dept:   { exact:['מחלקה מטפלת','מחלקה','מחלקה מטפלת '], kw:[['מחלקה','מטפלת'],['מחלקה']] },
    status: { exact:['סטאטוס פניה','סטאטוס','סטטוס פניה','סטטוס מקרה','Status','status'], kw:[['סטטוס']] },
    city:   { exact:['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'], kw:[['עיר'],['יישוב']] },
    unit:   { exact:['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'], kw:[['יחידת','דואר','שם'],['שם','יחידה']] },
    opened: { exact:['שעת/תאריך פתיחה ','שעת/תאריך פתיחה','תאריך/שעת פתיחה','תאריך פתיחה','opened_at','date_opened','פתיחה'], kw:[['פתיחה'],['תאריך']] },
    source: { exact:['מקור פניה','מקור הפניה','ערוץ פניה','ערוץ','מקור','Channel','Source'], kw:[['מקור','פניה'],['ערוץ']] },
  };

  const CLOSED = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  function isOpenRow(r, statusCol){
    if(!statusCol) return true;
    const v = String(r[statusCol] ?? '').trim();
    return !CLOSED.some(c=>v===c || v.includes(c));
  }

  // --------- Scheduler: coalesce many renders into one frame ----------
  const queue = new Map(); // key -> fn
  let rafId = null;
  function schedule(key, fn){
    queue.set(key, fn);
    if (rafId==null) rafId = requestAnimationFrame(()=>{
      rafId=null;
      const jobs=[...queue.entries()];
      queue.clear();
      for (const [,run] of jobs) try{ run(); }catch(e){ console.error('BI perf job error', e); }
    });
  }

  // expose helper so existing code can use it if needed
  window.biScheduleRender = schedule;

  // --------- Cache layer over __dataset (scoped by dept + openOnly) ----------
  const Cache = {
    version: 0,              // increases on file upload
    cols: null,              // resolved column names
    byKey: new Map(),        // `${dept}|${openOnly}` -> rows[]
    // resolve columns once per dataset
    resolveCols(rows){
      const r0 = rows && rows[0] || {};
      const cols = {};
      for (const [k,spec] of Object.entries(COLSPEC)) cols[k] = findColumnFlexible(r0, spec.exact, spec.kw);
      this.cols = cols;
    },
    keyFor(deptName, openOnly){
      return `${deptName || 'כללי'}|${openOnly?1:0}|v${this.version}`;
    },
    getScopedRows(rowsAll, deptName, openOnly){
      if (!Array.isArray(rowsAll) || !rowsAll.length) return [];
      if (!this.cols) this.resolveCols(rowsAll);

      // dept scope
      let candidate = rowsAll;
      const dk = this.cols.dept;
      if (deptName && deptName !== 'כללי' && dk) {
        candidate = candidate.filter(r => String(r[dk] ?? '').trim() === deptName);
      }

      const key = this.keyFor(deptName||'כללי', !!openOnly);
      const hit = this.byKey.get(key);
      if (hit) return hit;

      const sk = this.cols.status;
      const scoped = openOnly ? candidate.filter(r => isOpenRow(r, sk)) : candidate.slice(0);
      this.byKey.set(key, scoped);
      return scoped;
    },
    invalidate(){
      this.version++;
      this.byKey.clear();
      this.cols = null;
    }
  };

  // --------- Dept active helper (reads your tabs) ----------
  function activeDept(){
    const tabs=document.getElementById('deptTabs'); if(!tabs) return 'כללי';
    const btn=[...tabs.querySelectorAll('button')].find(b=>b.className.includes('from-brand-600')||b.className.includes('bg-gradient-to-r'));
    return (btn?.textContent||'כללי').trim();
  }

  // --------- Central “fast rows” accessor ----------
  window.BI_FAST = {
    getRows(openOnly=true){
      const all = Array.isArray(window.__dataset) ? window.__dataset : [];
      const dept = activeDept();
      return Cache.getScopedRows(all, dept, openOnly);
    },
    getCols(){ return Cache.cols || {}; },
  };

  // --------- Speed up common UI interactions ----------
  // 1) Dept tabs – batch rerenders
  const deptTabs = document.getElementById('deptTabs');
  if (deptTabs){
    deptTabs.addEventListener('pointerdown', (e)=>{
      if (e.target.tagName==='BUTTON') {
        // תני ל־UI להחליף עיצוב ואז רנדר בפריים הבא (מהיר)
        schedule('dept-switch', ()=>{
          document.dispatchEvent(new CustomEvent('bi:perf-rerender'));
        });
      }
    }, {passive:true});
  }

  // 2) Checkbox “open-only” (אם יש לך כזה במסכים שונים) – מאזין מאוחד
  document.addEventListener('change', (e)=>{
    const id = (e.target && e.target.id) || '';
    if (id==='biOpenOnly' || id==='insOpenOnly' || id==='kpiOpenOnly'){
      schedule('open-only', ()=>{
        document.dispatchEvent(new CustomEvent('bi:perf-rerender'));
      });
    }
  }, {passive:true});

  // --------- Hook: on file load -> invalidate caches & ping renders ----------
  function onDataReady(){
    Cache.invalidate();
    schedule('data-ready', ()=>{
      // הודעה כללית לכל המודולים “תרעננו מהר”
      document.dispatchEvent(new CustomEvent('bi:perf-rerender'));
    });
  }

  // אם האפליקציה עוטפת updateSuccessUI – נעטוף גם אנחנו
  if (typeof window.updateSuccessUI==='function' && !window.__BI_PERF_WRAP__){
    const prev = window.updateSuccessUI;
    window.updateSuccessUI = function(){
      prev.apply(this, arguments);
      onDataReady();
    };
    window.__BI_PERF_WRAP__ = true;
  }
  // וגם אירוע פרטי אם יש
  document.addEventListener('bi:data-loaded', onDataReady);

  // --------- OPTIONAL: make our heavy renderers use the scheduler ----------
  // Stage 13–14 (אם קיים מהתיקון הקודם) – נאציל לו רענון מהיר
  if (document.getElementById('biStep13_14')){
    // נמצא את רענון הבלוק ונעטוף אותו אם קיים
    const btn = document.getElementById('biRerender1314');
    if (btn){
      const fast = ()=>{ 
        // נלחץ על הכפתור הקיים אבל באצווה כדי למנוע כמה קליקים רצופים
        schedule('stage1314', ()=> btn.__run ? btn.__run() : btn.click());
      };
      // אם הכפתור כבר מפעיל render(), נרשום ממנו "runner" כדי להימנע מקליק מדומה
      const oldOnClick = btn.onclick;
      btn.onclick = function(ev){
        if (ev !== true && typeof oldOnClick === 'function') oldOnClick.call(this, ev);
      };
      btn.__run = ()=>oldOnClick && oldOnClick(true);

      // כאשר יש רענון כללי – נרנדר את 13–14
      document.addEventListener('bi:perf-rerender', fast);
    }
  }

  // Insights modal – טריגר רענון מהיר כשהמודאל פתוח
  const insightsBtn = document.getElementById('biInsightsBtn');
  if (insightsBtn){
    const rerenderInsights = ()=> {
      const m = document.getElementById('biInsightsModal');
      if (m && !m.classList.contains('hidden')){
        // אם יש פונקציית רינדר פנימית – נקרא לה בפריים
        schedule('insights', ()=>{
          const r = window.renderInsights || window.__renderInsights;
          if (typeof r === 'function') r();
        });
      }
    };
    document.addEventListener('bi:perf-rerender', rerenderInsights);
  }

  // --------- Tip: expose cheap helpers to other scripts ---------
  window.__BI_getActiveDept = activeDept;

})();
        </script>
  <!-- Change-Tracking 72h: open table first, then export (XLSX/CSV fallback) -->
<script>
(function(){
  const DAY=24*60*60*1000;
  function excelToDate(n){ const e=new Date(Date.UTC(1899,11,30)); return new Date(e.getTime()+n*DAY); }
  function parseDate(v){
    if(v==null||v==='') return null;
    if(typeof v==='number') return excelToDate(v);
    const d=new Date(v); if(!isNaN(d)) return d;
    const m=String(v).match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?/);
    if(m){let[_,dd,mm,yy,HH='00',MM='00']=m; if(yy.length===2) yy='20'+yy;
      const s=`${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:00`;
      const d2=new Date(s); if(!isNaN(d2)) return d2;
    }
    return null;
  }
  const HEB=/[\u0591-\u05C7]/g, norm=s=>String(s||'').replace(HEB,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();
  function findCol(row0, names){
    if(!row0) return null;
    const headers=Object.keys(row0);
    for(const h of headers){ if(names.some(n=>norm(h)===norm(n))) return h; }
    // ניסיונות גנריים
    for(const h of headers){ const n=norm(h);
      if(n.includes('שינוי')&&n.includes('תאריך')) return h;
      if(n.includes('עדכון')&&n.includes('אחרון')) return h;
      if(n.includes('last')&&n.includes('update')) return h;
    }
    return null;
  }
  const CLOSED=['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
  function isOpen(r,statusCol){ if(!statusCol) return true; const v=String(r[statusCol]??''); return !CLOSED.some(w=>v===w||v.includes(w)); }

  // ====== Modal renderer (מעדיף את המודאל הכללי אם קיים) ======
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function sanitize(s){ return String(s||'').replace(/[\\/:*?"<>|]+/g,'_').slice(0,60); }

  function openRowsTable(rows, title, filenameBase){
    // אם יש מודאל BI כללי – נשתמש בו
    const bi = document.getElementById('biModal');
    if (bi && document.getElementById('biThead') && document.getElementById('biTbody')){
      const tHead=document.getElementById('biThead'), tBody=document.getElementById('biTbody');
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      document.getElementById('biModalTitle').textContent = title||'נתונים';
      document.getElementById('biModalTitle').dataset.filename = (filenameBase||'export')+'.xlsx';
      if (rows.length){
        tHead.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${escapeHtml(h)}</th>`).join('')+'</tr>';
        tBody.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2">${escapeHtml(r[h]??'')}</td>`).join('')+'</tr>').join('');
      } else {
        tHead.innerHTML=''; tBody.innerHTML='<tr><td class="px-3 py-2 text-sm text-ink-200/70">אין נתונים</td></tr>';
      }
      // נשמור שורות נוכחיות לייצוא
      window.__BI_CURRENT_ROWS = rows;
      bi.classList.remove('hidden');
      return;
    }
    // מודאל קטן מקומי
    let host=document.getElementById('chg72RowsModal');
    if(!host){
      document.body.insertAdjacentHTML('beforeend', `
        <div id="chg72RowsModal" class="fixed inset-0 z-[1700] hidden">
          <div class="absolute inset-0 bg-black/60"></div>
          <div class="relative mx-auto my-8 max-w-6xl w-[96%] rounded-2xl bg-[#0b1220] border border-white/10">
            <div class="flex items-center gap-2 px-4 py-3 border-b border-white/10">
              <div id="chg72RowsTitle" class="font-bold">נתונים</div>
              <button id="chg72RowsExport" class="ms-auto px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">ייצוא</button>
              <button id="chg72RowsClose" class="px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">סגירה</button>
            </div>
            <div class="p-3 overflow-auto" style="max-height:70vh">
              <table class="w-full text-sm border-separate border-spacing-0">
                <thead id="chg72RowsHead"></thead><tbody id="chg72RowsBody"></tbody>
              </table>
            </div>
          </div>
        </div>`);
      host=document.getElementById('chg72RowsModal');
      document.getElementById('chg72RowsClose').onclick=()=>host.classList.add('hidden');
      document.getElementById('chg72RowsExport').onclick=()=>exportAny(window.__CHG72_LAST_ROWS||[], (window.__CHG72_LAST_FN||'export')+'.xlsx');
    }
    const head=document.getElementById('chg72RowsHead'), body=document.getElementById('chg72RowsBody');
    document.getElementById('chg72RowsTitle').textContent = title||'נתונים';
    window.__CHG72_LAST_ROWS = rows; window.__CHG72_LAST_FN = filenameBase||'export';
    if (rows.length){
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      head.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${escapeHtml(h)}</th>`).join('')+'</tr>';
      body.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2">${escapeHtml(r[h]??'')}</td>`).join('')+'</tr>').join('');
    } else { head.innerHTML=''; body.innerHTML='<tr><td class="px-3 py-2 text-sm text-ink-200/70">אין נתונים</td></tr>'; }
    document.getElementById('chg72RowsModal').classList.remove('hidden');
  }

  // ייצוא (XLSX אם יש SheetJS; אחרת CSV)
  function exportAny(rows, filename){
    if (window.XLSX){
      const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Data'); XLSX.writeFile(wb, filename||'export.xlsx');
    }else{
      const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
      const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
      const csv=[headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
      a.download=(filename||'export')+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000);
    }
  }

  function activeDept(){
    const tabs=document.getElementById('deptTabs'); if(!tabs) return 'כללי';
    const el=[...tabs.querySelectorAll('button')].find(b=>b.className.includes('from-brand-600')||b.className.includes('bg-gradient-to-r'));
    return (el?.textContent||'כללי').trim();
  }
  function scopeByDept(rows, deptCol){
    const d=activeDept(); if(d==='כללי'||!deptCol) return rows;
    return rows.filter(r=>String(r[deptCol]??'').trim()===d);
  }

  // ====== Logic: compute groups & wire buttons ======
  function recomputeChg72(){
    const rows = Array.isArray(window.__dataset)? window.__dataset : [];
    if(!rows.length) return;

    const r0 = rows[0];
    const statusCol = findCol(r0, ['סטאטוס פניה','סטטוס פניה','סטטוס','Status']);
    const deptCol   = findCol(r0, ['מחלקה מטפלת','מחלקה']);
    const changeCol = findCol(r0, ['שעת/תאריך שינוי אחרון','תאריך שינוי אחרון','עדכון אחרון','Last Update']);

    let scoped = scopeByDept(rows, deptCol).filter(r=>isOpen(r,statusCol));
    const now=Date.now(), LIM=72*60*60*1000;

    const withTs = scoped.map(r=>{
      const d = parseDate(r[changeCol]);
      return {row:r, ts: d? d.getTime() : null};
    });

    const breach = withTs.filter(x=>x.ts!=null && (now - x.ts) > LIM).map(x=>x.row);
    const ok     = withTs.filter(x=>x.ts!=null && (now - x.ts) <= LIM).map(x=>x.row);
    const noDate = withTs.filter(x=>x.ts==null).map(x=>x.row);

    window.__CHG72 = {breach, ok, noDate, all: scoped};

    // חיבור כפתורים לפתיחת טבלה:
    const wireOpen = (selector, list, title, fnBase)=>{
      document.querySelectorAll(selector).forEach(btn=>{
        btn.onclick = ()=> openRowsTable(list, title, fnBase);
      });
    };
    wireOpen('#chg72BtnBreach, [data-open="chg72:breach"]', breach, 'חריגים – שינוי אחרון מעל 72 שעות', 'chg72_breach');
    wireOpen('#chg72BtnOk, [data-open="chg72:ok"]', ok, 'עומדים בזמנים – שינוי עד 72 שעות', 'chg72_ok');
    wireOpen('#chg72BtnAll, [data-open="chg72:all"]', scoped, 'כל הפניות (מעקב שינוי אחרון)', 'chg72_all');
    wireOpen('#chg72BtnNoDate, [data-open="chg72:nodate"]', noDate, 'ללא תאריך שינוי אחרון', 'chg72_nodate');
  }

  // הפעלה ראשונית + האזנה
  if (Array.isArray(window.__dataset) && window.__dataset.length) recomputeChg72();
  document.addEventListener('bi:data-loaded', recomputeChg72);
  const tabs=document.getElementById('deptTabs');
  if (tabs){ tabs.addEventListener('click', ()=>setTimeout(recomputeChg72, 50)); }
})();
</script>
</body>
