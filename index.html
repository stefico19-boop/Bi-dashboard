<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת BI — העלאת קובץ</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ink: { 50:'#f8fafc', 100:'#eef2f6', 200:'#e2e8f0', 800:'#1f2937', 900:'#0b1220' },
            luxe: { 100:'#f3f4f6', 200:'#e5e7eb', 300:'#d1d5db', 700:'#374151', 900:'#111827' },
            brand: { 400:'#8b5cf6', 500:'#7c3aed', 600:'#6d28d9' },
            gold: { 400:'#f6c453', 500:'#f59e0b' }
          },
          boxShadow: {
            luxe: '0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)',
          },
          backdropBlur: { xs: '2px' },
          borderRadius: { '3xl': '1.5rem' }
        }
      }
    }
  </script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ברק יוקרתי דק לכפתורים/כרטיסים */
    .sheen {
      position: relative;
      overflow: hidden;
    }
    .sheen::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 300%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.15) 50%, transparent 65%);
      transform: rotate(15deg);
      animation: sheen 4s infinite;
    }
    @keyframes sheen {
      0%   { transform: translateX(-30%) translateY(-30%) rotate(15deg); }
      60%  { transform: translateX(60%) translateY(60%) rotate(15deg); }
      100% { transform: translateX(60%) translateY(60%) rotate(15deg); }
    }
    /* סלוט של גרירת קובץ */
    .dropzone.dragover { border-color: #8b5cf6; background: rgba(139,92,246,.06); }
  </style>
</head>

<body class="bg-gradient-to-b from-ink-900 via-[#0d1020] to-[#0a0f1c] text-white min-h-screen">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-6">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-brand-600 to-gold-500 flex items-center justify-center shadow-luxe sheen">
        <span class="font-black text-xl">BI</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">מערכת BI — קליטה חכמה של קבצי Excel</h1>
        <p class="text-sm text-ink-200/80">שלב 1: העלאת קובץ XLSX, ספירת שורות ועדכון סטטוס</p>
      </div>
    </div>
  </header>

  <!-- Card -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <section class="rounded-3xl sheen shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
      <!-- Status Row -->
      <div id="statusBar" class="flex flex-wrap items-center gap-3 rounded-2xl border border-white/10 bg-white/5 p-3">
        <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-ink-900/70 border border-white/10">
          <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4 text-ink-200">
            <path d="M12 2v4m0 12v4M4 12H2m20 0h-2M5 5l-2-2m16 16 2 2M19 5l2-2M5 19l-2 2" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </span>
        <div class="text-sm">
          <div class="font-semibold" id="statusTitle">מוכן לקליטת קובץ</div>
          <div class="text-ink-200/80" id="statusSub">בחרי קובץ ‎.xlsx או גררי לכרטיס</div>
        </div>
        <div class="ms-auto">
          <span id="chipRows" class="hidden text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 font-semibold shadow">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Uploader -->
      <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- File input -->
        <label class="block">
          <span class="text-sm text-ink-200/90 font-medium">בחרי קובץ XLSX</span>
          <input id="fileInput" type="file" accept=".xlsx,.xlsb,.xlsm,.xls"
                 class="mt-2 w-full file:me-4 file:px-4 file:py-2 file:rounded-xl file:border-0 file:bg-gradient-to-r file:from-brand-600 file:to-gold-500 file:text-white file:font-semibold file:cursor-pointer file:shadow hover:file:opacity-95
                        bg-white/5 border border-white/10 rounded-2xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/40"/>
        </label>

        <!-- Drag & Drop -->
        <div id="dropzone"
             class="dropzone rounded-2xl border-2 border-dashed border-white/15 bg-white/5 p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-brand-500/50 transition">
          <svg viewBox="0 0 24 24" fill="none" class="h-8 w-8 text-ink-200/80">
            <path d="M7 16a5 5 0 0 1 0-10 6 6 0 0 1 11 2 4 4 0 0 1 1 7" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 12v6m0-6 2 2m-2-2-2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <p class="mt-3 text-sm text-ink-200/85">
            גררי לכאן קובץ ‎.xlsx או הקליקי לבחירה
          </p>
        </div>
      </div>

      <!-- Result line -->
      <div id="resultLine" class="mt-6 hidden rounded-xl bg-ink-900/60 border border-white/10 p-4 text-sm">
        <div class="flex items-center gap-2">
          <svg id="resultIcon" viewBox="0 0 24 24" fill="none" class="h-5 w-5 text-emerald-400">
            <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div id="resultTitle" class="font-semibold">הקובץ נקלט בהצלחה</div>
            <div id="resultSub" class="text-ink-200/80">שם קובץ • שורות • תאריך</div>
          </div>
          <span id="rowsPill" class="ms-auto hidden px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/40">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Tiny footer -->
      <div class="mt-8 text-[11px] text-ink-200/60">
        טיפ: בשלב הבא נוסיף תצוגה מקדימה וטיפול בתאריכים/שעות וסכימות SLA.
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    const statusBar   = $('statusBar');
    const statusTitle = $('statusTitle');
    const statusSub   = $('statusSub');
    const chipRows    = $('chipRows');
    const resultLine  = $('resultLine');
    const resultTitle = $('resultTitle');
    const resultSub   = $('resultSub');
    const rowsPill    = $('rowsPill');
    const resultIcon  = $('resultIcon');

    function setLoadingState(isLoading) {
      if (isLoading) {
        statusTitle.textContent = 'טוען קובץ...';
        statusSub.textContent   = 'מבצע פענוח XLSX בדפדפן';
        statusBar.classList.add('animate-pulse');
      } else {
        statusBar.classList.remove('animate-pulse');
      }
    }

    function humanNumber(n) {
      return n.toLocaleString('he-IL');
    }

    function updateSuccessUI(filename, rows) {
      statusTitle.textContent = 'קובץ נטען';
      statusSub.textContent   = `${filename} • ${humanNumber(rows)} שורות`;
      chipRows.textContent    = `${humanNumber(rows)} שורות`;
      chipRows.classList.remove('hidden');

      resultTitle.textContent = 'הקובץ נקלט בהצלחה';
      resultSub.textContent   = `${filename} • ${humanNumber(rows)} שורות • ${new Date().toLocaleString('he-IL')}`;
      rowsPill.textContent    = `${humanNumber(rows)} שורות`;
      rowsPill.classList.remove('hidden');
      // וי ירוק
      resultIcon.innerHTML    = `<path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
      resultIcon.classList.remove('text-amber-400','text-rose-400');
      resultIcon.classList.add('text-emerald-400');

      resultLine.classList.remove('hidden');
    }

    function updateErrorUI(message) {
      statusTitle.textContent = 'שגיאה בקליטת הקובץ';
      statusSub.textContent   = message || 'בדקי שהקובץ הוא ‎.xlsx תקין';
      chipRows.classList.add('hidden');

      resultTitle.textContent = 'לא נקלט';
      resultSub.textContent   = message || 'הקובץ לא זוהה כ־XLSX או שאין בו נתונים';
      // איקס אדום
      resultIcon.innerHTML    = `<path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      resultIcon.classList.remove('text-emerald-400','text-amber-400');
      resultIcon.classList.add('text-rose-400');

      rowsPill.classList.add('hidden');
      resultLine.classList.remove('hidden');
    }

    // ===== Core XLSX parse =====
    async function handleFile(file) {
      if (!file) return;
      setLoadingState(true);

      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        const first = wb.SheetNames?.[0];
        if (!first) {
          updateErrorUI('לא נמצאו גיליונות בקובץ.');
          setLoadingState(false);
          return;
        }

        // ל־JSON (Header-row auto)
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

        const rows = json.length;
        if (rows === 0) {
          updateErrorUI('הקובץ ריק או שמות העמודות לא זוהו.');
        } else {
          updateSuccessUI(file.name, rows);
        }
      } catch (err) {
        console.error(err);
        updateErrorUI('שגיאה בקריאת הקובץ. נסי לשמור מחדש כ־XLSX ולנסות שוב.');
      } finally {
        setLoadingState(false);
      }
    }

    // ===== Inputs & DragDrop =====
    const fileInput = $('fileInput');
    const dropzone  = $('dropzone');

    fileInput.addEventListener('change', (e) => handleFile(e.target.files?.[0]));

    // הפיכת ה־div ללחיץ לבחירת קובץ
    dropzone.addEventListener('click', () => fileInput.click());

    ;['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      })
    );
    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });
  </script>
  <!-- === STEP 2: KPIs + Department Tabs (Asia/Jerusalem) === -->
<script>
(() => {
  const TZ = 'Asia/Jerusalem';
  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה'];
  const DEPT_COL = 'מחלקה מטפלת';
  const OPEN_DATE_COL_KEYS = ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'];

  // ---------- DOM: insert KPIs + tabs block ----------
  const main = document.querySelector('main') || document.body;
  const blockHTML = `
    <section id="biStep2" class="max-w-6xl mx-auto px-4 mt-6">
      <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 2</span>
          <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">TZ: Asia/Jerusalem</span>
        </div>

        <!-- Tabs (departments) -->
        <div>
          <div class="text-sm text-ink-200/80 mb-2">טאבים לפי מחלקה מטפלת</div>
          <div id="deptTabs" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- KPI row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" id="kpiRow">
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">סה״כ פניות פתוחות</div>
            <div id="kpiOpenTotal" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו היום</div>
            <div id="kpiOpenedToday" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו אתמול</div>
            <div id="kpiOpenedYesterday" class="text-3xl font-bold mt-1">—</div>
          </div>
        </div>

        <div class="mt-6 text-[11px] text-ink-200/60">
          תאריכים מעובדים לפי אזור זמן ישראל ומנורמלים לתאריך בלבד (dd/mm/yyyy) עבור החישובים של היום/אתמול.
        </div>
      </div>
    </section>
  `;
  main.insertAdjacentHTML('beforeend', blockHTML);

  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const kpiOpenTotal       = $('kpiOpenTotal');
  const kpiOpenedToday     = $('kpiOpenedToday');
  const kpiOpenedYesterday = $('kpiOpenedYesterday');
  const deptTabs           = $('deptTabs');

  function toPartsYMDInTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y: +map.year, m: +map.month, d: +map.day };
  }
  function ymdKey(ymd) { return `${ymd.y}-${String(ymd.m).padStart(2,'0')}-${String(ymd.d).padStart(2,'0')}`; }

  function todayYMD() { return toPartsYMDInTZ(new Date()); }
  function yesterdayYMD() {
    // בונים תאריך מקומי של היום ב־TZ ואז מחסרים יום אחד
    const t = todayYMD();
    const asUTC = new Date(Date.UTC(t.y, t.m - 1, t.d)); // חצות מקומי בקירוב
    const y = new Date(asUTC.getTime() - 24*60*60*1000);
    return toPartsYMDInTZ(y);
  }

  function normalizeDateOnly(cellVal) {
    // מקבל מחרוזת/מספר/Date מתוך העמודה "תאריך/שעת פתיחה" ומחזיר מפתח תאריך (yyyy-mm-dd) לפי TZ
    if (cellVal == null || cellVal === '') return null;

    // אם זה מספר אקסל (serial)
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = cellVal * 24*60*60*1000;
      const d = new Date(excelEpoch.getTime() + ms);
      return ymdKey(toPartsYMDInTZ(d));
    }

    // אם זה מחרוזת תאריך/שעה — נותן ל־Date לפרש, ואז מנרמל לפי TZ
    const d = new Date(cellVal);
    if (!isNaN(d)) {
      return ymdKey(toPartsYMDInTZ(d));
    }

    // ניסיון לפורמט dd/mm/yyyy hh:mm
    const m = String(cellVal).match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m) {
      let [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
      if (yyyy.length === 2) yyyy = '20' + yyyy;
      const d2 = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:${SS || '00'}`);
      return ymdKey(toPartsYMDInTZ(d2));
    }
    return null;
  }

  function findCol(obj, keys) {
    for (const k of keys) if (k in obj) return k;
    // נסיון התאמה רכה בלי ניקוד/רווחים
    const norm = (s) => s.replace(/\s+/g,'').toLowerCase();
    const target = keys.map(norm);
    for (const k in obj) if (target.includes(norm(k))) return k;
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true; // אם אין סטטוס – נספר כפתוח
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function deptOf(row) {
    return row[DEPT_COL] ?? row['מחלקה'] ?? row['מחלקה מטפלת '] ?? 'לא מוגדר';
  }

  // ---------- Data store ----------
  let __dataset = [];        // כל השורות (JSON)
  let __departments = [];    // רשימת מחלקות
  let __activeDept = 'כללי'; // טאב נוכחי

  function renderTabs() {
    deptTabs.innerHTML = '';
    const all = ['כללי', ...__departments];
    for (const name of all) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = [
        'px-3 py-1.5 rounded-full border text-sm',
        (__activeDept === name)
          ? 'bg-gradient-to-r from-brand-600 to-gold-500 border-transparent font-semibold'
          : 'bg-white/5 border-white/10 hover:border-white/20'
      ].join(' ');
      btn.textContent = name;
      btn.addEventListener('click', () => {
        __activeDept = name;
        renderTabs();
        computeAndRenderKPIs();
      });
      deptTabs.appendChild(btn);
    }
  }

  function computeAndRenderKPIs() {
    const todayKey = ymdKey(todayYMD());
    const yestKey  = ymdKey(yesterdayYMD());

    // סינון לפי טאב (לא מסנן גלובלי, רק לתצוגה)
    const scoped = __activeDept === 'כללי'
      ? __dataset
      : __dataset.filter(r => String(deptOf(r)) === __activeDept);

    // תאריך פתיחה מקומי (תאריך בלבד)
    const dateKeyOf = (row) => {
      const col = findCol(row, OPEN_DATE_COL_KEYS);
      return col ? normalizeDateOnly(row[col]) : null;
    };

    const openRows = scoped.filter(isOpenRow);
    const openedToday = openRows.filter(r => dateKeyOf(r) === todayKey);
    const openedYesterday = openRows.filter(r => dateKeyOf(r) === yestKey);

    kpiOpenTotal.textContent       = openRows.length.toLocaleString('he-IL');
    kpiOpenedToday.textContent     = openedToday.length.toLocaleString('he-IL');
    kpiOpenedYesterday.textContent = openedYesterday.length.toLocaleString('he-IL');
  }

  // ---------- Hook into existing upload flow without modifying it ----------
  // נשמור את הקובץ האחרון כדי שנוכל לנתח מחדש (לא מתערבים בפונקציות הקיימות)
  window.__lastFile = null;
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) window.__lastFile = e.target.files[0];
    });
  }
  if (dropzone) {
    dropzone.addEventListener('drop', (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) window.__lastFile = f;
    });
  }

  // עוטפים את updateSuccessUI כדי להריץ עיבוד אנליטי לאחר שהקובץ נקלט בהצלחה
  if (typeof window.updateSuccessUI === 'function') {
    const __origUpdateSuccessUI = window.updateSuccessUI;
    window.updateSuccessUI = async function(filename, rows) {
      __origUpdateSuccessUI.apply(this, arguments);
      try {
        if (!window.__lastFile) return; // ביטחון כפול
        const buf = await window.__lastFile.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const first = wb.SheetNames && wb.SheetNames[0];
        if (!first) return;
        const sheet = wb.Sheets[first];
        const json  = XLSX.utils.sheet_to_json(sheet, { defval: null });

        __dataset = json;

        // מחלקות לטאבים
        const depts = new Set();
        for (const r of __dataset) depts.add(String(deptOf(r)));
        __departments = Array.from(depts).filter(x => x && x !== 'undefined');
        renderTabs();
        computeAndRenderKPIs();
      } catch (e) {
        console.error('BI step2 processing error:', e);
      }
    };
  }
})();
        </script>
  <!-- === STEP 3: Charts — Top Cities & Top Units (with "יחידת דואר: שם") === -->

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
(() => {
  // ---- תצורה ----
  const MIN_COUNT = 5;   // סף מינימום להצגה
  const TOP_N     = 10;  // מקסימום ערכים להצגה

  // שמות עמודות אפשריות
  const CITY_COL_KEYS = ['עיר','יישוב','יישוב/עיר','City','ישוב','יישוב לקוח'];
  const UNIT_COL_KEYS = [
    'שם יחידה',
    'יחידה',
    'שם יחידה מטפלת',
    'Unit',
    'שם-יחידה',
    'יחידת דואר: שם'   // העמודה המדויקת שלך
  ];

  // הוספת בלוק ל־DOM
  const main = document.querySelector('main') || document.body;
  const blockHTML = `
    <section id="biStep3" class="max-w-6xl mx-auto px-4 mt-6">
      <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
        <div class="flex items-center gap-3 mb-6">
          <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 3</span>
          <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">Top קטגוריות</span>
          <span class="ms-auto text-[11px] text-ink-200/60">סף תצוגה: ${MIN_COUNT}+ · עד ${TOP_N}</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-sm text-ink-200/80 mb-2">Top ערים לפי כמות פניות</div>
            <canvas id="chartCities" height="220"></canvas>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-sm text-ink-200/80 mb-2">Top יחידות דואר לפי כמות פניות</div>
            <canvas id="chartUnits" height="220"></canvas>
          </div>
        </div>

        <div class="mt-6 text-[11px] text-ink-200/60">
          מציג רק ערים/יחידות עם לפחות ${MIN_COUNT} פניות. אם אין נתונים — תופיע הודעה מתאימה.
        </div>
      </div>
    </section>
  `;
  main.insertAdjacentHTML('beforeend', blockHTML);

  // ---- Utilities ----
  function findCol(obj, keys) {
    for (const k of keys) if (k in obj) return k;
    const norm = (s) => s.replace(/\s+/g,'').toLowerCase();
                                                        </script>
<!-- === STEP 3 (NEW): Open Tickets Lists — By City & By Unit (threshold 100+) === -->
<script>
(() => {
  // ---- תצורה ----
  const MIN_COUNT = 100; // מציג רק קטגוריות עם 100+ פניות

  // שמות עמודות אפשריות
  const CITY_COL_KEYS = ['עיר','יישוב','יישוב/עיר','City','ישוב','יישוב לקוח'];
  const UNIT_COL_KEYS = ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','Unit','שם-יחידה'];

  // ---- DOM ----
  const main = document.querySelector('main') || document.body;
  const blockHTML = `
    <section id="biStep3Lists" class="max-w-6xl mx-auto px-4 mt-6">
      <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
        <div class="flex items-center gap-3 mb-6">
          <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 3 (רשימות)</span>
          <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">מציג רק 100+ פניות</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- By City -->
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי עיר (100+)</div>
            <div id="listByCity" class="divide-y divide-white/10"></div>
            <div id="msgCity" class="mt-3 text-xs text-ink-200/60"></div>
          </div>

          <!-- By Unit -->
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי "יחידת דואר: שם" (100+)</div>
            <div id="listByUnit" class="divide-y divide-white/10"></div>
            <div id="msgUnit" class="mt-3 text-xs text-ink-200/60"></div>
          </div>
        </div>
      </div>
    </section>
  `;
  main.insertAdjacentHTML('beforeend', blockHTML);

  // ---- Utilities (עצמאיות, לא תלויות בשלבים קודמים) ----
  function findCol(obj, keys) {
    if (!obj) return null;
    for (const k of keys) if (k in obj) return k;
    const norm = (s) => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = keys.map(norm);
    for (const k in obj) if (targets.includes(norm(k))) return k;
    return null;
  }

  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];
  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true; // אם אין סטטוס — נחשב כפתוח
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function aggregateOpenCounts(rows, colKeys) {
    if (!rows?.length) return { col: null, items: [] };
    const col = findCol(rows[0], colKeys);
    if (!col) return { col: null, items: [] };

    const map = new Map();
    for (const r of rows) {
      if (!isOpenRow(r)) continue;
      const raw = r[col];
      const key = (raw == null) ? '' : String(raw).trim();
      if (!key) continue;
      map.set(key, (map.get(key) || 0) + 1);
    }

    // סינון לפי מינימום, מיון יורד
    const items = Array.from(map.entries())
      .filter(([, c]) => c >= MIN_COUNT)
      .sort((a, b) => b[1] - a[1])
      .map(([name, count]) => ({ name, count }));

    return { col, items };
  }

  function renderList(containerId, items) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '';
    for (const it of items) {
      const row = document.createElement('div');
      row.className = 'py-2 flex items-center gap-3';
      row.innerHTML = `
        <span class="text-ink-50/90">${escapeHTML(it.name)}</span>
        <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10 font-semibold">
          ${it.count.toLocaleString('he-IL')} פניות
        </span>
      `;
      el.appendChild(row);
    }
  }

  function setMessage(msgId, haveCol, itemsLen, missingMsg, emptyMsg) {
    const m = document.getElementById(msgId);
    if (!m) return;
    if (!haveCol) m.textContent = missingMsg;
    else if (!itemsLen) m.textContent = emptyMsg;
    else m.textContent = '';
  }

  function escapeHTML(s) {
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // ---- רנדר ראשי ----
  function renderStep3Lists() {
    const rows = Array.isArray(window.__dataset) ? window.__dataset : [];

    const byCity = aggregateOpenCounts(rows, CITY_COL_KEYS);
    const byUnit = aggregateOpenCounts(rows, UNIT_COL_KEYS);

    renderList('listByCity', byCity.items);
    renderList('listByUnit', byUnit.items);

    setMessage(
      'msgCity',
      !!byCity.col,
      byCity.items.length,
      'לא נמצאה עמודת "עיר/יישוב" בקובץ.',
      `אין ערים עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.`
    );
    setMessage(
      'msgUnit',
      !!byUnit.col,
      byUnit.items.length,
      'לא נמצאה העמודה "יחידת דואר: שם" (או עמודה דומה) בקובץ.',
      `אין יחידות דואר עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.`
    );
  }

  // ---- חיבור לזרימה של שלב 1/2: לאחר קליטת קובץ נרנדר רשימות ----
  if (typeof window.updateSuccessUI === 'function') {
    const __prev = window.updateSuccessUI;
    window.updateSuccessUI = function() {
      __prev.apply(this, arguments);
      setTimeout(renderStep3Lists, 0);
    };
  }

  // אם כבר נטען קובץ קודם — ננסה לרנדר כעת
  if (Array.isArray(window.__dataset) && window.__dataset.length) {
    renderStep3Lists();
  }
})();
</script>
</body>
