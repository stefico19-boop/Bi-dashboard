<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת BI — העלאת קובץ</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ink: { 50:'#f8fafc', 100:'#eef2f6', 200:'#e2e8f0', 800:'#1f2937', 900:'#0b1220' },
            luxe: { 100:'#f3f4f6', 200:'#e5e7eb', 300:'#d1d5db', 700:'#374151', 900:'#111827' },
            brand: { 400:'#8b5cf6', 500:'#7c3aed', 600:'#6d28d9' },
            gold: { 400:'#f6c453', 500:'#f59e0b' }
          },
          boxShadow: {
            luxe: '0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)',
          },
          backdropBlur: { xs: '2px' },
          borderRadius: { '3xl': '1.5rem' }
        }
      }
    }
  </script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ברק יוקרתי דק לכפתורים/כרטיסים */
    .sheen {
      position: relative;
      overflow: hidden;
    }
    .sheen::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 300%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.15) 50%, transparent 65%);
      transform: rotate(15deg);
      animation: sheen 4s infinite;
    }
    @keyframes sheen {
      0%   { transform: translateX(-30%) translateY(-30%) rotate(15deg); }
      60%  { transform: translateX(60%) translateY(60%) rotate(15deg); }
      100% { transform: translateX(60%) translateY(60%) rotate(15deg); }
    }
    /* סלוט של גרירת קובץ */
    .dropzone.dragover { border-color: #8b5cf6; background: rgba(139,92,246,.06); }
  </style>
</head>

<body class="bg-gradient-to-b from-ink-900 via-[#0d1020] to-[#0a0f1c] text-white min-h-screen">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-6">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-brand-600 to-gold-500 flex items-center justify-center shadow-luxe sheen">
        <span class="font-black text-xl">BI</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">מערכת BI — קליטה חכמה של קבצי Excel</h1>
        <p class="text-sm text-ink-200/80">שלב 1: העלאת קובץ XLSX, ספירת שורות ועדכון סטטוס</p>
      </div>
    </div>
  </header>

  <!-- Card -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <section class="rounded-3xl sheen shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
      <!-- Status Row -->
      <div id="statusBar" class="flex flex-wrap items-center gap-3 rounded-2xl border border-white/10 bg-white/5 p-3">
        <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-ink-900/70 border border-white/10">
          <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4 text-ink-200">
            <path d="M12 2v4m0 12v4M4 12H2m20 0h-2M5 5l-2-2m16 16 2 2M19 5l2-2M5 19l-2 2" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </span>
        <div class="text-sm">
          <div class="font-semibold" id="statusTitle">מוכן לקליטת קובץ</div>
          <div class="text-ink-200/80" id="statusSub">בחרי קובץ ‎.xlsx או גררי לכרטיס</div>
        </div>
        <div class="ms-auto">
          <span id="chipRows" class="hidden text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 font-semibold shadow">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Uploader -->
      <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- File input -->
        <label class="block">
          <span class="text-sm text-ink-200/90 font-medium">בחרי קובץ XLSX</span>
          <input id="fileInput" type="file" accept=".xlsx,.xlsb,.xlsm,.xls"
                 class="mt-2 w-full file:me-4 file:px-4 file:py-2 file:rounded-xl file:border-0 file:bg-gradient-to-r file:from-brand-600 file:to-gold-500 file:text-white file:font-semibold file:cursor-pointer file:shadow hover:file:opacity-95
                        bg-white/5 border border-white/10 rounded-2xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/40"/>
        </label>

        <!-- Drag & Drop -->
        <div id="dropzone"
             class="dropzone rounded-2xl border-2 border-dashed border-white/15 bg-white/5 p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-brand-500/50 transition">
          <svg viewBox="0 0 24 24" fill="none" class="h-8 w-8 text-ink-200/80">
            <path d="M7 16a5 5 0 0 1 0-10 6 6 0 0 1 11 2 4 4 0 0 1 1 7" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 12v6m0-6 2 2m-2-2-2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <p class="mt-3 text-sm text-ink-200/85">
            גררי לכאן קובץ ‎.xlsx או הקליקי לבחירה
          </p>
        </div>
      </div>

      <!-- Result line -->
      <div id="resultLine" class="mt-6 hidden rounded-xl bg-ink-900/60 border border-white/10 p-4 text-sm">
        <div class="flex items-center gap-2">
          <svg id="resultIcon" viewBox="0 0 24 24" fill="none" class="h-5 w-5 text-emerald-400">
            <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div id="resultTitle" class="font-semibold">הקובץ נקלט בהצלחה</div>
            <div id="resultSub" class="text-ink-200/80">שם קובץ • שורות • תאריך</div>
          </div>
          <span id="rowsPill" class="ms-auto hidden px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/40">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Tiny footer -->
      <div class="mt-8 text-[11px] text-ink-200/60">
        טיפ: בשלב הבא נוסיף תצוגה מקדימה וטיפול בתאריכים/שעות וסכימות SLA.
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    const statusBar   = $('statusBar');
    const statusTitle = $('statusTitle');
    const statusSub   = $('statusSub');
    const chipRows    = $('chipRows');
    const resultLine  = $('resultLine');
    const resultTitle = $('resultTitle');
    const resultSub   = $('resultSub');
    const rowsPill    = $('rowsPill');
    const resultIcon  = $('resultIcon');

    function setLoadingState(isLoading) {
      if (isLoading) {
        statusTitle.textContent = 'טוען קובץ...';
        statusSub.textContent   = 'מבצע פענוח XLSX בדפדפן';
        statusBar.classList.add('animate-pulse');
      } else {
        statusBar.classList.remove('animate-pulse');
      }
    }

    function humanNumber(n) {
      return n.toLocaleString('he-IL');
    }

    function updateSuccessUI(filename, rows) {
      statusTitle.textContent = 'קובץ נטען';
      statusSub.textContent   = `${filename} • ${humanNumber(rows)} שורות`;
      chipRows.textContent    = `${humanNumber(rows)} שורות`;
      chipRows.classList.remove('hidden');

      resultTitle.textContent = 'הקובץ נקלט בהצלחה';
      resultSub.textContent   = `${filename} • ${humanNumber(rows)} שורות • ${new Date().toLocaleString('he-IL')}`;
      rowsPill.textContent    = `${humanNumber(rows)} שורות`;
      rowsPill.classList.remove('hidden');
      // וי ירוק
      resultIcon.innerHTML    = `<path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
      resultIcon.classList.remove('text-amber-400','text-rose-400');
      resultIcon.classList.add('text-emerald-400');

      resultLine.classList.remove('hidden');
    }

    function updateErrorUI(message) {
      statusTitle.textContent = 'שגיאה בקליטת הקובץ';
      statusSub.textContent   = message || 'בדקי שהקובץ הוא ‎.xlsx תקין';
      chipRows.classList.add('hidden');

      resultTitle.textContent = 'לא נקלט';
      resultSub.textContent   = message || 'הקובץ לא זוהה כ־XLSX או שאין בו נתונים';
      // איקס אדום
      resultIcon.innerHTML    = `<path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      resultIcon.classList.remove('text-emerald-400','text-amber-400');
      resultIcon.classList.add('text-rose-400');

      rowsPill.classList.add('hidden');
      resultLine.classList.remove('hidden');
    }

    // ===== Core XLSX parse =====
    async function handleFile(file) {
      if (!file) return;
      setLoadingState(true);

      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        const first = wb.SheetNames?.[0];
        if (!first) {
          updateErrorUI('לא נמצאו גיליונות בקובץ.');
          setLoadingState(false);
          return;
        }

        // ל־JSON (Header-row auto)
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

        const rows = json.length;
        if (rows === 0) {
          updateErrorUI('הקובץ ריק או שמות העמודות לא זוהו.');
        } else {
          updateSuccessUI(file.name, rows);
        }
      } catch (err) {
        console.error(err);
        updateErrorUI('שגיאה בקריאת הקובץ. נסי לשמור מחדש כ־XLSX ולנסות שוב.');
      } finally {
        setLoadingState(false);
      }
    }

    // ===== Inputs & DragDrop =====
    const fileInput = $('fileInput');
    const dropzone  = $('dropzone');

    fileInput.addEventListener('change', (e) => handleFile(e.target.files?.[0]));

    // הפיכת ה־div ללחיץ לבחירת קובץ
    dropzone.addEventListener('click', () => fileInput.click());

    ;['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      })
    );
    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });
  </script>
  <!-- === STEP 2: KPIs + Department Tabs (Asia/Jerusalem) === -->
<script>
(() => {
  const TZ = 'Asia/Jerusalem';
  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה'];
  const DEPT_COL = 'מחלקה מטפלת';
  const OPEN_DATE_COL_KEYS = ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'];

  // ---------- DOM: insert KPIs + tabs block ----------
  const main = document.querySelector('main') || document.body;
  const blockHTML = `
    <section id="biStep2" class="max-w-6xl mx-auto px-4 mt-6">
      <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 2</span>
          <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">TZ: Asia/Jerusalem</span>
        </div>

        <!-- Tabs (departments) -->
        <div>
          <div class="text-sm text-ink-200/80 mb-2">טאבים לפי מחלקה מטפלת</div>
          <div id="deptTabs" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- KPI row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" id="kpiRow">
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">סה״כ פניות פתוחות</div>
            <div id="kpiOpenTotal" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו היום</div>
            <div id="kpiOpenedToday" class="text-3xl font-bold mt-1">—</div>
          </div>
          <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
            <div class="text-xs text-ink-200/70">נפתחו אתמול</div>
            <div id="kpiOpenedYesterday" class="text-3xl font-bold mt-1">—</div>
          </div>
        </div>

        <div class="mt-6 text-[11px] text-ink-200/60">
          תאריכים מעובדים לפי אזור זמן ישראל ומנורמלים לתאריך בלבד (dd/mm/yyyy) עבור החישובים של היום/אתמול.
        </div>
      </div>
    </section>
  `;
  main.insertAdjacentHTML('beforeend', blockHTML);

  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const kpiOpenTotal       = $('kpiOpenTotal');
  const kpiOpenedToday     = $('kpiOpenedToday');
  const kpiOpenedYesterday = $('kpiOpenedYesterday');
  const deptTabs           = $('deptTabs');

  function toPartsYMDInTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y: +map.year, m: +map.month, d: +map.day };
  }
  function ymdKey(ymd) { return `${ymd.y}-${String(ymd.m).padStart(2,'0')}-${String(ymd.d).padStart(2,'0')}`; }

  function todayYMD() { return toPartsYMDInTZ(new Date()); }
  function yesterdayYMD() {
    // בונים תאריך מקומי של היום ב־TZ ואז מחסרים יום אחד
    const t = todayYMD();
    const asUTC = new Date(Date.UTC(t.y, t.m - 1, t.d)); // חצות מקומי בקירוב
    const y = new Date(asUTC.getTime() - 24*60*60*1000);
    return toPartsYMDInTZ(y);
  }

  function normalizeDateOnly(cellVal) {
    // מקבל מחרוזת/מספר/Date מתוך העמודה "תאריך/שעת פתיחה" ומחזיר מפתח תאריך (yyyy-mm-dd) לפי TZ
    if (cellVal == null || cellVal === '') return null;

    // אם זה מספר אקסל (serial)
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = cellVal * 24*60*60*1000;
      const d = new Date(excelEpoch.getTime() + ms);
      return ymdKey(toPartsYMDInTZ(d));
    }

    // אם זה מחרוזת תאריך/שעה — נותן ל־Date לפרש, ואז מנרמל לפי TZ
    const d = new Date(cellVal);
    if (!isNaN(d)) {
      return ymdKey(toPartsYMDInTZ(d));
    }

    // ניסיון לפורמט dd/mm/yyyy hh:mm
    const m = String(cellVal).match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m) {
      let [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
      if (yyyy.length === 2) yyyy = '20' + yyyy;
      const d2 = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:${SS || '00'}`);
      return ymdKey(toPartsYMDInTZ(d2));
    }
    return null;
  }

  function findCol(obj, keys) {
    for (const k of keys) if (k in obj) return k;
    // נסיון התאמה רכה בלי ניקוד/רווחים
    const norm = (s) => s.replace(/\s+/g,'').toLowerCase();
    const target = keys.map(norm);
    for (const k in obj) if (target.includes(norm(k))) return k;
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true; // אם אין סטטוס – נספר כפתוח
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function deptOf(row) {
    return row[DEPT_COL] ?? row['מחלקה'] ?? row['מחלקה מטפלת '] ?? 'לא מוגדר';
  }

  // ---------- Data store ----------
  let __dataset = [];        // כל השורות (JSON)
  let __departments = [];    // רשימת מחלקות
  let __activeDept = 'כללי'; // טאב נוכחי

  function renderTabs() {
    deptTabs.innerHTML = '';
    const all = ['כללי', ...__departments];
    for (const name of all) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = [
        'px-3 py-1.5 rounded-full border text-sm',
        (__activeDept === name)
          ? 'bg-gradient-to-r from-brand-600 to-gold-500 border-transparent font-semibold'
          : 'bg-white/5 border-white/10 hover:border-white/20'
      ].join(' ');
      btn.textContent = name;
      btn.addEventListener('click', () => {
        __activeDept = name;
        renderTabs();
        computeAndRenderKPIs();
      });
      deptTabs.appendChild(btn);
    }
  }

  function computeAndRenderKPIs() {
    const todayKey = ymdKey(todayYMD());
    const yestKey  = ymdKey(yesterdayYMD());

    // סינון לפי טאב (לא מסנן גלובלי, רק לתצוגה)
    const scoped = __activeDept === 'כללי'
      ? __dataset
      : __dataset.filter(r => String(deptOf(r)) === __activeDept);

    // תאריך פתיחה מקומי (תאריך בלבד)
    const dateKeyOf = (row) => {
      const col = findCol(row, OPEN_DATE_COL_KEYS);
      return col ? normalizeDateOnly(row[col]) : null;
    };

    const openRows = scoped.filter(isOpenRow);
    const openedToday = openRows.filter(r => dateKeyOf(r) === todayKey);
    const openedYesterday = openRows.filter(r => dateKeyOf(r) === yestKey);

    kpiOpenTotal.textContent       = openRows.length.toLocaleString('he-IL');
    kpiOpenedToday.textContent     = openedToday.length.toLocaleString('he-IL');
    kpiOpenedYesterday.textContent = openedYesterday.length.toLocaleString('he-IL');
  }

  // ---------- Hook into existing upload flow without modifying it ----------
  // נשמור את הקובץ האחרון כדי שנוכל לנתח מחדש (לא מתערבים בפונקציות הקיימות)
  window.__lastFile = null;
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) window.__lastFile = e.target.files[0];
    });
  }
  if (dropzone) {
    dropzone.addEventListener('drop', (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) window.__lastFile = f;
    });
  }

  // עוטפים את updateSuccessUI כדי להריץ עיבוד אנליטי לאחר שהקובץ נקלט בהצלחה
  if (typeof window.updateSuccessUI === 'function') {
    const __origUpdateSuccessUI = window.updateSuccessUI;
    window.updateSuccessUI = async function(filename, rows) {
      __origUpdateSuccessUI.apply(this, arguments);
      try {
        if (!window.__lastFile) return; // ביטחון כפול
        const buf = await window.__lastFile.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const first = wb.SheetNames && wb.SheetNames[0];
        if (!first) return;
        const sheet = wb.Sheets[first];
        const json  = XLSX.utils.sheet_to_json(sheet, { defval: null });

        __dataset = json;

        // מחלקות לטאבים
        const depts = new Set();
        for (const r of __dataset) depts.add(String(deptOf(r)));
        __departments = Array.from(depts).filter(x => x && x !== 'undefined');
        renderTabs();
        computeAndRenderKPIs();
      } catch (e) {
        console.error('BI step2 processing error:', e);
      }
    };
  }
})();
        </script>
  <!-- === STEP 3 (REBUILT): Open tickets lists by City & "יחידת דואר: שם" (100+) === -->
<section id="biStep3Lists" class="max-w-6xl mx-auto px-4 mt-6">
  <div class="rounded-3xl shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-sm font-semibold text-ink-200/80">אנליטיקה — שלב 3 (רשימות)</span>
      <span class="text-[11px] px-2 py-1 rounded-full bg-white/10 border border-white/10">מציג רק 100+ פניות</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- By City -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי עיר (100+)</div>
        <div id="listByCity" class="divide-y divide-white/10"></div>
        <div id="msgCity" class="mt-3 text-xs text-ink-200/60"></div>
      </div>
      <!-- By Unit -->
      <div class="rounded-2xl bg-ink-900/60 border border-white/10 p-4">
        <div class="text-sm font-semibold text-ink-200/85 mb-3">פניות פתוחות לפי "יחידת דואר: שם" (100+)</div>
        <div id="listByUnit" class="divide-y divide-white/10"></div>
        <div id="msgUnit" class="mt-3 text-xs text-ink-200/60"></div>
      </div>
    </div>
  </div>
</section>

<script>
(() => {
  const MIN_COUNT = 100;

  // -------- Normalization helpers (עמודות בעברית לפעמים עם ניקוד/רווחים/נקודתיים) --------
  const HEB_DIACRITICS = /[\u0591-\u05C7]/g; // ניקוד
  function normHeader(s) {
    return String(s)
      .replace(HEB_DIACRITICS, '')          // בלי ניקוד
      .replace(/[·•:;|/_\-()\[\]{}]/g,'')   // בלי תווים מפרידים
      .replace(/\s+/g,'')                   // בלי רווחים
      .toLowerCase();
  }
  // בודק אם שם עמודה מכיל את כל מילות המפתח לאחר נירמול
  function headerIncludesAll(colName, keywords) {
    const n = normHeader(colName);
    return keywords.every(k => n.includes(normHeader(k)));
  }

  // התאמות גמישות לשמות עמודות:
  // עיר/יישוב
  const CITY_EXACT = ['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'];
  const CITY_KEYWORDS = [['עיר'], ['יישוב']]; // מספיק שאחד הסטים יתקיים
  // יחידה
  const UNIT_EXACT = ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'];
  const UNIT_KEYWORDS = [['יחידת','דואר','שם'], ['שם','יחידה']];

  const OPEN_STATUS_COLS = ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];

  function findColumnFlexible(row0, exactList, keywordSets) {
    if (!row0) return null;
    const headers = Object.keys(row0);
    // 1) ניסיון התאמה מדויקת
    for (const h of headers) {
      if (exactList.includes(h)) return h;
      // התאמה מדויקת גם אחרי נירמול בסיסי
      const hNorm = normHeader(h);
      for (const ex of exactList) {
        if (hNorm === normHeader(ex)) return h;
      }
    }
    // 2) ניסיון התאמה לפי מילות מפתח (כל הסט חייב להיות כלול)
    for (const h of headers) {
      if (keywordSets.some(kwSet => headerIncludesAll(h, kwSet))) {
        return h;
      }
    }
    return null;
  }

  function findCol(row, candidates) {
    if (!row) return null;
    for (const c of candidates) if (c in row) return c;
    // התאמה אחרי נירמול
    const target = candidates.map(normHeader);
    for (const k in row) if (target.includes(normHeader(k))) return k;
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COLS);
    if (!key) return true;
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
  }

  function aggregateCounts(rows, which) {
    if (!rows?.length) return { col: null, items: [] };

    let col = null;
    if (which === 'city') {
      col = findColumnFlexible(rows[0], CITY_EXACT, CITY_KEYWORDS);
    } else if (which === 'unit') {
      col = findColumnFlexible(rows[0], UNIT_EXACT, UNIT_KEYWORDS);
    }
    if (!col) return { col: null, items: [] };

    const map = new Map();
    for (const r of rows) {
      if (!isOpenRow(r)) continue;
      const raw = r[col];
      const key = (raw == null) ? '' : String(raw).trim();
      if (!key) continue;
      map.set(key, (map.get(key) || 0) + 1);
    }

    const items = Array.from(map.entries())
      .filter(([, c]) => c >= MIN_COUNT)
      .sort((a,b) => b[1] - a[1])
      .map(([name,count]) => ({ name, count }));

    return { col, items };
  }

  function escapeHTML(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function renderList(containerId, items) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '';
    for (const it of items) {
      const row = document.createElement('div');
      row.className = 'py-2 flex items-center gap-3';
      row.innerHTML = `
        <span class="text-ink-50/90">${escapeHTML(it.name)}</span>
        <span class="ms-auto text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/10 font-semibold">
          ${it.count.toLocaleString('he-IL')} פניות
        </span>`;
      el.appendChild(row);
    }
  }

  async function ensureDatasetFromLastFile() {
    // אם אין __dataset אבל יש קובץ אחרון — נטעין אותו (לא פוגע בזרימה הקיימת)
    if (Array.isArray(window.__dataset) && window.__dataset.length) return;
    if (!window.__lastFile || !window.XLSX) return;
    try {
      const buf = await window.__lastFile.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const first = wb.SheetNames && wb.SheetNames[0];
      if (!first) return;
      const sheet = wb.Sheets[first];
      window.__dataset = XLSX.utils.sheet_to_json(sheet, { defval: null });
    } catch (e) {
      console.warn('ensureDatasetFromLastFile failed:', e);
    }
  }

  async function renderStep3() {
    await ensureDatasetFromLastFile();
    const rows = Array.isArray(window.__dataset) ? window.__dataset : [];

    const byCity = aggregateCounts(rows, 'city');
    const byUnit = aggregateCounts(rows, 'unit');

    renderList('listByCity', byCity.items);
    renderList('listByUnit', byUnit.items);

    const msgCity = document.getElementById('msgCity');
    const msgUnit = document.getElementById('msgUnit');

    msgCity.textContent = !byCity.col
      ? 'לא נמצאה עמודה מתאימה לעיר/יישוב (ניסינו גם וריאציות וניקוי ניקוד).'
      : (!byCity.items.length ? `אין ערים עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.` : '');

    msgUnit.textContent = !byUnit.col
      ? 'לא נמצאה עמודה מתאימה ל"יחידת דואר: שם" (כולל וריאציות כמו "שם יחידה").'
      : (!byUnit.items.length ? `אין יחידות עם לפחות ${MIN_COUNT.toLocaleString('he-IL')} פניות פתוחות.` : '');
  }

  // להתחבר לפלואו הקיים אחרי קליטת קובץ
  if (typeof window.updateSuccessUI === 'function') {
    const __prev = window.updateSuccessUI;
    window.updateSuccessUI = function() {
      __prev.apply(this, arguments);
      setTimeout(renderStep3, 0);
    };
  }

  // אם כבר נטען קובץ בעבר — נרנדר עכשיו
  if (Array.isArray(window.__dataset) && window.__dataset.length) {
    renderStep3();
  }
})();
</script>
  <!-- === STEP 4: Click-to-Table + Export to XLSX === -->
<script>
(() => {
  // ----- קבועים ועזרי תאריכים (תואם שלב 2) -----
  const TZ = 'Asia/Jerusalem';
  const OPEN_STATUS_COL_KEYS = ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'];
  const OPEN_DATE_COL_KEYS   = ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'];

  function toPartsYMDInTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d);
    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y: +map.year, m: +map.month, d: +map.day };
  }
  function ymdKey(ymd) { return `${ymd.y}-${String(ymd.m).padStart(2,'0')}-${String(ymd.d).padStart(2,'0')}`; }
  function todayKey(){ return ymdKey(toPartsYMDInTZ(new Date())); }
  function yesterdayKey(){
    const t = toPartsYMDInTZ(new Date());
    const asUTC = new Date(Date.UTC(t.y, t.m-1, t.d));
    return ymdKey(toPartsYMDInTZ(new Date(asUTC.getTime()-24*60*60*1000)));
  }

  // התאמות עמודות
  function findCol(obj, keys) {
    if (!obj) return null;
    for (const k of keys) if (k in obj) return k;
    const norm = (s) => String(s).replace(/\s+/g,'').toLowerCase();
    const target = keys.map(norm);
    for (const k in obj) if (target.includes(norm(k))) return k;
    return null;
  }

  // נירמול תאריך/שעה של "תאריך/שעת פתיחה" לתאריך בלבד לפי ישראל
  function normalizeDateOnly(cellVal) {
    if (cellVal == null || cellVal === '') return null;
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = cellVal * 24*60*60*1000;
      const d = new Date(excelEpoch.getTime() + ms);
      return ymdKey(toPartsYMDInTZ(d));
    }
    const d = new Date(cellVal);
    if (!isNaN(d)) return ymdKey(toPartsYMDInTZ(d));
    const m = String(cellVal).match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m) {
      let [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
      if (yyyy.length === 2) yyyy = '20' + yyyy;
      const d2 = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${HH.padStart(2,'0')}:${MM}:${SS || '00'}`);
      return ymdKey(toPartsYMDInTZ(d2));
    }
    return null;
  }

  function isOpenRow(row) {
    const key = findCol(row, OPEN_STATUS_COL_KEYS);
    if (!key) return true;
    const val = String(row[key] ?? '').trim();
    const closed = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];
    return !closed.some(c => val === c || val.includes(c));
    }

  // ----- Modal (נוצר פעם אחת) -----
  const modalHTML = `
    <div id="biModal" class="fixed inset-0 z-[1000] hidden">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10 shadow-luxe">
        <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
          <div class="text-lg font-bold" id="biModalTitle">נתונים</div>
          <button id="biExportBtn" class="ms-auto px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20 hover:bg-white/15">
            ייצוא ל-XLSX
          </button>
          <button id="biCloseBtn" class="ms-2 px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20 hover:bg-white/15">סגירה</button>
        </div>
        <div class="p-4 overflow-auto" style="max-height:70vh">
          <table id="biTable" class="w-full text-sm border-separate border-spacing-0">
            <thead id="biThead"></thead>
            <tbody id="biTbody"></tbody>
          </table>
          <div id="biEmpty" class="text-ink-200/70 text-sm p-4 hidden">אין נתונים להצגה.</div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  const modal = document.getElementById('biModal');
  const tHead = document.getElementById('biThead');
  const tBody = document.getElementById('biTbody');
  const empty = document.getElementById('biEmpty');
  const title = document.getElementById('biModalTitle');
  const btnClose = document.getElementById('biCloseBtn');
  const btnExport = document.getElementById('biExportBtn');

  btnClose.addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

  // ----- רנדר טבלה + יצוא -----
  let currentRows = [];
  function renderTable(rows) {
    currentRows = rows || [];
    if (!rows.length) {
      tHead.innerHTML = ''; tBody.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    // כותרות לפי איחוד כל המפתחות הראשונים (שומר על סדר עמודות כפי שבקובץ לרוב)
    const headers = Array.from(rows.reduce((set, r) => {
      Object.keys(r).forEach(k => set.add(k));
      return set;
    }, new Set()));

    // THEAD
    tHead.innerHTML = `<tr>${
      headers.map(h => `<th class="sticky top-0 bg-[#0b1220] text-ink-200/80 font-semibold px-3 py-2 border-b border-white/10 text-right">${escapeHTML(h)}</th>`).join('')
    }</tr>`;

    // TBODY
    tBody.innerHTML = rows.map(r => `
      <tr class="hover:bg-white/5">
        ${headers.map(h => `<td class="px-3 py-2 border-b border-white/5 align-top">${escapeHTML(r[h] ?? '')}</td>`).join('')}
      </tr>
    `).join('');
  }

  function exportXLSX(filename='export.xlsx') {
    if (!window.XLSX) return alert('ספריית XLSX לא נטענה.');
    const ws = XLSX.utils.json_to_sheet(currentRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, filename);
  }
  btnExport.addEventListener('click', () => exportXLSX(title.dataset.filename || 'export.xlsx'));

  function openModal(rows, modalTitle, fileNameBase='export') {
    title.textContent = modalTitle;
    title.dataset.filename = `${fileNameBase}.xlsx`;
    renderTable(rows);
    modal.classList.remove('hidden');
  }

  function escapeHTML(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  // ----- פילטרים לפי הקלקה -----
  function getDataset() {
    return Array.isArray(window.__dataset) ? window.__dataset : [];
  }

  // 1) KPI-ים
  const elTotal = document.getElementById('kpiOpenTotal');
  const elToday = document.getElementById('kpiOpenedToday');
  const elYest  = document.getElementById('kpiOpenedYesterday');

  function rowsOpenTotal() {
    const rows = getDataset();
    return rows.filter(isOpenRow);
  }
  function rowsOpenedDay(key) {
    const rows = getDataset();
    const dateCol = rows.length ? findCol(rows[0], OPEN_DATE_COL_KEYS) : null;
    if (!dateCol) return [];
    return rows.filter(r => isOpenRow(r) && normalizeDateOnly(r[dateCol]) === key);
  }

  // UX: להפוך את המספרים ל"קליקאבלים"
  [elTotal, elToday, elYest].forEach(el => {
    if (el) {
      el.classList.add('cursor-pointer','underline','underline-offset-4','decoration-white/30');
      el.setAttribute('title','לחיצה להצגת הטבלה');
    }
  });

  elTotal?.addEventListener('click', () => {
    const rows = rowsOpenTotal();
    openModal(rows, 'כל הפניות הפתוחות', 'open_tickets');
  });
  elToday?.addEventListener('click', () => {
    const rows = rowsOpenedDay(todayKey());
    openModal(rows, 'פניות שנפתחו היום', 'opened_today');
  });
  elYest?.addEventListener('click', () => {
    const rows = rowsOpenedDay(yesterdayKey());
    openModal(rows, 'פניות שנפתחו אתמול', 'opened_yesterday');
  });

  // 2) רשימות שלב 3 – עיר / יחידה
  //    מאזינים ב-delegation לקונטיינרים שהוגדרו בשלב 3: listByCity, listByUnit
  function attachListClick(containerId, nameSelectorIndex, filterFn, titlePrefix, filePrefix) {
    const box = document.getElementById(containerId);
    if (!box) return;
    box.addEventListener('click', (e) => {
      // השורה היא div עם שני span-ים; ניקח את הטקסט של הראשון (שם הקטגוריה)
      const row = e.target.closest('div.py-2');
      if (!row) return;
      const nameEl = row.querySelector('span');
      if (!nameEl) return;
      const name = nameEl.textContent.trim();
      if (!name) return;
      const rows = filterFn(name);
      openModal(rows, `${titlePrefix} — ${name}`, `${filePrefix}_${sanitizeFileName(name)}`);
    });
    // עכבר מצביע
    box.classList.add('cursor-pointer');
  }

  function sanitizeFileName(s) {
    return s.replace(/[\\/:*?"<>|]+/g,'_').slice(0,60);
  }

  // מסננים לפי עיר/יחידה
  // התאמות עמודות גמישות (תואם שלב 3 החדש)
  const HEB_DIACRITICS = /[\u0591-\u05C7]/g;
  function normHeader(s) {
    return String(s).replace(HEB_DIACRITICS,'').replace(/[·•:;|/_\-()\[\]{}]/g,'').replace(/\s+/g,'').toLowerCase();
  }
  function headerIncludesAll(colName, keywords) {
    const n = normHeader(colName);
    return keywords.every(k => n.includes(normHeader(k)));
  }
  const CITY_EXACT = ['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'];
  const CITY_KEYWORDS = [['עיר'], ['יישוב']];
  const UNIT_EXACT = ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם'];
  const UNIT_KEYWORDS = [['יחידת','דואר','שם'], ['שם','יחידה']];

  function findColumnFlexible(row0, exactList, keywordSets) {
    if (!row0) return null;
    const headers = Object.keys(row0);
    for (const h of headers) {
      if (exactList.includes(h)) return h;
      const hNorm = normHeader(h);
      for (const ex of exactList) if (hNorm === normHeader(ex)) return h;
    }
    for (const h of headers) {
      if (keywordSets.some(kwSet => headerIncludesAll(h, kwSet))) return h;
    }
    return null;
  }

  function filterByCity(name) {
    const rows = getDataset();
    const col = rows.length ? findColumnFlexible(rows[0], CITY_EXACT, CITY_KEYWORDS) : null;
    if (!col) return [];
    return rows.filter(r => isOpenRow(r) && String(r[col] ?? '').trim() === name);
  }
  function filterByUnit(name) {
    const rows = getDataset();
    const col = rows.length ? findColumnFlexible(rows[0], UNIT_EXACT, UNIT_KEYWORDS) : null;
    if (!col) return [];
    return rows.filter(r => isOpenRow(r) && String(r[col] ?? '').trim() === name);
  }

  attachListClick('listByCity', 0, filterByCity, 'פניות פתוחות לפי עיר', 'city');
  attachListClick('listByUnit', 0, filterByUnit, 'פניות פתוחות לפי יחידה', 'unit');

  // אם הנתונים הוטענו אחרי שהסקריפט נטען – אין צורך בפעולה מיוחדת; המאזינים כבר יושבים.
})();
</script> 
  <!-- === STEP 4 (FINAL): SLA + KPI ירוק/אדום + טבלאות בקליק === -->
<section id="biModalHost"></section>
<script>
(() => {
  if (window.__BI_STEP4_FINAL) return;
  window.__BI_STEP4_FINAL = true;

  const TZ = 'Asia/Jerusalem';
  const CLOSED_WORDS = ['סגור','סגורה','נסגר','נסגרה','closed','סיום','נסגר בבקרת איכות'];

  const COLS = {
    openedAt: ['תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','date_opened','opened_at'],
    status:   ['סטאטוס פניה','סטאטוס','סטטוס פניה','Status','status'],
    dept:     ['מחלקה מטפלת','מחלקה','מחלקה מטפלת '],
    subject:  ['סיווג נושא','נושא','סיווג נושא '],
    problem:  ['סיווג בעיה','בעיה','סיווג בעיה '],
    city:     ['עיר','יישוב','יישוב/עיר','עיר/יישוב','ישוב','יישוב לקוח','עיר לקוח'],
    unit:     ['יחידת דואר: שם','שם יחידה','יחידה','שם יחידה מטפלת','שם-יחידה','יחידת דואר שם']
  };

  const $ = (id) => document.getElementById(id);

  // ---------- עזרי עמודות ----------
  function findCol(row, keys) {
    if (!row) return null;
    for (const k of keys) if (k in row) return k;
    const norm = s => String(s).replace(/\s+/g,'').toLowerCase();
    const targets = keys.map(norm);
    for (const k in row) if (targets.includes(norm(k))) return k;
    return null;
  }

  // ---------- תאריכים ----------
  function toPartsTZ(date) {
    const d = (date instanceof Date) ? date : new Date(date);
    const parts = new Intl.DateTimeFormat('he-IL', {
      timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit'
    }).formatToParts(d);
    const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return { y:+m.year, M:+m.month, d:+m.day, H:+(m.hour||'0'), i:+(m.minute||'0') };
  }
  function fmtDateTimeTZ(date) {
    const p = toPartsTZ(date);
    return `${String(p.d).padStart(2,'0')}/${String(p.M).padStart(2,'0')}/${p.y} ${String(p.H).padStart(2,'0')}:${String(p.i).padStart(2,'0')}`;
  }
  function ymdKeyParts(d){ return `${d.y}-${String(d.M).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`; }
  function todayKey(){ return ymdKeyParts(toPartsTZ(new Date())); }
  function yesterdayKey(){
    const t = toPartsTZ(new Date());
    const atMid = new Date(Date.UTC(t.y, t.M-1, t.d));
    return ymdKeyParts(toPartsTZ(new Date(atMid.getTime()-24*60*60*1000)));
  }
  function normalizeDateOnly(cellVal) {
    if (cellVal == null || cellVal === '') return null;
    if (typeof cellVal === 'number') {
      const excelEpoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(excelEpoch.getTime() + cellVal*24*60*60*1000);
      return ymdKeyParts(toPartsTZ(d));
    }
    const d = new Date(cellVal);
    if (!isNaN(d)) return ymdKeyParts(toPartsTZ(d));
    return null;
  }
  function parseOpenDate(row) {
    const key = findCol(row, COLS.openedAt);
    if (!key) return null;
    const v = row[key];
    if (v == null || v === '') return null;
    if (typeof v === 'number') {
      const excelEpoch = new Date(Date.UTC(1899,11,30));
      return new Date(excelEpoch.getTime() + v*24*60*60*1000);
    }
    const d = new Date(v);
    if (!isNaN(d)) return d;
    return null;
  }

  // ---------- SLA ----------
  function isOpenRow(row) {
    const key = findCol(row, COLS.status);
    if (!key) return true;
    const v = String(row[key] ?? '').trim();
    return !CLOSED_WORDS.some(c => v === c || v.includes(c));
  }
  function normTxt(s){ return String(s||'').replace(/\s+/g,'').toLowerCase(); }
  function getTxt(row, keys){ const k = findCol(row, keys); return k ? String(row[k]).trim() : ''; }

  function pickSLARule(row){
    const dept    = normTxt(getTxt(row, COLS.dept));
    const subject = normTxt(getTxt(row, COLS.subject));
    const problem = normTxt(getTxt(row, COLS.problem));

    if (dept.includes('פנים') && dept.includes('ארצי') &&
        (subject.includes('חלוקתדואר') || subject.includes('יחידותדואר')))
      return { ms: 8*24*60*60*1000, label: '8 ימים — חלוקת/יחידות דואר (פנים-ארצי)' };

    if (problem.includes('תקל') && problem.includes('פורטל') &&
        (dept.includes('שליח') || dept.includes('בינלאומי')))
      return { ms: 24*60*60*1000, label: '24 שעות — תקלה בפורטל (שליחים/בינלאומי)' };

    if ((problem.includes('איסוף') || problem.includes('הזמנה')) && dept.includes('שליח'))
      return { ms: 24*60*60*1000, label: '24 שעות — איסוף/הזמנה (שליחים)' };

    if ((dept.includes('פנים') && dept.includes('ארצי')) || dept.includes('שליח'))
      return { ms: 30*24*60*60*1000, label: '30 ימים — ברירת מחדל (פנים-ארצי/שליחים)' };

    if (dept.includes('בינלאומי'))
      return { ms: 60*24*60*60*1000, label: '60 ימים — ברירת מחדל (בינלאומי)' };

    return null;
  }

  function fmtDuration(ms){
    const abs = Math.abs(ms);
    const days = Math.floor(abs / (24*60*60*1000));
    const hours = Math.floor((abs % (24*60*60*1000)) / (60*60*1000));
    if (days >= 1) return `${days} ימים${hours?` ו-${hours} שעות`:``}`;
    return `${Math.round(abs/(60*60*1000))} שעות`;
  }

  function annotateRowWithSLA(row){
    const r = {...row};
    const rule = pickSLARule(r);
    const openedAt = parseOpenDate(r);

    r['SLA כלל']        = rule ? rule.label : '—';
    r['SLA משך']        = rule ? (rule.ms === 24*60*60*1000 ? '24 שעות'
                                    : `${rule.ms/(24*60*60*1000)} ימים`) : '—';
    r['SLA יעד']        = '—';
    r['SLA נותר/איחור'] = '—';
    r['SLA סטטוס']      = '—';

    if (!rule || !openedAt || !isOpenRow(r)) return r;

    const due   = new Date(openedAt.getTime() + rule.ms);
    const delta = due.getTime() - Date.now();
    r['SLA יעד']        = fmtDateTimeTZ(due);
    r['SLA נותר/איחור'] = (delta >= 0) ? `נותרו ${fmtDuration(delta)}` : `באיחור ${fmtDuration(delta)}`;
    r['SLA סטטוס']      = (delta >= 0) ? 'בזמן' : 'חריגה';
    return r;
  }

  function annotateRows(rows){ return rows.map(annotateRowWithSLA); }

  // ---------- Dataset ----------
  async function ensureDatasetLoaded() {
    if (Array.isArray(window.__dataset) && window.__dataset.length) return;
    if (!window.__lastFile || !window.XLSX) return;
    const buf = await window.__lastFile.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    window.__dataset = XLSX.utils.sheet_to_json(sheet, { defval: null });
  }
  function getDataset(){ return Array.isArray(window.__dataset) ? window.__dataset : []; }

  // ---------- Modal ----------
  function ensureModal() {
    if ($('biModal')) return;
    const html = `
      <div id="biModal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative mx-auto my-10 max-w-6xl w-[95%] rounded-3xl bg-[#0b1220] border border-white/10 shadow-luxe">
          <div class="flex items-center gap-3 px-6 py-4 border-b border-white/10">
            <div class="text-lg font-bold" id="biModalTitle">נתונים</div>
            <button id="biExportBtn" class="ms-auto px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">ייצוא ל-XLSX</button>
            <button id="biCloseBtn" class="ms-2 px-3 py-1.5 text-sm rounded-full bg-white/10 border border-white/20">סגירה</button>
          </div>
          <div class="p-4 overflow-auto" style="max-height:70vh">
            <table id="biTable" class="w-full text-sm border-separate border-spacing-0">
              <thead id="biThead"></thead><tbody id="biTbody"></tbody>
            </table>
            <div id="biEmpty" class="text-ink-200/70 text-sm p-4 hidden">אין נתונים להצגה.</div>
          </div>
        </div>
      </div>`;
    $('biModalHost').insertAdjacentHTML('beforeend', html);
    $('biCloseBtn').addEventListener('click', () => $('biModal').classList.add('hidden'));
    $('biModal').addEventListener('click', e => { if (e.target.id==='biModal') $('biModal').classList.add('hidden'); });
    $('biExportBtn').addEventListener('click', () => exportXLSX($('biModalTitle').dataset.filename||'export.xlsx'));
  }
  function renderTable(rows) {
    const tHead=$('biThead'), tBody=$('biTbody'), empty=$('biEmpty');
    window.__BI_CURRENT_ROWS = rows;
    if (!rows.length){ tHead.innerHTML='';tBody.innerHTML='';empty.classList.remove('hidden');return;}
    empty.classList.add('hidden');
    const headers=[...new Set(rows.flatMap(r=>Object.keys(r)))];
    tHead.innerHTML='<tr>'+headers.map(h=>`<th class="sticky top-0 bg-[#0b1220] px-3 py-2 text-right">${h}</th>`).join('')+'</tr>';
    tBody.innerHTML=rows.map(r=>'<tr>'+headers.map(h=>`<td class="px-3 py-2">${r[h]??''}</td>`).join('')+'</tr>').join('');
  }
  function exportXLSX(fn='export.xlsx'){
    if (!window.XLSX) return;
    const ws=XLSX.utils.json_to_sheet(window.__BI_CURRENT_ROWS||[]);
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Data');XLSX.writeFile(wb,fn);
  }
  function openModal(rows,title,file){
    ensureModal();
    renderTable(annotateRows(rows));
    $('biModalTitle').textContent=title;
    $('biModalTitle').dataset.filename=file+'.xlsx';
    $('biModal').classList.remove('hidden');
  }

  // ---------- KPI ----------
  function rowsOpenTotal(){ return getDataset().filter(isOpenRow); }
  function rowsOpenedDay(key){
    const rows=getDataset();
    const dateCol=rows.length?findCol(rows[0],COLS.openedAt):null;
    if (!dateCol) return[];
    return rows.filter(r=>isOpenRow(r)&&normalizeDateOnly(r[dateCol])===key);
  }
  function rowsSLAStatus(status){
    return annotateRows(getDataset().filter(isOpenRow)).filter(r=>r['SLA סטטוס']===status);
  }

  function bindKPIs(){
    [
      ['kpiOpenTotal','כל הפניות הפתוחות','open_total',rowsOpenTotal],
      ['kpiOpenedToday','פניות שנפתחו היום','opened_today',()=>rowsOpenedDay(todayKey())],
      ['kpiOpenedYesterday','פניות שנפתחו אתמול','opened_yesterday',()=>rowsOpenedDay(yesterdayKey())],
      ['kpiSLAOkVal','בזמן SLA','sla_ok',()=>rowsSLAStatus('בזמן')],
      ['kpiSLAOverVal','חריגה SLA','sla_over',()=>rowsSLAStatus('חריגה')]
    ].forEach(([id,title,file,fn])=>{
      const el=$(id);if(!el||el.dataset.bound) return;
      el.parentElement.classList.add('cursor-pointer');
      el.addEventListener('click',()=>openModal(fn(),title,file));
      el.dataset.bound=1;
    });
  }

  // אחרי טעינת קובץ נעדכן את המספרים
  if (typeof window.updateSuccessUI==='function'&&!window.__BI_STEP4_WRAP){
    const prev=window.updateSuccessUI;
    window.updateSuccessUI=async function(){
      prev.apply(this,arguments);
      await ensureDatasetLoaded();
      bindKPIs();
      $('kpiSLAOkVal').textContent=rowsSLAStatus('בזמן').length;
      $('kpiSLAOverVal').textContent=rowsSLAStatus('חריגה').length;
    };
    window.__BI_STEP4_WRAP=true;
  }
})();
      </script>
</body>
