<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>דשבורד BI • פניות פתוחות</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 p-4">
  <h1 class="text-xl font-bold mb-4">דשבורד BI • פניות פתוחות</h1>

  <!-- שדה העלאה גלוי -->
  <input id="fileInput" type="file"
    accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    class="block w-full border rounded-lg p-2 bg-white mb-3" />

  <!-- פס מידע -->
  <div id="fileInfo" class="hidden border rounded-lg p-2 bg-white mb-4 text-sm">
    <div>קובץ: <b id="fiName"></b></div>
    <div>גיליון: <b id="fiSheet"></b> • שורות: <b id="fiRows"></b></div>
    <div>סטטוס: <span id="fiNote"></span></div>
  </div>

  <!-- מקום לנתונים -->
  <div id="dashboard" class="hidden">
    <h2 class="text-lg font-semibold mb-2">תצוגת נתונים</h2>
    <pre id="dataPreview" class="text-xs bg-gray-100 p-2 rounded"></pre>
  </div>

<script>
const $=id=>document.getElementById(id);

$('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  $('fileInfo').classList.remove('hidden');
  $('fiName').textContent=f.name;
  $('fiNote').textContent='טוען...';

  try {
    const buf=await f.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const sheet=wb.SheetNames[0];
    $('fiSheet').textContent=sheet;
    const ws=wb.Sheets[sheet];
    const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
    $('fiRows').textContent=rows.length;
    $('fiNote').textContent='הקובץ עלה ✓';
    
    // הצגה בסיסית של כמה שורות ראשונות
    $('dashboard').classList.remove('hidden');
    $('dataPreview').textContent=JSON.stringify(rows.slice(0,5),null,2);
  } catch(err) {
    $('fiNote').textContent='שגיאה: '+err.message;
  }
});
</script>
</body>
</html>    </section>

    <!-- גרפים -->
    <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4 hidden">
      <div class="card"><h3 class="font-semibold mb-2">מגמת פתוחות</h3><canvas id="trendChart" height="140"></canvas></div>
      <div class="card"><h3 class="font-semibold mb-2">התפלגות SLA</h3><canvas id="slaPieChart" height="140"></canvas></div>
    </section>
  </div>

<script>
const $=id=>document.getElementById(id);
const fmt=d=>String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
const snap=d=>new Date(d.getFullYear(),d.getMonth(),d.getDate());
function parseExcelDate(v){
  if(v==null||v==='')return null;
  if(v instanceof Date)return v;
  if(typeof v==='number'){return new Date(Math.round((v-25569)*86400*1000));}
  const d=new Date(v); if(!isNaN(d)) return d;
  const m=String(v).trim().match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m) return new Date(+m[3],+m[2]-1,+m[1],+(m[4]||0),+(m[5]||0),+(m[6]||0));
  return null;
}
function guess(cols, arr){ const L=cols.map(c=>c.toLowerCase()); for(const cand of arr){ const i=L.findIndex(x=>x.includes(cand)); if(i>-1) return cols[i]; } return null; }
function groupCount(arr,keyFn){const m=new Map(); for(const r of arr){const k=keyFn(r); m.set(k,(m.get(k)||0)+1);} return m;}

const OPEN_STATUSES = new Set(['חדש','בתהליך','המתנה לגורם פנימי','המתנה למסמכים מהלקוח','פתוח','בטיפול']);
const SLA_RULES = (row, cols) => {
  const dept = (row[cols.dept]||'').toString().toLowerCase();
  const txt = JSON.stringify(row).toLowerCase();
  if (txt.includes('תקלה בפורטל')) return 24*60*60*1000;
  if (dept.includes('בינלאומי')) return 60*24*60*1000;
  if (dept.includes('פנים') && (txt.includes('חלוקת דואר') || txt.includes('יחידות דואר'))) return 8*24*60*1000;
  if (dept.includes('שליח') && txt.includes('איסוף והזמנה')) return 24*60*60*1000;
  if (dept.includes('פנים') || dept.includes('שליח')) return 30*24*60*1000;
  return null;
};

let RAW=[], COLS={}, CTX=null, charts={};

$('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0];
  $('fileInfo').classList.remove('hidden');
  if(!f){ $('fiNote').textContent='לא נבחר קובץ'; return; }
  $('fiName').textContent=f.name; $('fiNote').textContent='טוען…';
  try{
    const buf=await f.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const sheet=wb.SheetNames[0]; $('fiSheet').textContent=sheet||'—';
    const ws=wb.Sheets[sheet]; const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
    RAW=rows; $('fiRows').textContent=rows.length.toLocaleString('he-IL');
    if(!rows.length){ $('fiNote').textContent='אין שורות נתונים'; return; }

    const headers=Object.keys(rows[0]);
    COLS = {
      snapDate: guess(headers,['שונה לאחרונה','עדכון','תאריך/שעת שונה']),
      status:   guess(headers,['סטטוס','status']),
      dept:     guess(headers,['מחלקה','מטפלת','department']),
      openDate: guess(headers,['פתיחה','נפת','open'])
    };
    $('fiCols').innerHTML = [
      ['סנאפשוט',COLS.snapDate], ['סטטוס',COLS.status], ['מחלקה',COLS.dept], ['תאריך פתיחה',COLS.openDate||'(חסר — SLA חלקי)']
    ].map(([k,v])=>`<span class="${v?'text-green-600':'text-red-600'}">• ${k}: ${v||'—'}</span>`).join(' &nbsp; ');
    if(!COLS.snapDate||!COLS.status||!COLS.dept){ $('fiNote').textContent='חסרות עמודות חובה — תקני כותרות'; return; }

    alasql('DROP TABLE IF EXISTS data'); alasql('CREATE TABLE data'); alasql.tables.data.data = RAW;
    $('fiNote').textContent='הקובץ עלה ✓ — מחשב דשבורד';
    calc(); $('fiNote').textContent='מוכן ✓';
  }catch(err){ $('fiNote').textContent='שגיאה: '+err.message; }
});

$('btnRecalc').onclick=()=>{ if(!RAW.length){$('fiNote').textContent='לא נטען קובץ.';return;} $('fiNote').textContent='מריץ…'; try{calc(); $('fiNote').textContent='מוכן ✓';}catch(e){$('fiNote').textContent='שגיאה: '+e.message;} };
$('btnReset').onclick=()=>{ RAW=[]; COLS={}; CTX=null; ['fileInfo','kpis','charts'].forEach(id=>$(id).classList.add('hidden')); $('fiName').textContent='—'; $('fiSheet').textContent='—'; $('fiRows').textContent='—'; $('fiNote').textContent=''; $('fiCols').textContent=''; Object.values(charts).forEach(c=>c.destroy()); charts={};};
$('resSel').onchange=()=>calc();

function calc(){
  const base = RAW.map(r=>{ const dt=parseExcelDate(r[COLS.snapDate]); return dt? {...r,__d:dt,__snap:snap(dt)}:null }).filter(Boolean);
  const days=[...new Set(base.map(r=>r.__snap.getTime()))].sort((a,b)=>a-b).map(t=>new Date(t));
  if(!days.length){ $('fiNote').textContent='אין תאריך תקין בעמודת הסנאפשוט.'; return; }
  const current=days.at(-1), prev=days.at(-2);
  const isOpen=s=> s!=null && OPEN_STATUSES.has(String(s).trim());
  const today = base.filter(r=>r.__snap.getTime()===current.getTime() && isOpen(r[COLS.status]));
  const yest  = prev? base.filter(r=>r.__snap.getTime()===prev.getTime() && isOpen(r[COLS.status])) : [];

  // KPIs
  $('kpis').classList.remove('hidden');
  $('openCurrent').textContent=today.length;
  $('openPrev').textContent=yest.length||0;
  const d=today.length-(yest.length||0);
  $('deltaAbs').textContent=(d>0?'+':'')+d;
  $('deltaPct').textContent=yest.length?((d/yest.length*100).toFixed(1)+'%'):'—';

  // SLA
  let ok=0,bad=0,unk=0;
  today.forEach(r=>{
    const opened=COLS.openDate? parseExcelDate(r[COLS.openDate]):null;
    const ms=SLA_RULES(r,COLS);
    if(!opened||ms==null){ unk++; return; }
    (opened.getTime()+ms >= current.getTime() ? ok:bad)++;
  });
  $('slaOk').textContent=ok; $('slaBad').textContent=bad;
  $('slaRate').textContent=(ok+bad? (bad/(ok+bad)*100).toFixed(1)+'%':'—');

  // Charts
  const ctx1=$('trendChart').getContext('2d');
  const res=$('resSel').value;
  const keyBy=(d)=> res==='week' ? 'שבוע '+fmt(new Date(d.getFullYear(),d.getMonth(),d.getDate()-((d.getDay()+6)%7)))
    : res==='month'? (d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getFullYear()
    : res==='quarter'? 'Q'+(Math.floor(d.getMonth()/3)+1)+' '+d.getFullYear()
    : res==='year'? ''+d.getFullYear() : fmt(d);

  const byBucket={}; base.forEach(r=>{ if(isOpen(r[COLS.status])){ const k=keyBy(r.__snap); byBucket[k]=(byBucket[k]||0)+1; }});
  const labels=Object.keys(byBucket), data=labels.map(k=>byBucket[k]);

  if(charts.trend) charts.trend.destroy();
  charts.trend=new Chart(ctx1,{type:'line',data:{labels,datasets:[{label:'פתוחות',data,tension:.35,fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

  const ctx2=$('slaPieChart').getContext('2d');
  if(charts.pie) charts.pie.destroy();
  charts.pie=new Chart(ctx2,{type:'doughnut',data:{labels:['בתוך SLA','חרגו SLA','לא ניתן לחשב'],datasets:[{data:[ok,bad,unk]}]},options:{plugins:{legend:{position:'bottom'}}}});

  $('charts').classList.remove('hidden');
}
</script>
</body>
</html>
