<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>דשבורד BI • פתוחות (KPI+סטטוסים+כפילויות)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  @media (prefers-color-scheme:dark){body{background:#0b0c10;color:#e5e7eb}.card{background:#111827;border-color:#334155}}
  .num{font-variant-numeric:tabular-nums}
  table{border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;padding:.5rem .6rem;white-space:nowrap}
</style>
</head>
<body class="min-h-screen bg-slate-50 p-4">

<h1 class="text-2xl font-bold mb-2">דשבורד BI • פניות פתוחות</h1>
<p class="text-slate-500 text-sm mb-4">טעינת Excel ➜ KPI נכונים, פירוט סטטוסים, וכפילויות לכל סוג בנפרד.</p>

<!-- קלט קובץ -->
<div class="card mb-3">
  <label class="block text-sm mb-2">בחרי קובץ ‎.xlsx (כותרות בשורה הראשונה):</label>
  <input id="fileInput" type="file"
    accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
    class="block w-full border rounded-lg p-2 bg-white"/>
</div>

<!-- פס מידע -->
<div id="fileInfo" class="card mb-4 hidden text-sm">
  <div class="flex items-center justify-between">
    <div>
      <div><b id="fiName"></b></div>
      <div>גיליון: <b id="fiSheet">—</b> • שורות: <b id="fiRows" class="num">—</b></div>
      <div>סטטוס: <span id="fiNote">—</span></div>
    </div>
  </div>
  <div id="fiCols" class="text-xs text-slate-500 mt-2"></div>
</div>

<!-- KPI -->
<section id="kpis" class="grid grid-cols-1 md:grid-cols-4 gap-3 hidden">
  <div class="card">
    <div class="text-sm text-slate-500">סה״כ פתוחות (בכל הקובץ)</div>
    <div id="kpiAllOpen" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">מספר זה צריך להיות ≈ כמות השורות בקובץ, כי אין סגורות.</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">פתוחות — יום אחרון</div>
    <div id="kpiToday" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">נכון ל־<span id="lblCurr">—</span></div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">פתוחות — היום הקודם</div>
    <div id="kpiPrev" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">נכון ל־<span id="lblPrev">—</span></div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">שינוי יומי</div>
    <div id="kpiDelta" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">אחוזים: <span id="kpiPct">—</span></div>
  </div>
</section>

<!-- SLA קצר -->
<section id="slaBox" class="grid grid-cols-1 md:grid-cols-3 gap-3 hidden mt-3">
  <div class="card">
    <div class="text-sm text-slate-500">חריגות SLA (על בסיס תאריך/שעת פתיחה)</div>
    <div id="kpiSlaBad" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">בתוך SLA</div>
    <div id="kpiSlaOk" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">לא ניתן לחשב</div>
    <div id="kpiSlaU" class="text-3xl font-extrabold num">—</div>
  </div>
</section>

<!-- פירוט סטטוסים -->
<section id="statusWrap" class="card mt-4 hidden">
  <h3 class="font-semibold mb-2">פירוט לפי סטטוס</h3>
  <div class="overflow-auto">
    <table class="min-w-[520px] text-sm">
      <thead><tr><th>סטטוס</th><th>כמות</th><th>% מסה״כ פתוחות</th></tr></thead>
      <tbody id="statusBody"></tbody>
    </table>
  </div>
</section>

<!-- כפילויות -->
<section id="dupsWrap" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 hidden">
  <div class="card">
    <div class="text-sm text-slate-500">כפילויות לפי מספר מעקב</div>
    <div id="dupTrack" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">כפילויות לפי שם לקוח</div>
    <div id="dupName" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">כפילויות לפי אימייל</div>
    <div id="dupMail" class="text-3xl font-extrabold num">—</div>
  </div>
</section>

<script>
const $=id=>document.getElementById(id);

/* מיפוי כותרות בקובץ שלך */
const MAP = {
  snap:  'תאריך שינוי אחרון',      // להשוואה בין ימים
  open:  'תאריך/שעת פתיחה',        // לחישוב SLA
  status:'סטאטוס פנייה',
  dept:  'מחלקה מטפלת',
  city:  'עיר',
  track: 'מספר מעקב',
  name:  'שם לקוח: שם לקוח',
  mail:  'דואר אלקטרוני',
  prod:  'סיווג מוצר',
  topic: 'סיווג נושא',
  issue: 'סיווג בעיה'
};

/* סטטוסים שמוגדרים פתוח */
const OPEN = new Set(['חדש','בתהליך','המתנה לגורם פנימי','המתנה למסמכים מהלקוח','פתוח','בטיפול','פתוח/בתהליך']);

/* כללי SLA שסיכמנו */
const SLA_RULES = (row) => {
  const dept = (row[MAP.dept]||'').toString().toLowerCase();
  const txt  = JSON.stringify(row).toLowerCase();
  if (txt.includes('תקלה בפורטל')) return 24*60*60*1000;                                 // 24 שעות
  if (dept.includes('בינלאומי'))   return 60*24*60*1000;                                 // 60 יום
  if (dept.includes('פנים') && (txt.includes('חלוקת דואר')||txt.includes('יחידות דואר'))) return 8*24*60*1000; // 8 ימים
  if (dept.includes('שליח') && txt.includes('איסוף והזמנה')) return 24*60*60*1000;       // 24 שעות
  if (dept.includes('פנים') || dept.includes('שליח')) return 30*24*60*1000;              // 30 יום
  return null;
};

/* עזרי תאריך */
const dayOnly = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
const fmt = d => String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
function parseExcelDate(v){
  if(v==null||v==='') return null;
  if(v instanceof Date) return v;
  if(typeof v==='number') return new Date(Math.round((v-25569)*86400*1000)); // serial
  const d=new Date(v); if(!isNaN(d)) return d;
  const m=String(v).trim().match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m) return new Date(+m[3],+m[2]-1,+m[1],+(m[4]||0),+(m[5]||0),+(m[6]||0));
  return null;
}

/* עזר לכפילויות */
function countDups(rows, col){
  if(!col) return 0;
  const m=new Map();
  rows.forEach(r=>{
    const v=(r[col]||'').toString().trim();
    if(!v) return;
    m.set(v,(m.get(v)||0)+1);
  });
  let cnt=0; m.forEach(n=>{ if(n>1) cnt++; });
  return cnt;
}

$('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  $('fileInfo').classList.remove('hidden');
  $('fiName').textContent = f.name;
  $('fiNote').textContent = 'טוען...';

  try{
    const buf=await f.arrayBuffer();
    const wb =XLSX.read(buf,{type:'array'});
    const sheet = wb.SheetNames[0] || '';
    $('fiSheet').textContent = sheet || '—';
    const ws = wb.Sheets[sheet];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:''});
    $('fiRows').textContent = rows.length.toLocaleString('he-IL');
    const headers = rows.length? Object.keys(rows[0]) : [];
    $('fiCols').innerHTML = headers.map(h=>'• '+h).join(' &nbsp; ');

    // נוודא שיש את העמודות החשובות
    const must=[MAP.snap, MAP.status];
    const missing = must.filter(m=>!headers.includes(m));
    if(missing.length){ $('fiNote').textContent = 'חסרות עמודות: '+missing.join(', '); return; }

    // המרה לתאריך-יום מתוך "תאריך שינוי אחרון"
    const base = rows.map(r=>{
      const d=parseExcelDate(r[MAP.snap]);
      if(!d) return null;
      return {...r, __snap: dayOnly(d)};
    }).filter(Boolean);

    // סה״כ פתוחות – כל הקובץ
    const isOpen = s => s!=null && OPEN.has(String(s).trim());
    const ALL_OPEN = base.filter(r=> isOpen(r[MAP.status]) );
    $('kpiAllOpen').textContent = ALL_OPEN.length.toLocaleString('he-IL');

    // “יום אחרון” ו“יום קודם”
    const days = [...new Set(base.map(r=>r.__snap.getTime()))].sort((a,b)=>a-b).map(t=>new Date(t));
    const CURR = days.at(-1);
    const PREV = days.length>1 ? days.at(-2) : null;
    $('lblCurr').textContent = CURR ? fmt(CURR) : '—';
    $('lblPrev').textContent = PREV ? fmt(PREV) : '—';

    const TODAY = CURR ? base.filter(r=> r.__snap.getTime()===CURR.getTime() && isOpen(r[MAP.status])) : [];
    const YEST  = PREV ? base.filter(r=> r.__snap.getTime()===PREV.getTime() && isOpen(r[MAP.status])) : [];

    $('kpiToday').textContent = TODAY.length;
    $('kpiPrev').textContent  = YEST.length || 0;
    const delta = TODAY.length - (YEST.length || 0);
    $('kpiDelta').textContent = (delta>0?'+':'')+delta;
    $('kpiPct').textContent   = YEST.length ? ((delta/YEST.length*100).toFixed(1)+'%') : '—';

    $('kpis').classList.remove('hidden');

    // SLA – היום (אם קיימת עמודת פתיחה)
    if(headers.includes(MAP.open)){
      let ok=0,bad=0,unk=0;
      TODAY.forEach(r=>{
        const opened=parseExcelDate(r[MAP.open]);
        const ms=SLA_RULES(r);
        if(!opened || ms==null) { unk++; return; }
        (opened.getTime()+ms >= CURR.getTime() ? ok++ : bad++);
      });
      $('kpiSlaOk').textContent = ok;
      $('kpiSlaBad').textContent = bad;
      $('kpiSlaU').textContent   = unk;
      $('slaBox').classList.remove('hidden');
    }

    // פירוט סטטוסים – על בסיס כל הקובץ (מה שביקשת)
    const byStatus=new Map();
    ALL_OPEN.forEach(r=>{
      const s=(r[MAP.status]||'').toString().trim()||'—';
      byStatus.set(s,(byStatus.get(s)||0)+1);
    });
    const total=ALL_OPEN.length||1;
    const rowsHtml=[...byStatus.entries()]
      .sort((a,b)=>b[1]-a[1])
      .map(([s,n])=>`<tr><td>${s}</td><td class="num">${n.toLocaleString('he-IL')}</td><td class="num">${(n/total*100).toFixed(1)}%</td></tr>`)
      .join('');
    $('statusBody').innerHTML = rowsHtml;
    $('statusWrap').classList.remove('hidden');

    // כפילויות – בנפרד לכל שדה
    $('dupTrack').textContent = countDups(ALL_OPEN, MAP.track);
    $('dupName').textContent  = countDups(ALL_OPEN, MAP.name);
    $('dupMail').textContent  = countDups(ALL_OPEN, MAP.mail);
    $('dupsWrap').classList.remove('hidden');

    $('fiNote').textContent = 'הקובץ עלה ✓ | חושב לפי כללים מעודכנים';

  }catch(err){
    $('fiNote').textContent = 'שגיאה: '+err.message;
  }
});
</script>
</body>
</html>
