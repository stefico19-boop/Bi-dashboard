<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BI • פניות פתוחות</title>
<link href="https://unpkg.com/@fontsource/assistant@5.0.16/400.css" rel="stylesheet">
<link href="https://unpkg.com/@fontsource/assistant@5.0.16/600.css" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fc; --card:#fff; --ink:#0f1226; --sub:#6b6f80; --pri:#5b5ce2; --ok:#22c55e; --err:#ef4444;
    --radius:18px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:"Assistant",system-ui,Segoe UI,Arial;color:var(--ink)}
  .wrap{max-width:980px;margin:auto;padding:28px 18px 96px}
  h1{margin:6px 0 8px;font-size:34px;letter-spacing:.3px}
  .sub{color:var(--sub);font-size:15px;margin-bottom:18px}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--pri);color:#fff;border:none;border-radius:14px;padding:14px 18px;font-size:16px;cursor:pointer}
  .btn.ghost{background:#eef0ff;color:#3b3dd6}
  .pill{background:#eef0ff;border-radius:999px;padding:10px 14px;color:#3b3dd6}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 28px rgba(15,18,38,.06);padding:16px 18px;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .kpi{padding:18px 18px 20px}
  .kpi h3{margin:0 0 8px;font-size:15px;color:var(--sub);font-weight:600}
  .kpi .v{font-size:44px;font-weight:700;letter-spacing:1px}
  .muted{color:var(--sub);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .fade{opacity:.88}
</style>
</head>
<body>
<div class="wrap">
  <h1>דשבורד • BI • פניות פתוחות</h1>
  <div class="sub">כל החישובים מתבססים על השדה <b>“תאריך/שעת פתיחה”</b> בלבד. אין שימוש ב“שונה לאחרונה”.</div>

  <!-- העלאת קובץ -->
  <div class="card">
    <div class="row">
      <label class="btn" for="file">העלאת Excel</label>
      <input id="file" type="file" accept=".xlsx,.xls" style="display:none">
      <button id="clear" class="btn ghost">ניקוי</button>
      <div id="fileInfo" class="pill">לא נבחר קובץ</div>
    </div>
    <div id="ingestMsg" class="status" style="margin-top:12px"></div>
  </div>

  <!-- KPI -->
  <div class="grid" id="kpis" style="display:none">
    <div class="card kpi">
      <h3>סה״כ שורות (בקובץ)</h3>
      <div class="v" id="totalRows">–</div>
    </div>
    <div class="card kpi">
      <h3>פניות – יום אחרון <span class="muted">(לפי תאריך פתיחה)</span></h3>
      <div class="v" id="lastCount">–</div>
      <div class="muted" id="lastDateLbl">–</div>
    </div>
    <div class="card kpi">
      <h3>פניות – היום הקודם <span class="muted">(לפי תאריך פתיחה)</span></h3>
      <div class="v" id="prevCount">–</div>
      <div class="muted" id="prevDateLbl">–</div>
    </div>
    <div class="card kpi">
      <h3>שינוי יומי</h3>
      <div class="v" id="deltaCount">–</div>
      <div class="muted" id="deltaPct">–</div>
    </div>
  </div>

  <!-- דיאגנוסטיקה -->
  <div id="diag" class="card" style="display:none">
    <div class="muted">דיאגנוסטיקה שדות תאריך:</div>
    <div id="diagBody" class="mono fade" style="margin-top:6px"></div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const tz = 'Asia/Jerusalem';
const fmt = new Intl.DateTimeFormat('he-IL',{timeZone:tz, day:'2-digit', month:'2-digit', year:'numeric'});

// --------- עזרי תאריכים ----------
function dateOnly(d){                 // יוצר תאריך "נקי" ללא שעה (ב־UTC כדי למנוע קפיצות TZ)
  return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
}
function keyFromDate(d){              // מפתח YYYY-MM-DD
  return d.toISOString().slice(0,10);
}
function labelFromKey(k){             // תצוגה יפה ל־he-IL
  const [y,m,d] = k.split('-').map(Number);
  return fmt.format(new Date(Date.UTC(y, m-1, d)));
}

// Excel serial בטוח (מעדיף SSF, נופל לפורמולה אם צריך)
function dateFromExcelSerial(n){
  try{
    const o = XLSX.SSF.parse_date_code(n);
    if(o && o.y && o.m && o.d) return dateOnly(new Date(o.y, o.m-1, o.d));
  }catch(_){}
  // נפילה לשיטה הארוכה
  const ms = (n - 25569) * 86400 * 1000;   // 25569 = 1899-12-30
  return dateOnly(new Date(ms));
}

// פרסור כללי לשדה “תאריך/שעת פתיחה”
function parseOpenDate(v){
  if(v == null || v === '') return null;

  // 1) מספר => Excel serial
  if(typeof v === 'number') return dateFromExcelSerial(v);

  // 2) טקסט: "dd/mm/yyyy hh:mm" או "dd/mm/yyyy"
  if(typeof v === 'string'){
    const s = v.trim().replace(/[.,]/g,'/');      // מקרים של "19.09.2025 10:47"
    // dd/mm/yyyy(...*) → הולך רק על התאריך ומתעלם משעה
    const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
    if(m){
      const d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3].length===2 ? ('20'+m[3]) : m[3],10);
      return dateOnly(new Date(y, mo-1, d));
    }
    // yyyy-mm-dd...
    const m2 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
    if(m2){
      const y = +m2[1], mo = +m2[2], d = +m2[3];
      return dateOnly(new Date(y, mo-1, d));
    }
    // ניסיון אחרון: Date רגיל
    const t = new Date(s);
    if(!Number.isNaN(t.getTime())) return dateOnly(t);
  }

  return null;
}

// --------- מצב UI ----------
const el = {
  file: document.getElementById('file'),
  clear: document.getElementById('clear'),
  fileInfo: document.getElementById('fileInfo'),
  ingestMsg: document.getElementById('ingestMsg'),
  kpis: document.getElementById('kpis'),
  totalRows: document.getElementById('totalRows'),
  lastCount: document.getElementById('lastCount'),
  prevCount: document.getElementById('prevCount'),
  deltaCount: document.getElementById('deltaCount'),
  lastDateLbl: document.getElementById('lastDateLbl'),
  prevDateLbl: document.getElementById('prevDateLbl'),
  deltaPct: document.getElementById('deltaPct'),
  diag: document.getElementById('diag'),
  diagBody: document.getElementById('diagBody'),
};

let rows = [];             // כל השורות כ־Objects
let dateKey = null;        // שם העמודה שנבחרה
const wantedDateNames = [
  'תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','תאריך פתיחה פניה',
  'Open Date','Opened','Create Date','Created'
];

// איתור עמודת תאריך פתיחה
function pickDateColumn(headers){
  // איתור לפי שמות נפוצים בעברית/אנגלית
  for(const name of wantedDateNames){
    const idx = headers.findIndex(h => (h||'').toString().trim() === name);
    if(idx !== -1) return headers[idx];
  }
  // חיפוש לפי מפתח שמכיל "פתיחה" או "open"
  const h2 = headers.find(h => /פתיחה|open/i.test((h||'')+''));
  return h2 || headers[0]; // נפילה: הראשון
}

// קריאת קובץ
el.file.addEventListener('change', async (e)=>{
  resetUI(true);
  const file = e.target.files?.[0];
  if(!file){el.fileInfo.textContent='לא נבחר קובץ';return;}
  el.fileInfo.textContent = file.name;

  try{
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf, {type:'array', cellDates:false, cellNF:true, cellText:false});
    const ws  = wb.Sheets[wb.SheetNames[0]];
    const arr = XLSX.utils.sheet_to_json(ws, {defval:null, raw:true});

    if(!arr.length) return fail('הקובץ ריק');

    // כותרות
    const headers = Object.keys(arr[0]||{});
    dateKey = pickDateColumn(headers);

    // בניית מערך שורות + סטטיסטיקה
    let serial=0, textOk=0, blanks=0;
    rows = arr.map(r=>{
      const v = r[dateKey];
      const d = parseOpenDate(v);
      if(v==null || v==='') blanks++;
      else if(typeof v === 'number') serial++;
      else textOk++;
      return {...r, __openDate__: d, __openKey__: d ? keyFromDate(d) : null};
    });

    // הצגת דיאגנוסטיקה
    el.diag.style.display = 'block';
    el.diagBody.textContent =
      `עמודת תאריך שנבחרה: ${dateKey}\n`+
      `זוהו תאריכים כטקסט: ${textOk.toLocaleString('he-IL')}\n`+
      `זוהו serial של Excel: ${serial.toLocaleString('he-IL')}\n`+
      `לא קריאים/ריקים: ${blanks.toLocaleString('he-IL')}`;

    // KPI לפי התאריכים שנמצאים בקובץ (לא היום!)
    buildKPIs();

    ok(`הקובץ נטען בהצלחה • שורות ${rows.length.toLocaleString('he-IL')}`);
  }catch(err){
    console.error(err);
    fail('שגיאה בקריאת הקובץ. ודאי שזה ‎.xlsx‎ רגיל, בגליון הראשון יש כותרות, ואין נוסחאות תאריך לא סטנדרטיות.');
  }
});

el.clear.addEventListener('click', ()=>{
  el.file.value = '';
  resetUI();
});

function resetUI(keepFile=false){
  if(!keepFile){ el.fileInfo.textContent = 'לא נבחר קובץ'; }
  el.ingestMsg.innerHTML = '';
  el.kpis.style.display = 'none';
  el.diag.style.display = 'none';
  rows = [];
  dateKey = null;
}

function ok(msg){
  el.ingestMsg.innerHTML = `<span class="ok">✓</span> <span>${msg}</span>`;
}
function fail(msg){
  el.ingestMsg.innerHTML = `<span class="err">⚠</span> <span>${msg}</span>`;
}

// בניית KPI על בסיס היום האחרון/הקודם שקיימים בנתונים (לא לפי היום במכשיר)
function buildKPIs(){
  const valid = rows.filter(r => !!r.__openKey__);
  el.totalRows.textContent = rows.length.toLocaleString('he-IL');

  if(!valid.length){
    el.kpis.style.display='grid';
    el.lastCount.textContent = el.prevCount.textContent = el.deltaCount.textContent = '0';
    el.lastDateLbl.textContent = el.prevDateLbl.textContent = 'אין תאריכים קריאים';
    el.deltaPct.textContent = '—';
    return;
  }

  // צבירה לפי תאריך
  const byDate = new Map();
  for(const r of valid){
    byDate.set(r.__openKey__, (byDate.get(r.__openKey__)||0)+1);
  }
  const keys = [...byDate.keys()].sort(); // עולה
  const lastKey = keys[keys.length-1];            // המאוחר ביותר בקובץ
  // היום הקודם שקיים בקובץ (לא בהכרח last-1, אלא התאריך הקודם שקיים)
  const prevKey = keys.length>=2 ? keys[keys.length-2] : null;

  const lastCnt = byDate.get(lastKey) || 0;
  const prevCnt = prevKey ? (byDate.get(prevKey)||0) : 0;
  const delta   = lastCnt - prevCnt;
  const pct     = prevCnt ? (delta/prevCnt*100) : 0;

  el.lastCount.textContent = lastCnt.toLocaleString('he-IL');
  el.prevCount.textContent = prevCnt.toLocaleString('he-IL');
  el.deltaCount.textContent = (delta>0?'+':'') + delta.toLocaleString('he-IL');
  el.deltaPct.textContent = prevKey ? (pct.toFixed(1)+'%') : '—';

  el.lastDateLbl.textContent = 'נכון ל־ ' + labelFromKey(lastKey);
  el.prevDateLbl.textContent = prevKey ? ('נכון ל־ ' + labelFromKey(prevKey)) : 'אין תאריך קודם בקובץ';
  el.kpis.style.display='grid';
}
</script>
</body>
</html>
