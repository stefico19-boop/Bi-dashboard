<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>דשבורד BI • שלב 2 (KPI בלבד)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  @media (prefers-color-scheme:dark){body{background:#0b0c10;color:#e5e7eb}.card{background:#111827;border-color:#334155}}
  .num{font-variant-numeric:tabular-nums}
</style>
</head>
<body class="min-h-screen bg-slate-50 p-4">

<h1 class="text-2xl font-bold mb-2">דשבורד BI • פניות פתוחות (שלב 2)</h1>
<p class="text-slate-500 text-sm mb-4">טעינת Excel ➜ פס מידע ➜ KPI בסיסיים. (גרפים/טאבים נוסיף בשלב הבא)</p>

<!-- קלט קובץ -->
<div class="card mb-3">
  <label class="block text-sm mb-2">בחרי קובץ ‎.xlsx (כותרות בשורה הראשונה):</label>
  <input id="fileInput" type="file"
    accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
    class="block w-full border rounded-lg p-2 bg-white"/>
</div>

<!-- פס מידע -->
<div id="fileInfo" class="card mb-4 hidden text-sm">
  <div><b id="fiName"></b></div>
  <div>גיליון: <b id="fiSheet">—</b> • שורות: <b id="fiRows" class="num">—</b></div>
  <div>סטטוס: <span id="fiNote">—</span></div>
  <div id="fiCols" class="text-xs text-slate-500 mt-1"></div>
</div>

<!-- KPI -->
<section id="kpis" class="grid grid-cols-1 md:grid-cols-5 gap-3 hidden">
  <div class="card">
    <div class="text-sm text-slate-500">פתוחות היום</div>
    <div id="kpiToday" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">פתוחות אתמול</div>
    <div id="kpiPrev" class="text-3xl font-extrabold num">—</div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">שינוי יומי</div>
    <div id="kpiDelta" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">אחוזים: <span id="kpiPct">—</span></div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">SLA — חריגות</div>
    <div id="kpiSlaBad" class="text-3xl font-extrabold num">—</div>
    <div class="text-xs text-slate-500">בתוך SLA: <span id="kpiSlaOk">—</span> • לא ניתן: <span id="kpiSlaU">—</span></div>
  </div>
  <div class="card">
    <div class="text-sm text-slate-500">כפילויות (Tracking/שם/מייל)</div>
    <div id="kpiDup" class="text-3xl font-extrabולד num">—</div>
  </div>
</section>

<script>
const $=id=>document.getElementById(id);

/* === עמודות לפי הקובץ שלך === */
const MAP = {
  snap:  'תאריך שינוי אחרון',      // להשוואה יומית
  open:  'תאריך/שעת פתיחה',        // לחישוב SLA
  status:'סטאטוס פנייה',
  dept:  'מחלקה מטפלת',
  city:  'עיר',
  source:'מקור הפנייה',
  track: 'מספר מעקב',
  name:  'שם לקוח: שם לקוח',
  mail:  'דואר אלקטרוני',
  prod:  'סיווג מוצר',
  topic: 'סיווג נושא',
  issue: 'סיווג בעיה'
};

/* סטטוסים שנחשבים "פתוח" */
const OPEN = new Set(['חדש','בתהליך','המתנה לגורם פנימי','המתנה למסמכים מהלקוח','פתוח','בטיפול','פתוח/בתהליך']);

/* כללי SLA שסיכמנו */
const SLA_RULES = (row) => {
  const dept = (row[MAP.dept]||'').toString().toLowerCase();
  const txt  = JSON.stringify(row).toLowerCase();
  if (txt.includes('תקלה בפורטל')) return 24*60*60*1000;                     // 24 שעות
  if (dept.includes('בינלאומי'))   return 60*24*60*1000;                     // 60 יום
  if (dept.includes('פנים') && (txt.includes('חלוקת דואר')||txt.includes('יחידות דואר'))) return 8*24*60*1000; // 8 ימים
  if (dept.includes('שליח') && txt.includes('איסוף והזמנה')) return 24*60*60*1000; // 24 שעות
  if (dept.includes('פנים') || dept.includes('שליח')) return 30*24*60*1000; // 30 יום
  return null; // לא ניתן לחשב
};

/* עזרי תאריך */
const dayOnly = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
const fmt = d => String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
function parseExcelDate(v){
  if(v==null||v==='') return null;
  if(v instanceof Date) return v;
  if(typeof v==='number') return new Date(Math.round((v-25569)*86400*1000)); // serial
  const d=new Date(v); if(!isNaN(d)) return d;
  // פורמט dd/mm/yyyy hh:mm (או בלי שעה)
  const m=String(v).trim().match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m) return new Date(+m[3],+m[2]-1,+m[1],+(m[4]||0),+(m[5]||0),+(m[6]||0));
  return null;
}

/* טעינת קובץ */
$('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;

  // פס מידע
  $('fileInfo').classList.remove('hidden');
  $('fiName').textContent = f.name;
  $('fiNote').textContent = 'טוען...';

  try{
    const buf = await f.arrayBuffer();
    const wb  = XLSX.read(buf,{type:'array'});
    const sheet = wb.SheetNames[0] || '';
    $('fiSheet').textContent = sheet || '—';

    const ws   = wb.Sheets[sheet];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:''});
    $('fiRows').textContent = rows.length.toLocaleString('he-IL');

    // מציג רשימת עמודות שנקראו
    const headers = rows.length? Object.keys(rows[0]) : [];
    $('fiCols').innerHTML = headers.map(h=>'• '+h).join(' &nbsp; ');

    // בדיקת שדות חובה
    const must=[MAP.snap, MAP.status];
    const missing = must.filter(m=>!headers.includes(m));
    if(missing.length){
      $('fiNote').textContent = 'חסרות עמודות חובה: '+missing.join(', ');
      return;
    }

    // המרה לתאריך-יום רק מעמודת "תאריך שינוי אחרון"
    const base = rows.map(r=>{
      const d = parseExcelDate(r[MAP.snap]);
      if(!d) return null;
      return {...r, __snap: dayOnly(d), __date: fmt(dayOnly(d))};
    }).filter(Boolean);

    if(!base.length){
      $('fiNote').textContent = 'אין תאריכים תקינים בעמודת "'+MAP.snap+'".';
      return;
    }

    // מזהים "היום" = התאריך האחרון בקובץ | "אתמול" = שלפניו
    const days = [...new Set(base.map(r=>r.__snap.getTime()))].sort((a,b)=>a-b).map(t=>new Date(t));
    const CURR = days.at(-1);
    const PREV = days.length>1? days.at(-2) : null;

    const isOpen = s => s!=null && OPEN.has(String(s).trim());
    const todayRows = base.filter(r => r.__snap.getTime()===CURR.getTime() && isOpen(r[MAP.status]));
    const prevRows  = PREV ? base.filter(r => r.__snap.getTime()===PREV.getTime() && isOpen(r[MAP.status])) : [];

    // KPI בסיסי
    $('kpis').classList.remove('hidden');
    $('kpiToday').textContent = todayRows.length;
    $('kpiPrev').textContent  = prevRows.length || 0;
    const delta = todayRows.length - (prevRows.length || 0);
    $('kpiDelta').textContent = (delta>0?'+':'')+delta;
    $('kpiPct').textContent   = prevRows.length ? ((delta/prevRows.length*100).toFixed(1)+'%') : '—';

    // SLA (על בסיס "תאריך/שעת פתיחה" אם קיים)
    let ok=0,bad=0,unk=0;
    todayRows.forEach(r=>{
      const opened = MAP.open ? parseExcelDate(r[MAP.open]) : null;
      const ms = SLA_RULES(r);
      if(!opened || ms==null){ unk++; return; }
      (opened.getTime()+ms >= CURR.getTime() ? ok++ : bad++);
    });
    $('kpiSlaOk').textContent = ok;
    $('kpiSlaBad').textContent = bad;
    $('kpiSlaU').textContent   = unk;

    // כפילויות (מס' מעקב | שם | מייל)
    function dupCount(col){
      if(!col) return 0;
      const seen=new Map();
      base.forEach(r=>{
        const v=(r[col]||'').toString().trim();
        if(!v) return;
        seen.set(v,(seen.get(v)||0)+1);
      });
      let cnt=0; seen.forEach(n=>{ if(n>1) cnt++; });
      return cnt;
    }
    const dup = dupCount(MAP.track)+dupCount(MAP.name)+dupCount(MAP.mail);
    $('kpiDup').textContent = dup;

    $('fiNote').textContent = `הקובץ עלה ✓ | יום נבחר להשוואה: ${fmt(CURR)}${PREV?' (לעומת '+fmt(PREV)+')':''}`;

  }catch(err){
    $('fiNote').textContent = 'שגיאה: '+err.message;
  }
});
</script>
</body>
</html>
