<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>BI • פניות פתוחות – העלאת Excel</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#f7f7fb;--card:#ffffff;--text:#0b0b14;--muted:#6b6b76;
    --brand:#5b5bd6;--brand-2:#7a5bd6;--ok:#1a9c5b;--err:#e03131;
    --ring:rgba(91,91,214,.25);--shadow:0 10px 30px rgba(14,16,42,.08)
  }
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Rubik,Heebo,Arial,sans-serif}
  .wrap{max-width:920px;margin:24px auto;padding: clamp(12px,2vw,20px)}
  .title{font-size: clamp(24px,3.6vw,40px);font-weight:800;letter-spacing:.3px;margin:12px 0}
  .subtitle{color:var(--muted);margin-bottom:18px;line-height:1.5}
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:var(--shadow);border:1px solid #ececf4}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:none;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff}
  .btn-ghost{background:#f1f2ff;color:#2e2ea3}
  .btn-danger{background:#fff0f0;color:var(--err)}
  input[type="file"]{display:none}
  .file-pill{flex:1;min-width:220px;background:#f4f5fb;border:1px dashed #d9daf1;color:#2d2d39;
    padding:12px 14px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
  .meta{margin-top:12px;display:grid;gap:10px}
  .tag{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:#f4f5fb;color:#32324d;border:1px solid #e7e8f7}
  .ok{background:#e9fbf3;color:#0f7a45;border-color:#d7f4e6}
  .bad{background:#fff1f1;color:#8e1e1e;border-color:#ffd8d8}
  .hint{color:var(--muted);font-size:14px}
  select, .text{width:100%;padding:12px 14px;border:1px solid #e1e3f4;border-radius:12px;background:#fff}
  select:focus, .text:focus{outline:0;box-shadow:0 0 0 4px var(--ring);border-color:#cbd0ff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .hidden{display:none}
  .hr{height:1px;background:#ececf4;margin:14px 0}
</style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">דשבורד • BI • פניות פתוחות</h1>
    <p class="subtitle">
      כל החישובים יתבססו על <b>“תאריך/שעת פתיחה”</b> בלבד. אם הזיהוי האוטומטי לא תופס, אפשר לבחור ידנית את עמודת התאריך לאחר קריאת הקובץ.
    </p>

    <!-- כרטיס העלאה -->
    <div class="card" id="uploader">
      <div class="row">
        <label for="file" class="btn btn-primary">העלאת Excel</label>
        <button id="btnClear" class="btn btn-danger" type="button">ניקוי</button>
        <div class="file-pill"><span id="fileName">לא נבחר קובץ</span><span id="rowCount">—</span></div>
        <input id="file" type="file" accept=".xlsx,.xls,.csv" />
      </div>

      <div class="meta">
        <div id="statusLine" class="tag">מוכן להעלאה</div>
        <div id="errorLine" class="tag bad hidden">שגיאה תוצג כאן</div>
      </div>

      <div class="hr"></div>

      <!-- בחירה ידנית של עמודת תאריך במקרה הצורך -->
      <div class="grid">
        <div>
          <label class="hint">עמודת תאריכים (אם האוטומטי לא זיהה)</label>
          <select id="dateSelect" disabled></select>
        </div>
      </div>

      <p class="hint" style="margin-top:10px">
        טיפ: אם יש כמה גיליונות (Sheets) – הקובץ ייטען מה-Sheet הראשון. אפשר לשנות בגיליון לפני שמירה.
      </p>
    </div>

    <!-- מקום לדוחות בהמשך (כשנחזור להשלים את ה-BI המלא) -->
    <div id="dash" class="card hidden" style="margin-top:14px">
      <div class="grid">
        <div class="tag ok" id="okLine">הקובץ נטען בהצלחה</div>
        <div class="tag" id="detectedCol">עמודת תאריך שזוהתה: —</div>
      </div>
    </div>
  </div>

  <!-- SheetJS (קריאה/כתיבה של Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  (function(){
    const fileInput   = document.getElementById('file');
    const fileNameEl  = document.getElementById('fileName');
    const rowCountEl  = document.getElementById('rowCount');
    const statusLine  = document.getElementById('statusLine');
    const errorLine   = document.getElementById('errorLine');
    const dateSelect  = document.getElementById('dateSelect');
    const dash        = document.getElementById('dash');
    const detectedCol = document.getElementById('detectedCol');
    const btnClear    = document.getElementById('btnClear');

    // שמות אפשריים לעמודת התאריך (ניקוי רווחים/גרשיים/כפולים)
    const DATE_CANDIDATES = new Set([
      'תאריך/שעת פתיחה','תאריך / שעת פתיחה','תאריך פתיחה','זמן פתיחה',
      'תאריך-שעת פתיחה','תאריך ושעת פתיחה','תאריך/שעת פתיחה '.trim(),
      'תאריך\\שעת פתיחה'
    ].map(normalizeHeader));

    let currentRows = [];   // מערך אובייקטים שנקרא מהקובץ
    let headers = [];       // רשימת כותרות כפי שזוהו
    let chosenDateKey = null;

    function normalizeHeader(h){
      if (h==null) return '';
      return String(h)
        .replace(/[’'"]/g,'')      // גרשיים
        .replace(/\s+/g,' ')        // רווחים מרובים
        .replace(/\s*\/\s*/g,'/')   // רווחים סביב /
        .replace(/\s*\\\s*/g,'\\')  // רווחים סביב \
        .trim();
    }

    function showOK(msg){
      statusLine.textContent = msg || 'מוכן';
      statusLine.classList.remove('bad'); statusLine.classList.add('ok');
      errorLine.classList.add('hidden');
    }
    function showErr(msg){
      errorLine.textContent = msg || 'שגיאה לא ידועה';
      errorLine.classList.remove('hidden');
      statusLine.classList.remove('ok');
      statusLine.classList.add('bad');
    }
    function resetUI(){
      fileNameEl.textContent = 'לא נבחר קובץ';
      rowCountEl.textContent = '—';
      dateSelect.innerHTML = '';
      dateSelect.disabled = true;
      dash.classList.add('hidden');
      chosenDateKey = null; currentRows = []; headers = [];
      showOK('מוכן להעלאה');
    }

    btnClear.addEventListener('click', resetUI);

    // קריאה מהקובץ
    fileInput.addEventListener('change', async (e)=>{
      resetUI();
      const file = e.target.files && e.target.files[0];
      if(!file){ return; }
      fileNameEl.textContent = file.name;

      try{
        const arr = await file.arrayBuffer();
        const wb = XLSX.read(arr, { type:'array', cellDates:true, dateNF:'yyyy-mm-dd'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        if(!ws) throw new Error('לא נמצא גיליון ראשון בקובץ.');

        // הפקה לאובייקטים (שורה ראשונה = כותרות)
        const data = XLSX.utils.sheet_to_json(ws, {
          defval: null,
          raw: true,
          dateNF: 'yyyy-mm-dd hh:mm',
          blankrows:false
        });

        if(!data.length){ throw new Error('לא נמצאו שורות מידע בקובץ.'); }

        currentRows = data;
        headers = Object.keys(data[0]||{});

        // מילוי דרופדאון לבחירה ידנית
        dateSelect.disabled = false;
        dateSelect.innerHTML = '';
        headers.forEach(h=>{
          const opt = document.createElement('option');
          opt.value = h; opt.textContent = h;
          dateSelect.appendChild(opt);
        });

        // זיהוי אוטומטי של עמודת תאריך/שעת פתיחה
        let autoKey = null;
        for(const h of headers){
          if (DATE_CANDIDATES.has(normalizeHeader(h))){
            autoKey = h; break;
          }
        }
        if(!autoKey){
          // חיפוש לפי רמזים (כולל "פתיחה" ו"תאריך")
          for(const h of headers){
            const nh = normalizeHeader(h);
            if (/(תאריך|זמן).*(פתיחה)|פתיחה.*(תאריך|זמן)/.test(nh)){
              autoKey = h; break;
            }
          }
        }

        // ברירת מחדל בדרופדאון (אם זוהה)
        if (autoKey){
          chosenDateKey = autoKey;
          dateSelect.value = autoKey;
          showOK('הקובץ נטען. עמודת תאריך זוהתה אוטומטית.');
        }else{
          chosenDateKey = headers[0];
          dateSelect.value = headers[0];
          showOK('הקובץ נטען. בחרי ידנית את עמודת התאריך מהרשימה.');
        }

        // הצגת חיווי בסיסי
        rowCountEl.textContent = `${currentRows.length.toLocaleString('he-IL')} שורות`;
        detectedCol.textContent = 'עמודת תאריך שזוהתה: ' + (chosenDateKey || '—');
        dash.classList.remove('hidden');

      }catch(err){
        console.error(err);
        showErr('שגיאה בטעינת XLSX. נסי לשמור כ-Excel רגיל (Workbook), להסיר נוסחאות/מיזוגים, ולוודא ששורת הכותרות היא הראשונה.');
      }
    });

    // בחירה ידנית של עמודת תאריך
    dateSelect.addEventListener('change', ()=>{
      chosenDateKey = dateSelect.value || null;
      detectedCol.textContent = 'עמודת תאריך שזוהתה: ' + (chosenDateKey || '—');
      showOK('נבחרה עמודת תאריך ידנית.');
    });

    // תוספת קטנה: לחיצה על "העלאת Excel" תפתח את בוחר הקבצים
    document.querySelector('label[for="file"]').addEventListener('click', ()=> fileInput.click());
  })();
  </script>
</body>
</html>
