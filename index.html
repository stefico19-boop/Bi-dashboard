<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>דשבורד BI — פתוחות • גרפים + Drill-Down + ייצוא XLSX</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html{scroll-behavior:smooth}
    .num{font-variant-numeric:tabular-nums}
    .glass{backdrop-filter: blur(10px); background:rgba(255,255,255,.72)}
    .card{transition:.2s; border-radius:1.2rem}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 30px rgba(2,6,23,.15)}
    .grid-auto{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem}
    @media (prefers-color-scheme: dark){
      body{background:#0b0c10;color:#f3f4f6}
      .glass{background:rgba(17,24,39,.6);border-color:#374151}
    }
    .clickable{cursor:pointer}
    table th, table td{white-space:nowrap}
  </style>
</head>
<body class="bg-gradient-to-b from-[#eef2ff] via-white to-[#f8fafc] min-h-screen">
  <!-- NAV -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-white/50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 shadow-inner"></div>
        <div>
          <h1 class="text-xl font-extrabold tracking-tight">דשבורד BI • פניות פתוחות</h1>
          <p class="text-xs text-slate-500">השוואה יומית • SLA • פילוחים • גרפים • Drill-Down • ייצוא ‎.xlsx</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <label class="px-4 py-2 rounded-xl bg-indigo-600 text-white shadow cursor-pointer hover:bg-indigo-700">
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden">
          העלאת Excel
        </label>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- CONFIG -->
    <section class="glass p-4 border rounded-2xl card">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs text-slate-500 mb-1">עמודת תאריך סנאפשוט</label>
          <input id="dateCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="תאריך בדיקה"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">עמודת סטטוס</label>
          <input id="statusCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="סטאטוס פניה"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">עמודת מחלקה</label>
          <input id="deptCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="מחלקה מטפלת"/>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnRecalc" class="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white shadow">חשב</button>
          <button id="btnReset" class="px-4 py-2 rounded-xl bg-white border shadow">איפוס</button>
        </div>
      </div>
      <details class="mt-3">
        <summary class="text-sm text-slate-600 cursor-pointer">הגדרות מתקדמות</summary>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-3">
          <div><label class="block text-xs text-slate-500 mb-1">יחידה מטפלת</label><input id="unitCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="יחידה מטפלת"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">עיר</label><input id="cityCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="עיר"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">מקור פניה</label><input id="sourceCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="מקור פניה"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">סיווג נושא/בעיה</label><input id="issueCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="סיווג נושא"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">מספר מעקב</label><input id="trackCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="מספר מעקב"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">שם לקוח</label><input id="nameCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="שם לקוח"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">מייל לקוח</label><input id="mailCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="מייל לקוח"/></div>
          <div><label class="block text-xs text-slate-500 mb-1">תאריך/שעת פתיחה</label><input id="openDateTimeCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="תאריך/שעת פתיחה"/></div>
          <div class="md:col-span-2">
            <label class="block text-xs text-slate-500 mb-1">סטטוסים שמוגדרים כ"פתוח" (פסיק בין ערכים)</label>
            <input id="openStatuses" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="חדש, בתהליך, המתנה לגורם פנימי, המתנה למסמכים מהלקוח"/>
          </div>
          <p class="text-xs text-slate-500 md:col-span-2">נשמר מקומית בלבד (localStorage). אין שליחה לשום שרת.</p>
        </div>
      </details>
      <p id="msg" class="text-sm text-slate-600 mt-2">העלי קובץ Excel (גיליון ראשון). אם שמות העמודות שונים – עדכני בשדות ואז לחצי “חשב”.</p>
    </section>

    <!-- KPI CARDS -->
    <section id="kpis" class="grid-auto mt-6 hidden">
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">סה״כ פתוחות היום</span>
          <button id="btnOpenToday" class="text-xs px-2 py-1 rounded-lg border bg-white">פתח טבלה</button>
        </div>
        <div class="text-3xl font-extrabold mt-2 num" id="openCurrent">—</div>
        <div class="text-xs text-slate-500">תאריך: <span id="dateCurrent">—</span></div>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">פתוחות קודם</span>
          <button id="btnOpenPrev" class="text-xs px-2 py-1 rounded-lg border bg-white">פתח טבלה</button>
        </div>
        <div class="text-3xl font-extrabold mt-2 num" id="openPrev">—</div>
        <div class="text-xs text-slate-500">תאריך: <span id="datePrev">—</span></div>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">שינוי יומי</span>
          <span class="text-xs px-2 py-1 rounded-lg border bg-white" id="deltaAbsNote">Δ</span>
        </div>
        <div class="text-3xl font-extrabold mt-2 num" id="deltaAbs">—</div>
        <div class="text-xs text-slate-500">באחוזים: <span id="deltaPct">—</span></div>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">SLA — שיעור חריגה</span>
          <button id="btnOpenSLA" class="text-xs px-2 py-1 rounded-lg border bg-white">פתח טבלה</button>
        </div>
        <div class="text-3xl font-extrabold mt-2 num" id="slaRate">—</div>
        <div class="text-xs text-slate-500">בתוך SLA: <span id="slaOk">—</span> • חריגות: <span id="slaBad">—</span></div>
      </div>
    </section>

    <!-- CHARTS -->
    <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6 hidden">
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">מגמת פתוחות לפי תאריך</h3>
          <button id="exportTrend" class="text-sm px-3 py-1.5 rounded-lg border bg-white">ייצוא CSV</button>
        </div>
        <canvas id="trendChart" height="140"></canvas>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">התפלגות SLA (היום)</h3>
          <button id="btnOpenSLAChart" class="text-sm px-3 py-1.5 rounded-lg border bg-white">פתח טבלה</button>
        </div>
        <canvas id="slaPieChart" height="140"></canvas>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">מחלקות — היום מול קודם</h3>
          <button id="btnOpenDeptAll" class="text-sm px-3 py-1.5 rounded-lg border bg-white">פתח טבלת מחלקות</button>
        </div>
        <canvas id="deptBar" height="160" class="clickable"></canvas>
        <p class="text-xs text-slate-500 mt-1">טיפ: לחיצה על עמודה תפתח פירוט לאותה מחלקה (היום/קודם).</p>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">מקור פנייה — מחסנית</h3>
          <button id="btnOpenSourceAll" class="text-sm px-3 py-1.5 rounded-lg border bg-white">פתח טבלת מקורות</button>
        </div>
        <canvas id="sourceStack" height="160" class="clickable"></canvas>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">ערים בעייתיות (Top 10)</h3>
        <button id="btnOpenCityAll" class="text-sm px-3 py-1.5 rounded-lg border bg-white">פתח טבלת ערים</button>
        </div>
        <canvas id="cityHBar" height="200" class="clickable"></canvas>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">יחידות בעייתיות (Top 10)</h3>
          <button id="btnOpenUnitAll" class="text-sm px-3 py-1.5 rounded-lg border bg-white">פתח טבלת יחידות</button>
        </div>
        <canvas id="unitHBar" height="200" class="clickable"></canvas>
      </div>
    </section>

    <!-- TABLES OVERVIEW -->
    <section id="tables" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6 hidden">
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">SLA לפי מחלקה</h3>
          <button id="exportSlaDept" class="text-sm px-3 py-1.5 rounded-lg border bg-white">ייצוא CSV</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100/70">
              <tr>
                <th class="text-right p-2">מחלקה</th>
                <th class="text-right p-2">בתוך SLA</th>
                <th class="text-right p-2">חריגות</th>
                <th class="text-right p-2">% חריגה</th>
                <th class="text-right p-2">פתח</th>
              </tr>
            </thead>
            <tbody id="slaBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>
      <div class="card p-4 border glass">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">כפילויות (מס' מעקב/שם/מייל)</h3>
          <button id="exportDups" class="text-sm px-3 py-1.5 rounded-lg border bg-white">ייצוא CSV</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100/70">
              <tr>
                <th class="text-right p-2">שדה</th>
                <th class="text-right p-2">ערך</th>
                <th class="text-right p-2">כמות</th>
                <th class="text-right p-2">פתח</th>
              </tr>
            </thead>
            <tbody id="dupsBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- DETAIL MODAL -->
  <dialog id="detailModal" class="rounded-2xl p-0 w-[min(98vw,1200px)]">
    <form method="dialog" class="glass p-4 rounded-2xl border">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h3 id="detailTitle" class="text-lg font-semibold">פירוט</h3>
          <p id="detailSub" class="text-sm text-slate-500"></p>
        </div>
        <div class="flex items-center gap-2">
          <input id="detailSearch" placeholder="חיפוש בטבלה..." class="text-sm border rounded-lg px-2 py-1"/>
          <button id="btnExportXlsx" type="button" class="px-3 py-2 rounded-xl border bg-white">ייצוא .xlsx</button>
          <button class="px-3 py-2 rounded-xl border bg-white">סגור</button>
        </div>
      </div>
      <div class="overflow-auto max-h-[70vh]">
        <table class="min-w-full text-sm">
          <thead id="detailHead" class="bg-slate-100/70"></thead>
          <tbody id="detailBody" class="divide-y"></tbody>
        </table>
      </div>
    </form>
  </dialog>

  <script>
    // -------- Helpers --------
    const $ = id => document.getElementById(id);
    const lc = s => (s??'').toString().trim().toLowerCase();
    const fmt = d => String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
    const snap = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    function parseExcelDate(v){
      if (v==null || v==='') return null;
      if (v instanceof Date) return v;
      if (typeof v==='number'){ return new Date(Math.round((v-25569)*86400*1000)); }
      const d = new Date(v); if(!isNaN(d)) return d;
      const m = String(v).trim().match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if (m){ return new Date(+m[3],+m[2]-1,+m[1],+(m[4]||0),+(m[5]||0),+(m[6]||0)); }
      return null;
    }
    function toCSV(rows){ if(!rows.length) return ''; const headers=Object.keys(rows[0]); const esc=s=> '"'+String(s).replaceAll('"','""')+'"'; return [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h]??'')).join(','))).join('\n'); }
    function exportXlsx(filename, rows){
      if(!rows || !rows.length){ alert('אין נתונים לייצוא'); return; }
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'data');
      XLSX.writeFile(wb, filename);
    }

    // -------- Config LS --------
    const cfgEls = ['dateCol','statusCol','deptCol','unitCol','cityCol','sourceCol','issueCol','trackCol','nameCol','mailCol','openDateTimeCol','openStatuses'].map($);
    const LS_CFG='lux_bi_cfg_v3';
    function saveCfg(){ const v={}; cfgEls.forEach(e=>v[e.id]=e.value); localStorage.setItem(LS_CFG,JSON.stringify(v)); }
    function loadCfg(){ try{const v=JSON.parse(localStorage.getItem(LS_CFG)||'null'); if(!v) return; cfgEls.forEach(e=> e.value = v[e.id] ?? e.value);}catch{} }
    cfgEls.forEach(e=> e.addEventListener('input',saveCfg)); loadCfg();

    // -------- SLA rules --------
    function slaDurationMs(row, cfg){
      const dept=lc(row[cfg.deptCol]), issue=lc(row[cfg.issueCol]);
      if (issue.includes('תקלה בפורטל')) return 24*60*60*1000;
      if (dept.includes('בינלאומי')) return 60*24*60*60*1000;
      if (dept.includes('פנים') && (issue.includes('חלוקת דואר') || issue.includes('יחידות דואר'))) return 8*24*60*60*1000;
      if (dept.includes('שליח') && issue.includes('איסוף והזמנה')) return 24*60*60*1000;
      if (dept.includes('פנים') || dept.includes('שליח')) return 30*24*60*60*1000;
      return null;
    }

    // -------- State --------
    let ALL=[], CTX=null, charts={};

    function groupCount(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); m.set(k,(m.get(k)||0)+1); } return m; }
    function asRows(keys,gPrev,gCurr,label){ const out=[]; for(const k of keys){ const p=gPrev.get(k)||0, c=gCurr.get(k)||0; out.push({[label]:k,'קודם':p,'היום':c,'Δ':c-p,'Δ%': p?(((c-p)/p*100).toFixed(1)+'%'):''}); } return out.sort((a,b)=>b['היום']-a['היום']); }

    function calc(){
      const cfg={
        dateCol: $('dateCol').value.trim(), statusCol:$('statusCol').value.trim(), deptCol:$('deptCol').value.trim(),
        unitCol:$('unitCol').value.trim(), cityCol:$('cityCol').value.trim(), sourceCol:$('sourceCol').value.trim(),
        issueCol:$('issueCol').value.trim(), trackCol:$('trackCol').value.trim(), nameCol:$('nameCol').value.trim(),
        mailCol:$('mailCol').value.trim(), openDateTimeCol:$('openDateTimeCol').value.trim()
      };
      cfg.openSet=new Set(($('openStatuses').value||'').split(',').map(s=>s.trim()).filter(Boolean));

      // parse dates safely (fix getFullYear error)
      const base = ALL.map(r=> ({...r, __d: parseExcelDate(r[cfg.dateCol])}));
      const onlyD = base.filter(r=> r.__d instanceof Date);
      if(!onlyD.length){ $('msg').textContent='לא נמצאו תאריכים תקינים בעמודה "'+cfg.dateCol+'" (בדקי שם עמודה/פורמט).'; return; }
      const withSnap = onlyD.map(r=> ({...r, __snap: snap(r.__d)}));

      const dates=[...new Set(withSnap.map(r=>r.__snap.getTime()))].sort((a,b)=>a-b).map(t=>new Date(t));
      const current=dates.at(-1), prev=dates.length>1?dates.at(-2):null;
      if(!prev){ $('msg').textContent='נדרש לפחות עוד יום אחד להשוואה (העליתי רק סנאפשוט אחד).'; }

      const isOpen = s=> s!=null && cfg.openSet.has(String(s).trim());
      const currOpen=withSnap.filter(r=>r.__snap.getTime()===current.getTime() && isOpen(r[cfg.statusCol]));
      const prevOpen= prev ? withSnap.filter(r=>r.__snap.getTime()===prev.getTime() && isOpen(r[cfg.statusCol])) : [];

      const totalsByDate = dates.map(d=>({date:d, open: withSnap.filter(r=>r.__snap.getTime()===d.getTime() && isOpen(r[cfg.statusCol])).length}));

      const keyDept=r=>(r[cfg.deptCol]||'לא צוין').toString().trim()||'לא צוין';
      const keyCity=r=>(r[cfg.cityCol]||'לא צוין').toString().trim()||'לא צוין';
      const keyUnit=r=>(r[cfg.unitCol]||'לא צוין').toString().trim()||'לא צוין';
      const keySource=r=>(r[cfg.sourceCol]||'לא צוין').toString().trim()||'לא צוין';

      const prevDept=groupCount(prevOpen,keyDept), currDept=groupCount(currOpen,keyDept);
      const prevCity=groupCount(prevOpen,keyCity), currCity=groupCount(currOpen,keyCity);
      const prevUnit=groupCount(prevOpen,keyUnit), currUnit=groupCount(currOpen,keyUnit);
      const prevSrc =groupCount(prevOpen,keySource), currSrc =groupCount(currOpen,keySource);

      const byDept=asRows(new Set([...prevDept.keys(),...currDept.keys()]),prevDept,currDept,'מחלקה');
      const byCity=asRows(new Set([...prevCity.keys(),...currCity.keys()]),prevCity,currCity,'עיר').slice(0,10);
      const byUnit=asRows(new Set([...prevUnit.keys(),...currUnit.keys()]),prevUnit,currUnit,'יחידה').slice(0,10);
      const bySource=asRows(new Set([...prevSrc.keys(),...currSrc.keys()]),prevSrc,currSrc,'מקור');

      // Duplicates (today)
      function dup(field,title){ const fld=cfg[field+'Col']; if(!fld) return []; const m=new Map(); for(const r of currOpen){ const k=(r[fld]??'').toString().trim(); if(!k) continue; m.set(k,(m.get(k)||0)+1);} const out=[]; for(const [v,c] of m.entries()) if(c>1) out.push({שדה:title,ערך:v,כמות:c}); return out.sort((a,b)=>b.כמות-a.כמות).slice(0,200); }
      const dups=[...dup('track','מספר מעקב'),...dup('name','שם לקוח'),...dup('mail','מייל לקוח')];

      // SLA
      const slaMap=new Map(); let ok=0,bad=0,unk=0;
      currOpen.forEach(r=>{
        const openDt=parseExcelDate(r[cfg.openDateTimeCol]); const dur=slaDurationMs(r,cfg);
        let st='unknown'; if(openDt && dur!=null){ const deadline=new Date(openDt.getTime()+dur); st = deadline.getTime()>=current.getTime() ? 'ok' : 'bad'; }
        if(st==='ok') ok++; else if(st==='bad') bad++; else unk++;
        const d=keyDept(r); if(!slaMap.has(d)) slaMap.set(d,{ok:0,bad:0,unk:0}); slaMap.get(d)[st==='ok'?'ok':(st==='bad'?'bad':'unk')]++;
      });
      const slaRows=[...slaMap.entries()].map(([d,v])=>({'מחלקה':d,'בתוך SLA':v.ok,'חריגות':v.bad,'% חריגה':(v.ok+v.bad)?((v.bad/(v.ok+v.bad)*100).toFixed(1)+'%'):''})).sort((a,b)=>b['חריגות']-a['חריגות']);
      const slaPie=[{label:'בתוך SLA',value:ok},{label:'חרגו SLA',value:bad},{label:'לא ניתן לחשב',value:unk}];

      const totPrev=prevOpen.length, totCurr=currOpen.length, delta=totCurr-totPrev, pct=totPrev?((delta)/totPrev*100):null;
      CTX={cfg, dates:{current,prev}, currOpen, prevOpen, totals:{prev:totPrev,curr:totCurr,delta,pct}, totalsByDate, byDept, byCity, byUnit, bySource, dups, slaRows, slaPie};
      render();
    }

    // -------- Detail modal --------
    const detailModal=$('detailModal'), detailTitle=$('detailTitle'), detailSub=$('detailSub'), detailHead=$('detailHead'), detailBody=$('detailBody');
    let _detailRows=[];
    function openDetail(title, sub, rows){
      _detailRows = rows.slice();
      detailTitle.textContent = title;
      detailSub.textContent = sub||'';
      detailHead.innerHTML=''; detailBody.innerHTML='';
      if(!_detailRows.length){ detailBody.innerHTML='<tr><td class="p-3">אין נתונים להצגה</td></tr>'; detailModal.showModal(); return; }
      const headers = Object.keys(_detailRows[0]);
      const trh = document.createElement('tr');
      trh.innerHTML = headers.map(h=>`<th class="text-right p-2">${h}</th>`).join('');
      detailHead.appendChild(trh);
      const renderBody = (arr)=> {
        detailBody.innerHTML='';
        arr.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=headers.map(h=>`<td class="p-2 ${typeof r[h]==='number'?'num':''}">${r[h]??''}</td>`).join('');
          detailBody.appendChild(tr);
        });
      };
      renderBody(_detailRows);
      $('detailSearch').value='';
      $('detailSearch').oninput = (e)=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q){ renderBody(_detailRows); return; }
        const f = _detailRows.filter(r=> Object.values(r).some(v=> String(v).toLowerCase().includes(q)));
        renderBody(f);
      };
      $('btnExportXlsx').onclick = ()=> exportXlsx((title||'details')+'.xlsx', _detailRows);
      detailModal.showModal();
    }

    // -------- Render --------
    function tbody(id, rows, withOpenCb){
      const el=$(id); el.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const keys=Object.keys(r);
        tr.innerHTML=keys.map(k=>`<td class="p-2 ${typeof r[k]==='number'?'num':''}">${r[k]}</td>`).join('')
          + (withOpenCb?`<td class="p-2"><button class="text-xs px-2 py-1 rounded-lg border bg-white">פתח</button></td>`:'');
        el.appendChild(tr);
        if(withOpenCb){ tr.querySelector('button').onclick = ()=> withOpenCb(r); }
      });
    }
    function makeChart(id, cfg){ if(charts[id]) charts[id].destroy(); charts[id]=new Chart($(id).getContext('2d'), cfg); }

    function render(){
      $('kpis').classList.remove('hidden'); $('charts').classList.remove('hidden'); $('tables').classList.remove('hidden');
      $('dateCurrent').textContent=fmt(CTX.dates.current); $('datePrev').textContent= CTX.dates.prev?fmt(CTX.dates.prev):'—';
      $('openCurrent').textContent=CTX.totals.curr; $('openPrev').textContent=CTX.totals.prev;
      $('deltaAbs').textContent=(CTX.totals.delta>0?'+':'')+CTX.totals.delta;
      $('deltaPct').textContent=CTX.totals.pct!=null?CTX.totals.pct.toFixed(1)+'%':'';
      const ok=CTX.slaPie.find(x=>x.label==='בתוך SLA')?.value||0, bad=CTX.slaPie.find(x=>x.label==='חרגו SLA')?.value||0;
      $('slaOk').textContent=ok; $('slaBad').textContent=bad; $('slaRate').textContent= (ok+bad>0? (bad/(ok+bad)*100).toFixed(1)+'%':'—');

      tbody('slaBody', CTX.slaRows, (row)=>{
        const dept = row['מחלקה'];
        const rows = CTX.currOpen.filter(r=> (r[CTX.cfg.deptCol]||'').toString().trim()===dept);
        openDetail('פירוט SLA — '+dept, 'שורות מתוך היום', rows);
      });
      tbody('dupsBody', CTX.dups, (row)=>{
        let fld=CTX.cfg.trackCol, title=row['שדה'];
        if(title==='שם לקוח') fld=CTX.cfg.nameCol;
        if(title==='מייל לקוח') fld=CTX.cfg.mailCol;
        const rows = CTX.currOpen.filter(r=> (r[fld]||'').toString().trim()===row['ערך']);
        openDetail('פירוט כפילויות — '+title+'='+row['ערך'], 'שורות מתוך היום', rows);
      });

      makeChart('trendChart', {type:'line', data:{ labels: CTX.totalsByDate.map(x=>fmt(x.date)), datasets:[{label:'פתוחות', data: CTX.totalsByDate.map(x=>x.open), tension:.35, fill:true}] }, options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
      makeChart('slaPieChart', {type:'doughnut', data:{labels:CTX.slaPie.map(x=>x.label), datasets:[{data:CTX.slaPie.map(x=>x.value)}]}, options:{plugins:{legend:{position:'bottom'}}}});
      const labelsDept=CTX.byDept.map(r=>r['מחלקה']);
      makeChart('deptBar',{type:'bar', data:{labels:labelsDept, datasets:[{label:'היום', data:CTX.byDept.map(r=>r['היום'])},{label:'קודם', data:CTX.byDept.map(r=>r['קודם'])}]}, options:{plugins:{legend:{position:'bottom'}}, scales:{x:{ticks:{autoSkip:false}},y:{beginAtZero:true}}, onClick:(e,els)=>{ if(!els.length) return; const el=els[0]; const label=labelsDept[el.index]; const ds=e.chart.data.datasets[el.datasetIndex].label; const rows = (ds==='היום'? CTX.currOpen:CTX.prevOpen).filter(r=> (r[CTX.cfg.deptCol]||'').toString().trim()===label); openDetail(`מחלקה: ${label}`, `מקור: ${ds}`, rows); } }});
      const labelsSrc=CTX.bySource.map(r=>r['מקור']);
      makeChart('sourceStack',{type:'bar', data:{labels:labelsSrc, datasets:[{label:'היום', data:CTX.bySource.map(r=>r['היום'])},{label:'קודם', data:CTX.bySource.map(r=>r['קודם'])}]}, options:{plugins:{legend:{position:'bottom'}}, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}, onClick:(e,els)=>{ if(!els.length) return; const el=els[0]; const label=labelsSrc[el.index]; const ds=e.chart.data.datasets[el.datasetIndex].label; const rows = (ds==='היום'? CTX.currOpen:CTX.prevOpen).filter(r=> (r[CTX.cfg.sourceCol]||'').toString().trim()===label); openDetail(`מקור פנייה: ${label}`, `מקור: ${ds}`, rows); } }});
      makeChart('cityHBar',{type:'bar', data:{labels:CTX.byCity.map(r=>r['עיר']), datasets:[{label:'היום', data:CTX.byCity.map(r=>r['היום'])}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}}, onClick:(e,els)=>{ if(!els.length) return; const label=e.chart.data.labels[els[0].index]; const rows=CTX.currOpen.filter(r=> (r[CTX.cfg.cityCol]||'').toString().trim()===label); openDetail('עיר: '+label,'שורות היום', rows); } }});
      makeChart('unitHBar',{type:'bar', data:{labels:CTX.byUnit.map(r=>r['יחידה']), datasets:[{label:'היום', data:CTX.byUnit.map(r=>r['היום'])}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}}, onClick:(e,els)=>{ if(!els.length) return; const label=e.chart.data.labels[els[0].index]; const rows=CTX.currOpen.filter(r=> (r[CTX.cfg.unitCol]||'').toString().trim()===label); openDetail('יחידה: '+label,'שורות היום', rows); } }});

      // KPI drill
      $('btnOpenToday').onclick = ()=> openDetail('כל הפניות הפתוחות — היום', fmt(CTX.dates.current), CTX.currOpen);
      $('btnOpenPrev').onclick  = ()=> openDetail('כל הפניות הפתוחות — קודם', CTX.dates.prev?fmt(CTX.dates.prev):'—', CTX.prevOpen);
      $('btnOpenSLA').onclick   = ()=> {
        const okRows=[], badRows=[], unkRows=[];
        CTX.currOpen.forEach(r=>{
          const dur=slaDurationMs(r,CTX.cfg); const openDt=parseExcelDate(r[CTX.cfg.openDateTimeCol]);
          let st='unk'; if(openDt && dur!=null){ const deadline=new Date(openDt.getTime()+dur); st = deadline.getTime()>=CTX.dates.current.getTime() ? 'ok':'bad'; }
          if(st==='ok') okRows.push(r); else if(st==='bad') badRows.push(r); else unkRows.push(r);
        });
        openDetail('SLA — פירוט היום', `בתוך:${okRows.length} | חריגות:${badRows.length} | לא ניתן לחשב:${unkRows.length}`, okRows.concat(badRows).concat(unkRows));
      };
      $('btnOpenSLAChart').onclick = $('btnOpenSLA').onclick;

      // “פתח טבלה” כלליות לפי קבוצות
      $('btnOpenDeptAll').onclick = ()=> openDetail('טבלת מחלקות — היום', 'לפי מחלקה', CTX.currOpen);
      $('btnOpenSourceAll').onclick = ()=> openDetail('טבלת מקורות — היום', 'לפי מקור פנייה', CTX.currOpen);
      $('btnOpenCityAll').onclick = ()=> openDetail('טבלת ערים — היום', 'לפי עיר', CTX.currOpen);
      $('btnOpenUnitAll').onclick = ()=> openDetail('טבלת יחידות — היום', 'לפי יחידה', CTX.currOpen);

      // Export CSV מהיר
      $('exportTrend').onclick=()=> {
        const rows=CTX.totalsByDate.map(x=>({תאריך:fmt(x.date), פתוחות:x.open}));
        const csv = toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='trend.csv'; a.click(); URL.revokeObjectURL(url);
      };
      $('exportSlaDept').onclick=()=> {
        const csv = toCSV(CTX.slaRows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sla_by_department.csv'; a.click(); URL.revokeObjectURL(url);
      };
      $('exportDups').onclick=()=> {
        const csv = toCSV(CTX.dups); const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); const a=document.createElement('a'); a.href=url; a.download='duplicates.csv'; a.click(); URL.revokeObjectURL(url);
      };

      $('msg').textContent='הקובץ נטען. לחצי על “פתח טבלה” או על עמודות בגרפים כדי להוריד פירוט כ-.xlsx';
    }

    // -------- File input & buttons --------
    $('fileInput').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return; $('msg').textContent='טוען קובץ…';
      try{
        const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{defval:''}); if(!rows.length) throw new Error('אין נתונים בקובץ');
        ALL=rows; saveCfg(); calc();
      }catch(err){ console.error(err); $('msg').textContent='שגיאה: '+err.message; }
    });
    $('btnRecalc').onclick=calc;
    $('btnReset').onclick=()=>{ ALL=[]; CTX=null; Object.values(charts).forEach(c=>c.destroy()); charts={}; document.querySelectorAll('tbody').forEach(t=>t.innerHTML=''); ['kpis','charts','tables'].forEach(id=>$(id).classList.add('hidden')); $('msg').textContent='נא להעלות קובץ חדש.'; };
  </script>
</body>
</html>
