<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BI • פניות פתוחות (לפי תאריך/שעת פתיחה)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{background:linear-gradient(180deg,#fafaff,#f4f6ff);}
  .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(59,64,87,.08);padding:16px}
  .btn{border-radius:14px}
  .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .scroll-x{overflow:auto}
</style>
</head>
<body class="text-slate-800">
<div class="max-w-5xl mx-auto p-4 sm:p-6">
  <header class="mb-4">
    <h1 class="text-3xl sm:text-4xl font-extrabold">דשבורד • BI • פניות פתוחות</h1>
    <p class="mt-2 text-slate-600">כל החישובים מתבססים אך ורק על <b>״תאריך/שעת פתיחה״</b> (לא משתמש ב״שונה לאחרונה״).</p>
  </header>

  <!-- העלאה + סטטוס קובץ -->
  <section class="card mb-4">
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
      <label for="fileInput"
             class="btn px-5 py-3 bg-indigo-600 text-white font-semibold cursor-pointer text-center sm:w-auto">
        העלאת Excel
      </label>
      <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden" />
      <div id="fileBadge" class="flex-1 px-4 py-3 rounded-2xl bg-indigo-50 text-indigo-800">
        לא נבחר קובץ
      </div>
      <button id="btnClear" class="btn px-4 py-2 bg-rose-50 text-rose-700 ms-auto">ניקוי</button>
    </div>

    <!-- כרטיס סטטוס הקובץ (חזרנו לגרסה שהייתה) -->
    <div id="fileStatus" class="card mt-4 hidden">
      <div class="text-sm text-slate-500">
        <span class="font-bold" id="stFileName">—</span> ·
        <span>שורות:</span> <b id="stRows">0</b> ·
        <span id="stStamp"></span>
      </div>
      <div id="stOk" class="mt-1 text-emerald-700">✔ הקובץ עלה בהצלחה</div>
      <div id="stErr" class="mt-1 text-rose-700 hidden">⚠︎ שגיאה בטעינת הקובץ</div>
    </div>

    <!-- מיפוי עמודות (אם צריך) -->
    <details class="mt-4">
      <summary class="cursor-pointer text-sm text-slate-600">מיפוי עמודות (רק אם שמות הכותרות שונים)</summary>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="card">
          <label class="text-sm">עמודת תאריך/שעת פתיחה</label>
          <select id="colOpen" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
        <div class="card">
          <label class="text-sm">עמודת סטטוס פנייה</label>
          <select id="colStatus" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
        <div class="card">
          <label class="text-sm">עמודת מחלקה מטפלת</label>
          <select id="colDept" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
        <div class="card">
          <label class="text-sm">מס׳ מעקב (כפילויות)</label>
          <select id="colTrack" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
        <div class="card">
          <label class="text-sm">שם לקוח (כפילויות)</label>
          <select id="colName" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
        <div class="card">
          <label class="text-sm">אימייל (כפילויות)</label>
          <select id="colEmail" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </div>
      </div>
    </details>
  </section>

  <!-- KPIs -->
  <section id="kpiWrap" class="grid-auto mb-4" hidden>
    <div class="card">
      <div class="text-slate-500 text-sm">סה״כ שורות בקובץ</div>
      <div id="kpiTotal" class="text-4xl font-extrabold">0</div>
    </div>
    <div class="card">
      <div class="text-slate-500 text-sm">פתוחות היום (לפי תאריך פתיחה)</div>
      <div id="kpiToday" class="text-4xl font-extrabold">0</div>
      <div id="lblToday" class="text-xs text-slate-500 mt-1"></div>
    </div>
    <div class="card">
      <div class="text-slate-500 text-sm">פתוחות אתמול (לפי תאריך פתיחה)</div>
      <div id="kpiYesterday" class="text-4xl font-extrabold">0</div>
      <div id="lblYesterday" class="text-xs text-slate-500 mt-1"></div>
    </div>
    <div class="card">
      <div class="text-slate-500 text-sm">שינוי יומי</div>
      <div id="kpiDelta" class="text-4xl font-extrabold">0</div>
      <div id="kpiDeltaPct" class="text-xs text-slate-500 mt-1"></div>
    </div>
  </section>

  <!-- טבלאות קצר -->
  <section id="panelsWrap" class="grid-auto" hidden>
    <div class="card">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">פירוט לפי סטטוס</h3>
        <button class="btn px-3 py-2 bg-indigo-50 text-indigo-700" onclick="openTable('status')">לטבלה</button>
      </div>
      <div id="statusTable" class="scroll-x text-sm"></div>
    </div>

    <div class="card">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">כפילויות לפי מס׳ מעקב</h3>
        <button class="btn px-3 py-2 bg-indigo-50 text-indigo-700" onclick="openTable('dupTrack')">לטבלה</button>
      </div>
      <div id="dupTrackCnt" class="text-2xl font-bold">0</div>
    </div>

    <div class="card">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">כל הפניות</h3>
        <button class="btn px-3 py-2 bg-indigo-600 text-white" onclick="openTable('all')">פתחי טבלה</button>
      </div>
      <div class="text-sm text-slate-500">טבלת Drill-Down עם חיפוש ויצוא ‎.xlsx</div>
    </div>
  </section>

  <!-- מודל טבלאות -->
  <dialog id="dlg" class="w-[min(100vw,1100px)] rounded-2xl p-0">
    <div class="p-4 sm:p-5">
      <div class="flex items-center justify-between">
        <h3 id="dlgTitle" class="text-xl font-extrabold">טבלה</h3>
        <div class="flex gap-2">
          <button id="btnExport" class="btn px-3 py-2 bg-indigo-50 text-indigo-700">ייצוא ‎.xlsx</button>
          <button onclick="dlg.close()" class="btn px-3 py-2 bg-slate-100">סגירה</button>
        </div>
      </div>
      <div class="mt-3">
        <input id="tblSearch" class="w-full border rounded-lg px-3 py-2" placeholder="חיפוש בטבלה..." />
      </div>
      <div id="tblWrap" class="scroll-x mt-3"></div>
    </div>
  </dialog>
</div>

<script>
/* ===== עזר ===== */
const TZ='Asia/Jerusalem';
const fmt = d => new Intl.DateTimeFormat('he-IL',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
const today = new Date(new Date().toLocaleString('en-CA',{timeZone:TZ}));
const yest = new Date(today); yest.setDate(today.getDate()-1);

function toDateOnly(v){
  if(v==null||v==='')return null;
  if(typeof v==='number'){ const d=XLSX.SSF.parse_date_code(v); return new Date(Date.UTC(d.y,d.m-1,d.d)); }
  const s=String(v).trim();
  const justDate = s.split(/[ T]/)[0].replaceAll('.', '/').replaceAll('-', '/');
  const p1 = justDate.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  const p2 = justDate.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
  let d=null;
  if(p2){ d=new Date(Date.UTC(+p2[1],+p2[2]-1,+p2[3])); }
  else if(p1){ const y=p1[3].length===2? +('20'+p1[3]) : +p1[3]; d=new Date(Date.UTC(y,+p1[2]-1,+p1[1])); }
  else { const t=new Date(s); if(!isNaN(t)) d=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())); }
  return d;
}
const clean = x=>String(x??'').trim();

/* ===== מצב ===== */
let rows=[], headers=[], mapped={}, dataOpenOnly=[], tablesCache={};

/* ===== DOM ===== */
const elFile=document.getElementById('fileInput');
const fileBadge=document.getElementById('fileBadge');
const fileStatus=document.getElementById('fileStatus');
const stFileName=document.getElementById('stFileName');
const stRows=document.getElementById('stRows');
const stStamp=document.getElementById('stStamp');
const stOk=document.getElementById('stOk');
const stErr=document.getElementById('stErr');
const btnClear=document.getElementById('btnClear');

const selects={
  colOpen:document.getElementById('colOpen'),
  colStatus:document.getElementById('colStatus'),
  colDept:document.getElementById('colDept'),
  colTrack:document.getElementById('colTrack'),
  colName:document.getElementById('colName'),
  colEmail:document.getElementById('colEmail'),
};
const kpiWrap=document.getElementById('kpiWrap');
const panelsWrap=document.getElementById('panelsWrap');
const kpiTotal=document.getElementById('kpiTotal');
const kpiToday=document.getElementById('kpiToday');
const kpiYesterday=document.getElementById('kpiYesterday');
const kpiDelta=document.getElementById('kpiDelta');
const kpiDeltaPct=document.getElementById('kpiDeltaPct');
const lblToday=document.getElementById('lblToday');
const lblYesterday=document.getElementById('lblYesterday');
const statusTable=document.getElementById('statusTable');
const dupTrackCnt=document.getElementById('dupTrackCnt');

const dlg=document.getElementById('dlg');
const dlgTitle=document.getElementById('dlgTitle');
const tblWrap=document.getElementById('tblWrap');
const tblSearch=document.getElementById('tblSearch');
const btnExport=document.getElementById('btnExport');

/* ===== העלאה ===== */
elFile.addEventListener('change', async (e)=>{
  const file=e.target.files?.[0];
  if(!file){ fileBadge.textContent='לא נבחר קובץ'; return; }
  fileBadge.textContent=file.name;
  resetStatus();

  try{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
    if(!json.length) throw new Error('הגיליון ריק');

    headers=Object.keys(json[0]);
    rows=json;
    stFileName.textContent=file.name;
    stRows.textContent=rows.length.toLocaleString('he-IL');
    stStamp.textContent='· נקרא בהצלחה';
    stOk.classList.remove('hidden');
    fileStatus.classList.remove('hidden');

    autoMap();
    fillSelects();
    calcAll();
  }catch(err){
    stStamp.textContent='· נכשלה קריאת קובץ';
    stOk.classList.add('hidden');
    stErr.classList.remove('hidden');
    fileStatus.classList.remove('hidden');
    alert('לא הצלחתי לקרוא את הקובץ. ודאי שזה ‎.xlsx/.xls והוא לא נעול.\n\n'+(err?.message||''));
  }
});

btnClear.onclick=()=>{
  rows=[]; headers=[]; mapped={}; dataOpenOnly=[]; tablesCache={};
  fileBadge.textContent='לא נבחר קובץ';
  fileStatus.classList.add('hidden');
  kpiWrap.hidden=true; panelsWrap.hidden=true;
  Object.values(selects).forEach(s=>s.innerHTML='');
};

/* ===== מיפוי אוטומטי + בחירה ידנית ===== */
function autoMap(){
  const H=headers.map(h=>h.toLowerCase().replace(/\s/g,''));
  const f=aliases=>{
    for(const a of aliases){ const i=H.findIndex(x=>x.includes(a)); if(i>-1) return headers[i]; }
    return '';
  };
  mapped.open=f(['תאריךשעתפתיחה','תאריךפתיחה','opendate','פתיחה']);
  mapped.status=f(['סטטוספניה','סטטוס','status']);
  mapped.dept=f(['מחלקהמטפלת','department','מחלקהמטפלה']);
  mapped.track=f(['מספרמעקב','tracking','מעקב']);
  mapped.name=f(['שםלקוח','שמלוקח','שם']);
  mapped.email=f(['דואראלקטרוני','אימייל','email','מייל']);
}
function fillSelects(){
  Object.values(selects).forEach(sel=>{
    sel.innerHTML=''; sel.add(new Option('(אין)',''));
    headers.forEach(h=> sel.add(new Option(h,h)));
  });
  selects.colOpen.value=mapped.open||'';
  selects.colStatus.value=mapped.status||'';
  selects.colDept.value=mapped.dept||'';
  selects.colTrack.value=mapped.track||'';
  selects.colName.value=mapped.name||'';
  selects.colEmail.value=mapped.email||'';

  Object.entries(selects).forEach(([k,sel])=>{
    sel.onchange=()=>{
      mapped.open=selects.colOpen.value;
      mapped.status=selects.colStatus.value;
      mapped.dept=selects.colDept.value;
      mapped.track=selects.colTrack.value;
      mapped.name=selects.colName.value;
      mapped.email=selects.colEmail.value;
      calcAll();
    };
  });
}

/* ===== חישובים (תאריך פתיחה בלבד) ===== */
function calcAll(){
  if(!rows.length||!mapped.open){ kpiWrap.hidden=true; panelsWrap.hidden=true; return; }

  dataOpenOnly = rows.map(r=>{
    const d=toDateOnly(r[mapped.open]);
    return {
      open:d,
      status:clean(mapped.status? r[mapped.status]:''),
      dept:clean(mapped.dept? r[mapped.dept]:''),
      track:clean(mapped.track? r[mapped.track]:''),
      name:clean(mapped.name? r[mapped.name]:''),
      email:clean(mapped.email? r[mapped.email]:'').toLowerCase(),
      _raw:r
    };
  }).filter(x=>x.open);

  const isSame=(d1,d2)=> d1.getUTCFullYear()===d2.getUTCFullYear() &&
                         d1.getUTCMonth()===d2.getUTCMonth() &&
                         d1.getUTCDate()===d2.getUTCDate();

  const openToday=dataOpenOnly.filter(x=>isSame(x.open,today));
  const openYest =dataOpenOnly.filter(x=>isSame(x.open,yest));

  kpiTotal.textContent=rows.length.toLocaleString('he-IL');
  kpiToday.textContent=openToday.length.toLocaleString('he-IL');
  kpiYesterday.textContent=openYest.length.toLocaleString('he-IL');
  lblToday.textContent=`נכון ל־${fmt(today)}`;
  lblYesterday.textContent=`נכון ל־${fmt(yest)}`;

  const delta=openToday.length-openYest.length;
  kpiDelta.textContent=(delta>=0?'+':'')+delta.toLocaleString('he-IL');
  kpiDeltaPct.textContent=`אחוזים: ${openYest.length? (delta/openYest.length*100).toFixed(1):'0.0'}%`;

  // סטטוסים
  const byStatus={};
  dataOpenOnly.forEach(x=>{ const k=x.status||'(ללא סטטוס)'; byStatus[k]=(byStatus[k]||0)+1; });
  const statusRows=Object.entries(byStatus).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({סטטוס:k,כמות:v}));
  statusTable.innerHTML=htmlTable(statusRows);

  // כפילויות (מעקב)
  const dupTrack = groupDups(x=>x.track);
  dupTrackCnt.textContent=dupTrack.length.toLocaleString('he-IL');

  // טבלאות למודל
  tablesCache={
    all:dataOpenOnly.map(x=>({'תאריך פתיחה':fmt(x.open),'סטטוס':x.status,'מחלקה מטפלת':x.dept,'מס׳ מעקב':x.track,'שם לקוח':x.name,'אימייל':x.email})),
    status:statusRows,
    dupTrack:dupTrack.flatMap(([val,arr])=>arr.map(x=>({'ערך כפול':val,'תאריך פתיחה':fmt(x.open),'סטטוס':x.status,'מחלקה':x.dept,'שם':x.name,'אימייל':x.email,'מעקב':x.track}))),
  };

  kpiWrap.hidden=false; panelsWrap.hidden=false;
}

function groupDups(keyFn){
  const m=new Map();
  dataOpenOnly.forEach(x=>{ const k=keyFn(x); if(!k) return; if(!m.has(k)) m.set(k,[]); m.get(k).push(x); });
  return [...m.entries()].filter(([,arr])=>arr.length>1);
}

/* ===== טבלאות ===== */
function htmlTable(arr){
  if(!arr.length) return '<div class="text-slate-400">אין נתונים</div>';
  const cols=Object.keys(arr[0]);
  let th=cols.map(c=>`<th class="px-3 py-2 text-start border-b">${c}</th>`).join('');
  let trs=arr.map(r=>`<tr>${cols.map(c=>`<td class="px-3 py-2 border-b">${escapeHtml(r[c])}</td>`).join('')}</tr>`).join('');
  return `<table class="min-w-[520px] text-sm"><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
}
function escapeHtml(s){return String(s??'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}

function openTable(key){
  const data=tablesCache[key]||[];
  dlgTitle.textContent=({all:'כל הפניות',status:'פירוט לפי סטטוס',dupTrack:'כפילויות לפי מס׳ מעקב'})[key]||'טבלה';
  let view=[...data];
  const render=()=>{
    const q=tblSearch.value.toLowerCase().trim();
    const f=q? view.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))) : view;
    tblWrap.innerHTML=htmlTable(f);
  };
  tblSearch.oninput=render; render();

  btnExport.onclick=()=>{
    const ws=XLSX.utils.json_to_sheet(view);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'data');
    const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([out],{type:"application/octet-stream"}),'export.xlsx');
  };

  dlg.showModal();
}

/* ===== עזרי UI ===== */
function resetStatus(){
  stOk.classList.add('hidden'); stErr.classList.add('hidden'); fileStatus.classList.add('hidden');
}
</script>
</body>
</html>
