<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת BI — העלאת קובץ</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ink: { 50:'#f8fafc', 100:'#eef2f6', 200:'#e2e8f0', 800:'#1f2937', 900:'#0b1220' },
            luxe: { 100:'#f3f4f6', 200:'#e5e7eb', 300:'#d1d5db', 700:'#374151', 900:'#111827' },
            brand: { 400:'#8b5cf6', 500:'#7c3aed', 600:'#6d28d9' },
            gold: { 400:'#f6c453', 500:'#f59e0b' }
          },
          boxShadow: {
            luxe: '0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05)',
          },
          backdropBlur: { xs: '2px' },
          borderRadius: { '3xl': '1.5rem' }
        }
      }
    }
  </script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ברק יוקרתי דק לכפתורים/כרטיסים */
    .sheen {
      position: relative;
      overflow: hidden;
    }
    .sheen::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 300%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.15) 50%, transparent 65%);
      transform: rotate(15deg);
      animation: sheen 4s infinite;
    }
    @keyframes sheen {
      0%   { transform: translateX(-30%) translateY(-30%) rotate(15deg); }
      60%  { transform: translateX(60%) translateY(60%) rotate(15deg); }
      100% { transform: translateX(60%) translateY(60%) rotate(15deg); }
    }
    /* סלוט של גרירת קובץ */
    .dropzone.dragover { border-color: #8b5cf6; background: rgba(139,92,246,.06); }
  </style>
</head>

<body class="bg-gradient-to-b from-ink-900 via-[#0d1020] to-[#0a0f1c] text-white min-h-screen">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-6">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-brand-600 to-gold-500 flex items-center justify-center shadow-luxe sheen">
        <span class="font-black text-xl">BI</span>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">מערכת BI — קליטה חכמה של קבצי Excel</h1>
        <p class="text-sm text-ink-200/80">שלב 1: העלאת קובץ XLSX, ספירת שורות ועדכון סטטוס</p>
      </div>
    </div>
  </header>

  <!-- Card -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <section class="rounded-3xl sheen shadow-luxe bg-white/5 border border-white/10 backdrop-blur-lg p-6 md:p-8">
      <!-- Status Row -->
      <div id="statusBar" class="flex flex-wrap items-center gap-3 rounded-2xl border border-white/10 bg-white/5 p-3">
        <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-ink-900/70 border border-white/10">
          <svg viewBox="0 0 24 24" fill="none" class="h-4 w-4 text-ink-200">
            <path d="M12 2v4m0 12v4M4 12H2m20 0h-2M5 5l-2-2m16 16 2 2M19 5l2-2M5 19l-2 2" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </span>
        <div class="text-sm">
          <div class="font-semibold" id="statusTitle">מוכן לקליטת קובץ</div>
          <div class="text-ink-200/80" id="statusSub">בחרי קובץ ‎.xlsx או גררי לכרטיס</div>
        </div>
        <div class="ms-auto">
          <span id="chipRows" class="hidden text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 font-semibold shadow">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Uploader -->
      <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- File input -->
        <label class="block">
          <span class="text-sm text-ink-200/90 font-medium">בחרי קובץ XLSX</span>
          <input id="fileInput" type="file" accept=".xlsx,.xlsb,.xlsm,.xls"
                 class="mt-2 w-full file:me-4 file:px-4 file:py-2 file:rounded-xl file:border-0 file:bg-gradient-to-r file:from-brand-600 file:to-gold-500 file:text-white file:font-semibold file:cursor-pointer file:shadow hover:file:opacity-95
                        bg-white/5 border border-white/10 rounded-2xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/40"/>
        </label>

        <!-- Drag & Drop -->
        <div id="dropzone"
             class="dropzone rounded-2xl border-2 border-dashed border-white/15 bg-white/5 p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-brand-500/50 transition">
          <svg viewBox="0 0 24 24" fill="none" class="h-8 w-8 text-ink-200/80">
            <path d="M7 16a5 5 0 0 1 0-10 6 6 0 0 1 11 2 4 4 0 0 1 1 7" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 12v6m0-6 2 2m-2-2-2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <p class="mt-3 text-sm text-ink-200/85">
            גררי לכאן קובץ ‎.xlsx או הקליקי לבחירה
          </p>
        </div>
      </div>

      <!-- Result line -->
      <div id="resultLine" class="mt-6 hidden rounded-xl bg-ink-900/60 border border-white/10 p-4 text-sm">
        <div class="flex items-center gap-2">
          <svg id="resultIcon" viewBox="0 0 24 24" fill="none" class="h-5 w-5 text-emerald-400">
            <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div id="resultTitle" class="font-semibold">הקובץ נקלט בהצלחה</div>
            <div id="resultSub" class="text-ink-200/80">שם קובץ • שורות • תאריך</div>
          </div>
          <span id="rowsPill" class="ms-auto hidden px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/40">
            0 שורות
          </span>
        </div>
      </div>

      <!-- Tiny footer -->
      <div class="mt-8 text-[11px] text-ink-200/60">
        טיפ: בשלב הבא נוסיף תצוגה מקדימה וטיפול בתאריכים/שעות וסכימות SLA.
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    const statusBar   = $('statusBar');
    const statusTitle = $('statusTitle');
    const statusSub   = $('statusSub');
    const chipRows    = $('chipRows');
    const resultLine  = $('resultLine');
    const resultTitle = $('resultTitle');
    const resultSub   = $('resultSub');
    const rowsPill    = $('rowsPill');
    const resultIcon  = $('resultIcon');

    function setLoadingState(isLoading) {
      if (isLoading) {
        statusTitle.textContent = 'טוען קובץ...';
        statusSub.textContent   = 'מבצע פענוח XLSX בדפדפן';
        statusBar.classList.add('animate-pulse');
      } else {
        statusBar.classList.remove('animate-pulse');
      }
    }

    function humanNumber(n) {
      return n.toLocaleString('he-IL');
    }

    function updateSuccessUI(filename, rows) {
      statusTitle.textContent = 'קובץ נטען';
      statusSub.textContent   = `${filename} • ${humanNumber(rows)} שורות`;
      chipRows.textContent    = `${humanNumber(rows)} שורות`;
      chipRows.classList.remove('hidden');

      resultTitle.textContent = 'הקובץ נקלט בהצלחה';
      resultSub.textContent   = `${filename} • ${humanNumber(rows)} שורות • ${new Date().toLocaleString('he-IL')}`;
      rowsPill.textContent    = `${humanNumber(rows)} שורות`;
      rowsPill.classList.remove('hidden');
      // וי ירוק
      resultIcon.innerHTML    = `<path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
      resultIcon.classList.remove('text-amber-400','text-rose-400');
      resultIcon.classList.add('text-emerald-400');

      resultLine.classList.remove('hidden');
    }

    function updateErrorUI(message) {
      statusTitle.textContent = 'שגיאה בקליטת הקובץ';
      statusSub.textContent   = message || 'בדקי שהקובץ הוא ‎.xlsx תקין';
      chipRows.classList.add('hidden');

      resultTitle.textContent = 'לא נקלט';
      resultSub.textContent   = message || 'הקובץ לא זוהה כ־XLSX או שאין בו נתונים';
      // איקס אדום
      resultIcon.innerHTML    = `<path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
      resultIcon.classList.remove('text-emerald-400','text-amber-400');
      resultIcon.classList.add('text-rose-400');

      rowsPill.classList.add('hidden');
      resultLine.classList.remove('hidden');
    }

    // ===== Core XLSX parse =====
    async function handleFile(file) {
      if (!file) return;
      setLoadingState(true);

      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        const first = wb.SheetNames?.[0];
        if (!first) {
          updateErrorUI('לא נמצאו גיליונות בקובץ.');
          setLoadingState(false);
          return;
        }

        // ל־JSON (Header-row auto)
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

        const rows = json.length;
        if (rows === 0) {
          updateErrorUI('הקובץ ריק או שמות העמודות לא זוהו.');
        } else {
          updateSuccessUI(file.name, rows);
        }
      } catch (err) {
        console.error(err);
        updateErrorUI('שגיאה בקריאת הקובץ. נסי לשמור מחדש כ־XLSX ולנסות שוב.');
      } finally {
        setLoadingState(false);
      }
    }

    // ===== Inputs & DragDrop =====
    const fileInput = $('fileInput');
    const dropzone  = $('dropzone');

    fileInput.addEventListener('change', (e) => handleFile(e.target.files?.[0]));

    // הפיכת ה־div ללחיץ לבחירת קובץ
    dropzone.addEventListener('click', () => fileInput.click());

    ;['dragenter','dragover'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      })
    );
    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });
  </script>
</body>
</html>    </div>
    <div class="card kpi">
      <h3>פניות – יום אחרון <span class="muted">(לפי תאריך פתיחה)</span></h3>
      <div class="v" id="lastCount">–</div>
      <div class="muted" id="lastDateLbl">–</div>
    </div>
    <div class="card kpi">
      <h3>פניות – היום הקודם <span class="muted">(לפי תאריך פתיחה)</span></h3>
      <div class="v" id="prevCount">–</div>
      <div class="muted" id="prevDateLbl">–</div>
    </div>
    <div class="card kpi">
      <h3>שינוי יומי</h3>
      <div class="v" id="deltaCount">–</div>
      <div class="muted" id="deltaPct">–</div>
    </div>
  </div>

  <!-- דיאגנוסטיקה -->
  <div id="diag" class="card" style="display:none">
    <div class="muted">דיאגנוסטיקה שדות תאריך:</div>
    <div id="diagBody" class="mono fade" style="margin-top:6px"></div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const tz = 'Asia/Jerusalem';
const fmt = new Intl.DateTimeFormat('he-IL',{timeZone:tz, day:'2-digit', month:'2-digit', year:'numeric'});

// --------- עזרי תאריכים ----------
function dateOnly(d){                 // יוצר תאריך "נקי" ללא שעה (ב־UTC כדי למנוע קפיצות TZ)
  return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
}
function keyFromDate(d){              // מפתח YYYY-MM-DD
  return d.toISOString().slice(0,10);
}
function labelFromKey(k){             // תצוגה יפה ל־he-IL
  const [y,m,d] = k.split('-').map(Number);
  return fmt.format(new Date(Date.UTC(y, m-1, d)));
}

// Excel serial בטוח (מעדיף SSF, נופל לפורמולה אם צריך)
function dateFromExcelSerial(n){
  try{
    const o = XLSX.SSF.parse_date_code(n);
    if(o && o.y && o.m && o.d) return dateOnly(new Date(o.y, o.m-1, o.d));
  }catch(_){}
  // נפילה לשיטה הארוכה
  const ms = (n - 25569) * 86400 * 1000;   // 25569 = 1899-12-30
  return dateOnly(new Date(ms));
}

// פרסור כללי לשדה “תאריך/שעת פתיחה”
function parseOpenDate(v){
  if(v == null || v === '') return null;

  // 1) מספר => Excel serial
  if(typeof v === 'number') return dateFromExcelSerial(v);

  // 2) טקסט: "dd/mm/yyyy hh:mm" או "dd/mm/yyyy"
  if(typeof v === 'string'){
    const s = v.trim().replace(/[.,]/g,'/');      // מקרים של "19.09.2025 10:47"
    // dd/mm/yyyy(...*) → הולך רק על התאריך ומתעלם משעה
    const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
    if(m){
      const d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3].length===2 ? ('20'+m[3]) : m[3],10);
      return dateOnly(new Date(y, mo-1, d));
    }
    // yyyy-mm-dd...
    const m2 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
    if(m2){
      const y = +m2[1], mo = +m2[2], d = +m2[3];
      return dateOnly(new Date(y, mo-1, d));
    }
    // ניסיון אחרון: Date רגיל
    const t = new Date(s);
    if(!Number.isNaN(t.getTime())) return dateOnly(t);
  }

  return null;
}

// --------- מצב UI ----------
const el = {
  file: document.getElementById('file'),
  clear: document.getElementById('clear'),
  fileInfo: document.getElementById('fileInfo'),
  ingestMsg: document.getElementById('ingestMsg'),
  kpis: document.getElementById('kpis'),
  totalRows: document.getElementById('totalRows'),
  lastCount: document.getElementById('lastCount'),
  prevCount: document.getElementById('prevCount'),
  deltaCount: document.getElementById('deltaCount'),
  lastDateLbl: document.getElementById('lastDateLbl'),
  prevDateLbl: document.getElementById('prevDateLbl'),
  deltaPct: document.getElementById('deltaPct'),
  diag: document.getElementById('diag'),
  diagBody: document.getElementById('diagBody'),
};

let rows = [];             // כל השורות כ־Objects
let dateKey = null;        // שם העמודה שנבחרה
const wantedDateNames = [
  'תאריך/שעת פתיחה','תאריך פתיחה','פתיחה','תאריך פתיחה פניה',
  'Open Date','Opened','Create Date','Created'
];

// איתור עמודת תאריך פתיחה
function pickDateColumn(headers){
  // איתור לפי שמות נפוצים בעברית/אנגלית
  for(const name of wantedDateNames){
    const idx = headers.findIndex(h => (h||'').toString().trim() === name);
    if(idx !== -1) return headers[idx];
  }
  // חיפוש לפי מפתח שמכיל "פתיחה" או "open"
  const h2 = headers.find(h => /פתיחה|open/i.test((h||'')+''));
  return h2 || headers[0]; // נפילה: הראשון
}

// קריאת קובץ
el.file.addEventListener('change', async (e)=>{
  resetUI(true);
  const file = e.target.files?.[0];
  if(!file){el.fileInfo.textContent='לא נבחר קובץ';return;}
  el.fileInfo.textContent = file.name;

  try{
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf, {type:'array', cellDates:false, cellNF:true, cellText:false});
    const ws  = wb.Sheets[wb.SheetNames[0]];
    const arr = XLSX.utils.sheet_to_json(ws, {defval:null, raw:true});

    if(!arr.length) return fail('הקובץ ריק');

    // כותרות
    const headers = Object.keys(arr[0]||{});
    dateKey = pickDateColumn(headers);

    // בניית מערך שורות + סטטיסטיקה
    let serial=0, textOk=0, blanks=0;
    rows = arr.map(r=>{
      const v = r[dateKey];
      const d = parseOpenDate(v);
      if(v==null || v==='') blanks++;
      else if(typeof v === 'number') serial++;
      else textOk++;
      return {...r, __openDate__: d, __openKey__: d ? keyFromDate(d) : null};
    });

    // הצגת דיאגנוסטיקה
    el.diag.style.display = 'block';
    el.diagBody.textContent =
      `עמודת תאריך שנבחרה: ${dateKey}\n`+
      `זוהו תאריכים כטקסט: ${textOk.toLocaleString('he-IL')}\n`+
      `זוהו serial של Excel: ${serial.toLocaleString('he-IL')}\n`+
      `לא קריאים/ריקים: ${blanks.toLocaleString('he-IL')}`;

    // KPI לפי התאריכים שנמצאים בקובץ (לא היום!)
    buildKPIs();

    ok(`הקובץ נטען בהצלחה • שורות ${rows.length.toLocaleString('he-IL')}`);
  }catch(err){
    console.error(err);
    fail('שגיאה בקריאת הקובץ. ודאי שזה ‎.xlsx‎ רגיל, בגליון הראשון יש כותרות, ואין נוסחאות תאריך לא סטנדרטיות.');
  }
});

el.clear.addEventListener('click', ()=>{
  el.file.value = '';
  resetUI();
});

function resetUI(keepFile=false){
  if(!keepFile){ el.fileInfo.textContent = 'לא נבחר קובץ'; }
  el.ingestMsg.innerHTML = '';
  el.kpis.style.display = 'none';
  el.diag.style.display = 'none';
  rows = [];
  dateKey = null;
}

function ok(msg){
  el.ingestMsg.innerHTML = `<span class="ok">✓</span> <span>${msg}</span>`;
}
function fail(msg){
  el.ingestMsg.innerHTML = `<span class="err">⚠</span> <span>${msg}</span>`;
}

// בניית KPI על בסיס היום האחרון/הקודם שקיימים בנתונים (לא לפי היום במכשיר)
function buildKPIs(){
  const valid = rows.filter(r => !!r.__openKey__);
  el.totalRows.textContent = rows.length.toLocaleString('he-IL');

  if(!valid.length){
    el.kpis.style.display='grid';
    el.lastCount.textContent = el.prevCount.textContent = el.deltaCount.textContent = '0';
    el.lastDateLbl.textContent = el.prevDateLbl.textContent = 'אין תאריכים קריאים';
    el.deltaPct.textContent = '—';
    return;
  }

  // צבירה לפי תאריך
  const byDate = new Map();
  for(const r of valid){
    byDate.set(r.__openKey__, (byDate.get(r.__openKey__)||0)+1);
  }
  const keys = [...byDate.keys()].sort(); // עולה
  const lastKey = keys[keys.length-1];            // המאוחר ביותר בקובץ
  // היום הקודם שקיים בקובץ (לא בהכרח last-1, אלא התאריך הקודם שקיים)
  const prevKey = keys.length>=2 ? keys[keys.length-2] : null;

  const lastCnt = byDate.get(lastKey) || 0;
  const prevCnt = prevKey ? (byDate.get(prevKey)||0) : 0;
  const delta   = lastCnt - prevCnt;
  const pct     = prevCnt ? (delta/prevCnt*100) : 0;

  el.lastCount.textContent = lastCnt.toLocaleString('he-IL');
  el.prevCount.textContent = prevCnt.toLocaleString('he-IL');
  el.deltaCount.textContent = (delta>0?'+':'') + delta.toLocaleString('he-IL');
  el.deltaPct.textContent = prevKey ? (pct.toFixed(1)+'%') : '—';

  el.lastDateLbl.textContent = 'נכון ל־ ' + labelFromKey(lastKey);
  el.prevDateLbl.textContent = prevKey ? ('נכון ל־ ' + labelFromKey(prevKey)) : 'אין תאריך קודם בקובץ';
  el.kpis.style.display='grid';
}
</script>
</body>
</html>
