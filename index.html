<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>דשבורד BI — פתוחות</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html{scroll-behavior:smooth}
    .num{font-variant-numeric:tabular-nums}
    .glass{backdrop-filter: blur(10px); background:rgba(255,255,255,.72)}
    .card{transition:.2s; border-radius:1.2rem}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 30px rgba(2,6,23,.15)}
    .grid-auto{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem}
    @media (prefers-color-scheme: dark){
      body{background:#0b0c10;color:#f3f4f6}
      .glass{background:rgba(17,24,39,.6);border-color:#374151}
    }
    .clickable{cursor:pointer}
    table th, table td{white-space:nowrap}
  </style>
</head>
<body class="bg-gradient-to-b from-[#eef2ff] via-white to-[#f8fafc] min-h-screen">

<header class="sticky top-0 z-30 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-white/50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="text-xl font-extrabold">דשבורד BI • פניות פתוחות</h1>
    <label class="px-4 py-2 rounded-xl bg-indigo-600 text-white shadow cursor-pointer hover:bg-indigo-700">
      <input id="fileInput" type="file"
             accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,*/*"
             class="hidden">
      העלאת Excel
    </label>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6">

  <section class="glass p-4 border rounded-2xl card">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
      <div class="lg:col-span-3">
        <label class="block text-xs mb-1">עמודת תאריך סנאפשוט</label>
        <input id="dateCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="תאריך/שעת שונה לאחרונה"/>
      </div>
      <div class="lg:col-span-3">
        <label class="block text-xs mb-1">עמודת סטטוס</label>
        <input id="statusCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="סטטוס פניה"/>
      </div>
      <div class="lg:col-span-3">
        <label class="block text-xs mb-1">עמודת מחלקה</label>
        <input id="deptCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="מחלקה מטפלת"/>
      </div>
      <div class="lg:col-span-3 flex gap-2">
        <button id="btnRecalc" class="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white shadow">חשב</button>
        <button id="btnReset"  class="px-4 py-2 rounded-xl bg-white border shadow">איפוס</button>
      </div>
    </div>

    <details class="mt-3">
      <summary class="text-sm text-slate-600 cursor-pointer">הגדרות מתקדמות</summary>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-3">
        <div><label class="block text-xs mb-1">תאריך/שעת פתיחה (SLA)</label><input id="openDateTimeCol" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="תאריך/שעת פתיחה"/></div>
        <div class="md:col-span-2">
          <label class="block text-xs mb-1">סטטוסים פתוחים (פסיק בין ערכים)</label>
          <input id="openStatuses" class="cfg w-full text-sm border rounded-lg px-3 py-2" value="חדש, בתהליך, המתנה לגורם פנימי, המתנה למסמכים מהלקוח"/>
        </div>
      </div>
    </details>
    <p id="msg" class="text-sm text-slate-600 mt-2">העלי קובץ Excel, ואז לחצי "חשב".</p>
  </section>

  <section id="kpis" class="grid-auto mt-6 hidden">
    <div class="card p-4 border glass">
      <span class="text-slate-500 text-sm">סה״כ פתוחות היום</span>
      <div class="text-3xl font-extrabold mt-2 num" id="openCurrent">—</div>
    </div>
    <div class="card p-4 border glass">
      <span class="text-slate-500 text-sm">פתוחות ביום הקודם</span>
      <div class="text-3xl font-extrabold mt-2 num" id="openPrev">—</div>
    </div>
    <div class="card p-4 border glass">
      <span class="text-slate-500 text-sm">שינוי יומי</span>
      <div class="text-3xl font-extrabold mt-2 num" id="deltaAbs">—</div>
      <div class="text-xs text-slate-500">באחוזים: <span id="deltaPct">—</span></div>
    </div>
  </section>

  <section id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6 hidden">
    <div class="card p-4 border glass">
      <h3 class="font-semibold">מגמת פתוחות</h3>
      <canvas id="trendChart" height="140"></canvas>
    </div>
    <div class="card p-4 border glass">
      <h3 class="font-semibold">התפלגות SLA</h3>
      <canvas id="slaPieChart" height="140"></canvas>
    </div>
  </section>
</main>

<script>
const $=id=>document.getElementById(id);
let ALL=[],CTX=null,charts={};
function parseExcelDate(v){ if(!v) return null; if(v instanceof Date) return v; if(typeof v==='number'){return new Date((v-25569)*86400*1000);} const d=new Date(v); return isNaN(d)?null:d; }
function snap(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
function calc(){
  const cfg={dateCol:$('dateCol').value.trim(),statusCol:$('statusCol').value.trim(),deptCol:$('deptCol').value.trim(),openDateTimeCol:$('openDateTimeCol').value.trim()};
  cfg.openSet=new Set(($('openStatuses').value||'').split(',').map(s=>s.trim()));
  const base=ALL.map(r=>({...r,__d:parseExcelDate(r[cfg.dateCol])})).filter(r=>r.__d);
  const withSnap=base.map(r=>({...r,__snap:snap(r.__d)}));
  const dates=[...new Set(withSnap.map(r=>r.__snap.getTime()))].sort().map(t=>new Date(t));
  if(!dates.length){$('msg').textContent='אין תאריכים תקינים';return;}
  const current=dates.at(-1),prev=dates.length>1?dates.at(-2):null;
  const isOpen=s=>s&&cfg.openSet.has(String(s).trim());
  const curr=withSnap.filter(r=>r.__snap.getTime()===current.getTime()&&isOpen(r[cfg.statusCol]));
  const prevRows=prev?withSnap.filter(r=>r.__snap.getTime()===prev.getTime()&&isOpen(r[cfg.statusCol])):[];
  const delta=curr.length-prevRows.length,pct=prevRows.length?((delta)/prevRows.length*100):null;
  CTX={dates:{current,prev},curr,prev:prevRows,totals:{curr:curr.length,prev:prevRows.length,delta,pct}};
  render();
}
function render(){
  $('kpis').classList.remove('hidden');$('charts').classList.remove('hidden');
  $('openCurrent').textContent=CTX.totals.curr;
  $('openPrev').textContent=CTX.totals.prev;
  $('deltaAbs').textContent=(CTX.totals.delta>0?'+':'')+CTX.totals.delta;
  $('deltaPct').textContent=CTX.totals.pct!=null?CTX.totals.pct.toFixed(1)+'%':'';
}
$('fileInput').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f)return;
  const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'});
  ALL=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''}); calc();
});
$('btnRecalc').onclick=calc;
$('btnReset').onclick=()=>{ALL=[];CTX=null;document.querySelectorAll('#kpis,#charts').forEach(s=>s.classList.add('hidden'));$('msg').textContent='נא להעלות קובץ חדש.';}
</script>
</body>
</html>
